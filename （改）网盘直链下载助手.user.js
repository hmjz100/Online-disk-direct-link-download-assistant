// ==UserScript==
// @name              LinkSwift
// @namespace         github.com/hmjz100
// @version           1.0.9.7
// @author            Hmjz100ã€æ²¹å°çŒ´
// @icon              data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMjggMTI4Ij48cGF0aCBkPSJNMTAzLjYgMTA3LjRjMy41LTIuMiA4LjktNi4xIDEzLjgtMTIuNXM3LjMtMTIuNSA4LjUtMTYuNWMuNS0xLjcgMi4yLTcuNSAyLjItMTQuNyAwLTEwLjEtMy4zLTI1LjEtMTUuNC0zNi44LTE0LjUtMTQtMzIuMS0xNC4zLTM1LjctMTQuMy04IDAtMTUuNyAxLjktMjIuNiA1LjJDNDQgMjMgMzUuNyAzMS40IDMwLjggNDEuN2MtMS4zIDIuOC00IDQuNy03LjEgNS00IC4zLTcuNSA0LjQtOC45IDkuNi0uNSAxLjktMS42IDMuNS0zLjEgNC43QzQuNCA2Ni44IDAgNzUuNyAwIDg1YzAgNi44IDIuMyAxMy4xIDYuMSAxOC4yIDUuNSA3LjQgMTQuMiAxMi4yIDI0IDEyLjJoNDcuMWM0LjQgMCAxMS0uNSAxOC4zLTMuNSAzLjItMS40IDUuOS0zIDguMS00LjV6IiBmaWxsPSIjQTA5OUYwIi8+PHBhdGggZD0iTTExOS44IDY0LjNjLjEtMTcuMS0xMC40LTI4LTEyLjUtMzAuMUM5NSAyMi4xIDc5LjkgMjEuOCA3Ni45IDIxLjhjLTE3LjYgMC0zMy4zIDEwLjUtMzkuOSAyNi43LS42IDEuMy0xLjggMi4zLTMuNCAyLjNoLS40Yy01LjggMC0xMC42IDQuOC0xMC42IDEwLjd2LjVjMCAxLjQtLjggMi42LTEuOSAzLjNDMTMuNCA2OSA4LjggNzYuOCA4LjggODVjMCAxMi4yIDkuOSAyMi4zIDIyLjIgMjIuM2g0NS4yYzMuNi0uMSAxNy42LS45IDI5LjYtMTIgMi45LTIuOCAxMy45LTEzLjcgMTQtMzF6IiBmaWxsPSIjNTc0QUI4Ii8+PHBhdGggZD0iTTExMC44IDU3LjRsLjIgMy4zYzAgMS4zLTEuMSAyLjQtMi4zIDIuNC0xLjMgMC0yLjMtMS4xLTIuMy0yLjRsLS4xLTIuOHYtLjNjMC0xLjIuOS0yLjIgMi4xLTIuM2guM2MuNyAwIDEuMy4zIDEuNy43LS4yLjEuMy41LjQgMS40em0tMy4zLTEwLjNjMCAxLjItMSAyLjMtMi4yIDIuM2gtLjFjLS44IDAtMS42LS41LTItMS4yLTQuNi04LjMtMTMuMy0xMy41LTIyLjgtMTMuNS0xLjIgMC0yLjMtMS0yLjMtMi4ydi0uMWMwLTEuMiAxLTIuMyAyLjItMi4zaC4xYTMwLjM3IDMwLjM3IDAgMCAxIDE1LjggNC40YzQuNiAyLjggOC40IDYuOCAxMS4xIDExLjUuMS4zLjIuNy4yIDEuMXpNODguMyA3My44TDczLjUgOTMuMmMtMS41IDEuOS0zLjUgMy4xLTUuNyAzLjVoLS4yYy0uNC4xLS44LjEtMS4yLjEtLjYgMC0xLjEtLjEtMS42LS4yLTIuMi0uNC00LjItMS43LTUuNi0zLjVMNDQuMyA3My45Yy0yLTIuNi0yLjUtNS40LTEuNC03LjcuMS0uMS4xLS4yLjItLjIgMS4yLTIgMy41LTMuMiA2LjQtMy4yaDYuNnYtNS43YzAtNi44IDQuNy0xMiAxMC45LTEyIDQuOCAwIDguNSAyLjYgMTAuMyA3LjIuNSAxLjMtLjIgMi43LTEuNSAzLjJzLTIuOC0uMS0zLjMtMS40Yy0xLjEtMi43LTIuOS00LTUuNS00LTMuNSAwLTYgMy02IDd2OC4xYzAgLjUtLjIgMS0uNiAxLjQtLjYuNy0xLjcgMS4xLTIuNiAxLjFoLTguNGMtMS4zIDAtMiAuNC0yLjEuNy0uMi40IDAgMS4zLjkgMi40TDYzLjEgOTBjLjkgMS4yIDIuMSAxLjggMy4zIDEuOHMyLjMtLjYgMy4xLTEuN2wxNC44LTE5LjNjLjktMS4xIDEuMS0yIC45LTIuNC0uMi0uMy0uOS0uNy0yLjEtLjdoLTcuNmMtLjkgMC0xLjctLjUtMi4xLTEuMi0uMy0uNC0uNC0uOC0uNC0xLjMgMC0xLjQgMS4xLTIuNSAyLjUtMi41aDcuNmMzLjEgMCA1LjUgMS4zIDYuNiAzLjVsLjMuN2MuNyAyLjEuMSA0LjYtMS43IDYuOXoiIGZpbGw9IiNmZmYiLz48L3N2Zz4=
// @description       ä¸€ä¸ªåŸºäº JavaScript çš„ç½‘ç›˜æ–‡ä»¶ä¸‹è½½åœ°å€è·å–å·¥å…·ï¼Œæ”¯æŒ ç™¾åº¦ç½‘ç›˜/é˜¿é‡Œäº‘ç›˜/å¤©ç¿¼äº‘ç›˜/è¿…é›·äº‘ç›˜/å¤¸å…‹ç½‘ç›˜/ç§»åŠ¨ç½‘ç›˜ å…­å¤§ç½‘ç›˜ | åŸºäºã€ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘ä¿®æ”¹è‡ª6.2.7ç‰ˆæœ¬ | å¼€æº - è‡ªç”¨ - å»å¹¿ | æ”¹ç•Œé¢ - æ·»åŠŸèƒ½ - ä¿®Bug | ä¸ä»…èƒ½å¤Ÿç²¾ç®€ç½‘ç›˜ç•Œé¢ è¿˜æ”¯æŒä¿®æ”¹ç½‘ç›˜ç•Œé¢ä¸»é¢˜é¢œè‰²!
// @license           AGPL-3.0-or-later
// @homepage          https://github.com/hmjz100/LinkSwift/
// @support           https://github.com/hmjz100/LinkSwift/issues
// @supportURL        https://github.com/hmjz100/LinkSwift/issues
// @require           https://unpkg.com/jquery@3.6.0/dist/jquery.min.js
// @require           https://unpkg.com/sweetalert2@11.4.8/dist/sweetalert2.min.js
// @require           https://unpkg.com/js-md5@0.7.3/build/md5.min.js
// @resource Swal     https://unpkg.com/sweetalert2@11/dist/sweetalert2.min.css
// @resource SwalDark https://unpkg.com/@sweetalert2/theme-dark@5/dark.min.css
// @run-at            document-body
// @match             *://pan.baidu.com/disk/home*
// @match             *://yun.baidu.com/disk/home*
// @match             *://pan.baidu.com/disk/timeline*
// @match             *://yun.baidu.com/disk/timeline*
// @match             *://pan.baidu.com/disk/main*
// @match             *://yun.baidu.com/disk/main*
// @match             *://pan.baidu.com/youth/pan/main*
// @match             *://yun.baidu.com/youth/pan/main*
// @match             *://pan.baidu.com/disk/base*
// @match             *://yun.baidu.com/disk/base*
// @match             *://pan.baidu.com/disk/timeline*
// @match             *://yun.baidu.com/disk/timeline*
// @match             *://pan.baidu.com/pfile/*
// @match             *://yun.baidu.com/pfile/*
// @match             *://pan.baidu.com/s/*
// @match             *://pan.baidu.com/aipan/*
// @match             *://yun.baidu.com/s/*
// @match             *://yun.baidu.com/aipan/*
// @match             *://pan.baidu.com/share/*
// @match             *://yun.baidu.com/share/*
// @match             *://openapi.baidu.com/*
// @match             *://www.aliyundrive.com/s/*
// @match             *://www.aliyundrive.com/drive*
// @match             *://www.alipan.com/s/*
// @match             *://www.alipan.com/drive*
// @match             *://cloud.189.cn/web/*
// @match             *://pan.xunlei.com/*
// @match             *://pan.quark.cn/*
// @match             *://yun.139.com/*
// @match             *://caiyun.139.com/*
// @match             *://*.youxiaohou.com/*
// @connect           baidu.com
// @connect           baidupcs.com
// @connect           aliyundrive.com
// @connect           aliyundrive.net
// @connect           alipan.com
// @connect           alicloudccp.com
// @connect           aliyundrive.cloud
// @connect           189.cn
// @connect           xunlei.com
// @connect           quark.cn
// @connect           localhost
// @connect           *
// @grant             unsafeWindow
// @grant             window.close
// @grant             GM_xmlhttpRequest
// @grant             GM.xmlhttpRequest
// @grant             GM_setClipboard
// @grant             GM_setValue
// @grant             GM_getValue
// @grant             GM_deleteValue
// @grant             GM_openInTab
// @grant             GM_info
// @grant             GM_registerMenuCommand
// @grant             GM_cookie
// @grant             GM_getResourceText
// @compatible	      Chrome
// @compatible	      Edge
// @compatible	      Firefox
// @compatible	      Safari
// @compatible	      Opera
// ==/UserScript==

(function Panlinker() {
	'use strict';

	/*
	é˜²æ­¢ä»£ç å› å…¶ä»–åŸå› è¢«æ‰§è¡Œå¤šæ¬¡
	è¿™æ®µä»£ç å‡ºè‡ª Viaè½»æ’ä»¶ï¼Œä½œè€…è°·èŠ±æ³°
	*/
	const key = encodeURIComponent('ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹:ä¸»ä»£ç ');
	if (window[key]) return;
	window[key] = true;

	/*
	ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹
	ä»¥ä¸‹ä»£ç å‡æ”¹è‡ª ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ï¼Œä½œè€…æ²¹å°çŒ´
	*/
	/* å…¨å±€å‚æ•° */
	let page = '', selectList = [], shareParams = {}, mode = '', color = '',
		doc = $(document), progress = {}, request = {}, ins = {}, idm = {}, colored = false,
		scriptInfo = GM_info.script,
		realAuthor = scriptInfo.author,
		realName = scriptInfo.name,
		realVersion = scriptInfo.version,
		manageHandler = GM_info.scriptHandler,
		manageVersion = GM_info.version;


	/* è®¾ç½®é€‰é¡¹ */
	// Shellç±»å‹ï¼ˆç”¨äºcurlä¸‹è½½ï¼‰
	let terminalType = {
		wc: "Microsoft Windows å‘½ä»¤æç¤ºç¬¦",
		wp: "Microsoft Windows PowerShell",
		lt: "Linux ç»ˆç«¯",
		ls: "Linux Shell",
		mt: "Apple MacOS ç»ˆç«¯",
	};

	// æ›´æ¢ ç™¾åº¦ç½‘ç›˜æ–°ç•Œé¢/é˜¿é‡Œäº‘ç›˜/è¿…é›·äº‘ç›˜/ç§»åŠ¨äº‘ç›˜ ä¸»é¢˜é¢œè‰²
	let assistantTheme = {
		yes: "æ›´æ¢ä¸»é¢˜é¢œè‰²",
		no: "ä¸æ›´æ¢ä¸»é¢˜é¢œè‰²"
	};

	/* Sweet Alert 2 */
	// è‡ªå®šä¹‰å…ƒç´  Class åï¼ˆäº showMainDialog() ä¸­ï¼‰
	let customClass = {
		popup: 'pl-popup',
		header: 'pl-header',
		title: 'pl-title',
		closeButton: 'pl-close',
		content: 'pl-content',
		input: 'pl-input',
		footer: 'pl-footer'
	};

	// å¼¹çª—é»˜è®¤è®¾ç½®
	let swalDefault = {
		heightAuto: false,
		scrollbarPadding: false,
	}

	// Toast æç¤ºé…ç½®
	let toast = Swal.mixin({
		toast: true,
		position: 'bottom-end',
		showConfirmButton: false,
		timer: 3500,
		timerProgressBar: true,
		showCloseButton: true,
		didOpen: function (toast) {
			toast.addEventListener('mouseenter', Swal.stopTimer);
			toast.addEventListener('mouseleave', Swal.resumeTimer);
		}
	});

	// Toast ç®€æ˜“è°ƒç”¨
	let message = {
		success: function (text) {
			toast.fire({ title: text, icon: 'success' });
		},
		error: function (text) {
			toast.fire({ title: text, icon: 'error' });
		},
		warning: function (text) {
			toast.fire({ title: text, icon: 'warning' });
		},
		info: function (text) {
			toast.fire({ title: text, icon: 'info' });
		},
		question: function (text) {
			toast.fire({ title: text, icon: 'question' });
		}
	};

	/* å†…ç½®é…ç½® */
	const config = {
		"base": {
			"num": "865746",
			"license": "AGPL3",
			"service": {
				"account": "https://pic.rmb.bdstatic.com/bjh/8b9e14345b3cdf96aedac2f3971adcb02681.png",
				"rpc": "https://d.youxiaohou.com"
			},
			"dom": {
				"footer": "<div style=\"text-align: center; width: 100%;\">æ„Ÿè°¢æ‚¨ä½¿ç”¨æœ¬è„šæœ¬ï¼Œç»™æˆ‘ä»¬ä¸€ä¸ª<a href=\"https://github.com/hmjz100/Online-disk-direct-link-download-assistant\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Star</a>å§~</div>",
				"button": {
					"api": {
						"title": "APIä¸‹è½½<span style=\"font-size:14px;font-weight: 400;opacity: .8;\">ï¼ˆé€‚ç”¨äº <a href=\"https://www.youxiaohou.com/zh-cn/idm.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">IDM</a>ï¼Œ<a href=\"https://www.youxiaohou.com/zh-cn/ndm.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">NDM</a> ä»¥åŠæµè§ˆå™¨è‡ªå¸¦ä¸‹è½½ï¼‰</span>",
						"footer": "ç‚¹å‡»é“¾æ¥ç›´æ¥ä¸‹è½½ï¼Œä¾‹å¦‚ï¼š<a href=\"https://www.youxiaohou.com/zh-cn/idm.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">IDM</a>ï¼Œè‹¥æœªå”¤èµ·IDMï¼Œè¯· <a href=\"https://www.youxiaohou.com/zh-cn/idm.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">ç‚¹å‡»è¿™é‡Œ</a> é…ç½®æ–‡ä»¶ç±»å‹ï¼Œå»ºè®®é…åˆè¶…çº§ä¼šå‘˜ä½¿ç”¨ã€‚"
					},
					"aria": {
						"title": "Ariaä¸‹è½½<span style=\"font-size:14px;font-weight: 400;opacity: .8;\">ï¼ˆé€‚ç”¨äº <a href=\"https://www.youxiaohou.com/zh-cn/xdown.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">XDown</a> åŠ <a href=\"https://www.youxiaohou.com/zh-cn/linux.html#linux-shell\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Linux Shellå‘½ä»¤è¡Œ</a>ï¼‰</span>",
						"footer": "ç‚¹å‡»é“¾æ¥å¤åˆ¶åœ°å€åˆ°å‰ªåˆ‡æ¿ï¼Œç²˜è´´åˆ°æ”¯æŒ aria2c åè®®çš„ä¸‹è½½å™¨ä¸­ï¼Œä¾‹å¦‚ï¼š<a href=\"https://www.youxiaohou.com/zh-cn/xdown.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">XDown</a>ï¼Œ<a href=\"https://www.youxiaohou.com/zh-cn/linux.html#linux-shell\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Linux Shell</a>ï¼Œå»ºè®®é…åˆè¶…çº§ä¼šå‘˜ä½¿ç”¨ã€‚"
					},
					"rpc": {
						"title": "RPCä¸‹è½½<span style=\"font-size:14px;font-weight: 400;opacity: .8;\">ï¼ˆé€‚ç”¨äº <a href=\"https://www.youxiaohou.com/zh-cn/motrix.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Motrix</a>ï¼Œ<a href=\"https://www.youxiaohou.com/download.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Aria2 Tools</a>ï¼Œ<a href=\"https://www.youxiaohou.com/download.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">AriaNgGUI</a>ï¼‰</span>",
						"footer": "ç‚¹å‡»æŒ‰é’®å‘é€é“¾æ¥è‡³æœ¬åœ°æˆ–è¿œç¨‹ RPC æœåŠ¡ï¼Œä¾‹å¦‚ï¼š<a href=\"https://www.youxiaohou.com/zh-cn/motrix.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Motrix</a>ï¼ŒRPC å‚æ•°å«ä¹‰è§<a href=\"https://www.youxiaohou.com/zh-cn/motrix.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">æ­¤å¤„</a>ï¼Œå»ºè®®é…åˆè¶…çº§ä¼šå‘˜ä½¿ç”¨ã€‚"
					},
					"curl": {
						"title": "cURLä¸‹è½½<span style=\"font-size:14px;font-weight: 400;opacity: .8;\">ï¼ˆé€‚ç”¨äº <a href=\"https://www.youxiaohou.com/zh-cn/curl.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Windowsï¼ŒLinuxï¼ŒMacOS ç»ˆç«¯</a>ï¼‰</span>",
						"footer": "ç‚¹å‡»é“¾æ¥å¤åˆ¶åœ°å€åˆ°å‰ªåˆ‡æ¿ï¼Œç²˜è´´åˆ° <a href=\"https://www.youxiaohou.com/zh-cn/curl.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">Windowsï¼ŒLinuxï¼ŒMacOS ç»ˆç«¯</a>ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ ï¼Œå»ºè®®é…åˆè¶…çº§ä¼šå‘˜ä½¿ç”¨ã€‚"
					},
					"bc": {
						"title": "BCä¸‹è½½<span style=\"font-size:14px;font-weight: 400;opacity: .8;\">ï¼ˆé€‚ç”¨äº <a href=\"https://www.youxiaohou.com/zh-cn/bitcomet.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">æ¯”ç‰¹å½—æ˜Ÿ</a>ï¼‰</span>",
						"footer": "ç‚¹å‡»é“¾æ¥å¤åˆ¶åœ°å€åˆ°å‰ªåˆ‡æ¿ï¼Œç²˜è´´åˆ° <a href=\"https://www.youxiaohou.com/zh-cn/bitcomet.html\" target=\"_blank\" class=\"pl-a\" data-no-instant=\"1\">æ¯”ç‰¹å½—æ˜Ÿ</a> ä¸‹è½½å™¨ä¸­ï¼Œå»ºè®®é…åˆè¶…çº§ä¼šå‘˜ä½¿ç”¨ã€‚"
					}
				}
			},
			"assistant": {
				"message": "è¯·å…ˆå®‰è£…ç½‘ç›˜ä¸‡èƒ½åŠ©æ‰‹å“¦ï¼Œå®‰è£…åå†åˆ·æ–°æœ¬é¡µå°±å¥½å•¦",
				"link": "https://www.crxsoso.com/addon/detail/mphijdmblaalbakceeadippfkbgfgaaa"
			}
		},
		"baidu": {
			"api": {
				"ua": {
					"downloadLink": "pan.baidu.com"
				},
				"getAccessToken": "https://openapi.baidu.com/oauth/2.0/authorize?response_type=token&scope=basic,netdisk&client_id=IlLqBbU3GjQ0t46TRwFateTprHWl39zF&redirect_uri=oob&confirm_login=0",
				"getLink": "https://pan.baidu.com/rest/2.0/xpan/multimedia?method=filemetas&dlink=1",
				"getFiles": "https://pan.baidu.com/rest/2.0/xpan/file?method=list&showempty=1",
				"getShareLink": "https://pan.baidu.com/api/sharedownload?channel=chunlei&clienttype=12&web=1&app_id=250528"
			},
			"mount": {
				"home": ".tcuLAu",
				"main": ".wp-s-agile-tool-bar__header",
				"share": ".module-share-top-bar .x-button-box"
			}
		},
		"ali": {
			"api": {
				"getLink": "https://api.aliyundrive.com/v2/file/get_download_url",
				"getShareLink": "https://api.aliyundrive.com/v2/file/get_share_link_download_url"
			},
			"mount": {
				"home": ".actions--M9Np-",
				"share": ".right--x0Z1g",
				"list": "[class^=\"node-list-table-view--\"]",
				"grid": "[class^=\"node-list-grid-view--\"]",
				"switch": "[class^=\"switch-wrapper--\"]"
			}
		},
		"tcloud": {
			"api": {
				"getAccessToken": "https://api.cloud.189.cn/open/oauth2/ssoH5.action",
				"getLink": "https://api.cloud.189.cn/open/file/getFileDownloadUrl.action"
			},
			"mount": {
				"home": "[class*=\"FileHead_file-head-left\"]",
				"share": ".nav-opea"
			}
		},
		"xunlei": {
			"api": {
				"mirror": [
					"vod0007-h05-vip-lixian.xunlei.com", "vod0008-h05-vip-lixian.xunlei.com", "vod0009-h05-vip-lixian.xunlei.com", "vod0010-h05-vip-lixian.xunlei.com", "vod0011-h05-vip-lixian.xunlei.com", "vod0012-h05-vip-lixian.xunlei.com", "vod0013-h05-vip-lixian.xunlei.com", "vod0014-h05-vip-lixian.xunlei.com", "vod0067-aliyun08-vip-lixian.xunlei.com", "vod0254-aliyun08-vip-lixian.xunlei.com", "vod0255-aliyun08-vip-lixian.xunlei.com", "vod0256-aliyun08-vip-lixian.xunlei.com", "vod0257-aliyun08-vip-lixian.xunlei.com", "vod0258-aliyun08-vip-lixian.xunlei.com", "vod0259-aliyun08-vip-lixian.xunlei.com", "vod0260-aliyun08-vip-lixian.xunlei.com", "vod0261-aliyun08-vip-lixian.xunlei.com", "vod0262-aliyun08-vip-lixian.xunlei.com", "vod0263-aliyun08-vip-lixian.xunlei.com", "vod0264-aliyun08-vip-lixian.xunlei.com", "vod0265-aliyun08-vip-lixian.xunlei.com", "vod0266-aliyun08-vip-lixian.xunlei.com", "vod0267-aliyun08-vip-lixian.xunlei.com", "vod0554-aliyun06-vip-lixian.xunlei.com", "vod0555-aliyun06-vip-lixian.xunlei.com", "vod0556-aliyun06-vip-lixian.xunlei.com", "vod0680-aliyun08-vip-lixian.xunlei.com", "vod0681-aliyun08-vip-lixian.xunlei.com", "vod0682-aliyun08-vip-lixian.xunlei.com", "vod0683-aliyun08-vip-lixian.xunlei.com", "vod0684-aliyun08-vip-lixian.xunlei.com", "vod0685-aliyun08-vip-lixian.xunlei.com", "vod0686-aliyun08-vip-lixian.xunlei.com", "vod0687-aliyun08-vip-lixian.xunlei.com", "vod0688-aliyun08-vip-lixian.xunlei.com", "vod0689-aliyun08-vip-lixian.xunlei.com", "vod0690-aliyun08-vip-lixian.xunlei.com", "vod0724-aliyun08-vip-lixian.xunlei.com", "vod0725-aliyun08-vip-lixian.xunlei.com", "vod0726-aliyun08-vip-lixian.xunlei.com", "vod0727-aliyun08-vip-lixian.xunlei.com", "vod0728-aliyun08-vip-lixian.xunlei.com", "vod0075.aliyun06.vip.lixian.xunlei.com", "vod0076.aliyun06.vip.lixian.xunlei.com", "vod0077.aliyun06.vip.lixian.xunlei.com", "vod0779-aliyun04-vip-lixian.xunlei.com", "vod0078.aliyun06.vip.lixian.xunlei.com", "vod0780-aliyun04-vip-lixian.xunlei.com", "vod0781-aliyun04-vip-lixian.xunlei.com", "vod0079.aliyun06.vip.lixian.xunlei.com", "vod0080.aliyun06.vip.lixian.xunlei.com", "vod0117.aliyun04.vip.lixian.xunlei.com", "vod0118.aliyun04.vip.lixian.xunlei.com", "vod0119.aliyun04.vip.lixian.xunlei.com", "vod1284-aliyun06-vip-lixian.xunlei.com", "vod1285-aliyun06-vip-lixian.xunlei.com", "vod1363-aliyun06-vip-lixian.xunlei.com", "vod1371-aliyun06-vip-lixian.xunlei.com", "vod1372-aliyun06-vip-lixian.xunlei.com", "vod1426-aliyun06-vip-lixian.xunlei.com", "vod1427-aliyun06-vip-lixian.xunlei.com", "vod1428-aliyun06-vip-lixian.xunlei.com", "vod1429-aliyun06-vip-lixian.xunlei.com", "vod1442-aliyun06-vip-lixian.xunlei.com", "vod1443-aliyun06-vip-lixian.xunlei.com", "vod1444-aliyun06-vip-lixian.xunlei.com", "vod1445-aliyun06-vip-lixian.xunlei.com", "vod1446-aliyun06-vip-lixian.xunlei.com", "vod1447-aliyun06-vip-lixian.xunlei.com", "vod1469-aliyun06-vip-lixian.xunlei.com", "vod1470-aliyun06-vip-lixian.xunlei.com", "vod1471-aliyun06-vip-lixian.xunlei.com", "vod1489-aliyun06-vip-lixian.xunlei.com", "vod1490-aliyun06-vip-lixian.xunlei.com", "vod1491-aliyun06-vip-lixian.xunlei.com", "vod1492-aliyun06-vip-lixian.xunlei.com", "vod1493-aliyun06-vip-lixian.xunlei.com", "vod0215.aliyun06.vip.lixian.xunlei.com", "vod0216.aliyun06.vip.lixian.xunlei.com", "vod0217.aliyun06.vip.lixian.xunlei.com", "vod0218.aliyun06.vip.lixian.xunlei.com", "vod0219.aliyun06.vip.lixian.xunlei.com", "vod0220.aliyun06.vip.lixian.xunlei.com", "vod0241.aliyun08.vip.lixian.xunlei.com", "vod0244.aliyun08.vip.lixian.xunlei.com", "vod0251.aliyun08.vip.lixian.xunlei.com", "vod0252.aliyun08.vip.lixian.xunlei.com", "vod0253.aliyun08.vip.lixian.xunlei.com", "vod0254.aliyun08.vip.lixian.xunlei.com", "vod0255.aliyun08.vip.lixian.xunlei.com", "vod0256.aliyun08.vip.lixian.xunlei.com", "vod0257.aliyun08.vip.lixian.xunlei.com", "vod0260.aliyun08.vip.lixian.xunlei.com", "vod0261.aliyun08.vip.lixian.xunlei.com", "vod0262.aliyun08.vip.lixian.xunlei.com", "vod0263.aliyun08.vip.lixian.xunlei.com", "vod0264.aliyun08.vip.lixian.xunlei.com", "vod0265.aliyun08.vip.lixian.xunlei.com", "vod0266.aliyun08.vip.lixian.xunlei.com", "vod0267.aliyun08.vip.lixian.xunlei.com", "vod3379-aliyun04-vip-lixian.xunlei.com", "vod3380-aliyun04-vip-lixian.xunlei.com", "vod3429-aliyun04-vip-lixian.xunlei.com", "vod3458-aliyun04-vip-lixian.xunlei.com", "vod3459-aliyun04-vip-lixian.xunlei.com", "vod3496-aliyun04-vip-lixian.xunlei.com", "vod3497-aliyun04-vip-lixian.xunlei.com", "vod3498-aliyun04-vip-lixian.xunlei.com", "vod3499-aliyun04-vip-lixian.xunlei.com", "vod3500-aliyun04-vip-lixian.xunlei.com", "vod3501-aliyun04-vip-lixian.xunlei.com", "vod3522-aliyun04-vip-lixian.xunlei.com", "vod3523-aliyun04-vip-lixian.xunlei.com", "vod3533-aliyun04-vip-lixian.xunlei.com", "vod3534-aliyun04-vip-lixian.xunlei.com", "vod3535-aliyun04-vip-lixian.xunlei.com", "vod3536-aliyun04-vip-lixian.xunlei.com", "vod3549-aliyun04-vip-lixian.xunlei.com", "vod3550-aliyun04-vip-lixian.xunlei.com", "vod3551-aliyun04-vip-lixian.xunlei.com", "vod3552-aliyun04-vip-lixian.xunlei.com", "vod3553-aliyun04-vip-lixian.xunlei.com", "vod3554-aliyun04-vip-lixian.xunlei.com", "vod3555-aliyun04-vip-lixian.xunlei.com", "vod0551.aliyun06.vip.lixian.xunlei.com", "vod0552.aliyun06.vip.lixian.xunlei.com", "vod0553.aliyun06.vip.lixian.xunlei.com", "vod0554.aliyun06.vip.lixian.xunlei.com", "vod0555.aliyun06.vip.lixian.xunlei.com", "vod0556.aliyun06.vip.lixian.xunlei.com", "vod0686.aliyun08.vip.lixian.xunlei.com", "vod0687.aliyun08.vip.lixian.xunlei.com", "vod0688.aliyun08.vip.lixian.xunlei.com", "vod0689.aliyun08.vip.lixian.xunlei.com", "vod0724.aliyun08.vip.lixian.xunlei.com", "vod0725.aliyun08.vip.lixian.xunlei.com", "vod0726.aliyun08.vip.lixian.xunlei.com", "vod0727.aliyun08.vip.lixian.xunlei.com", "vod0728.aliyun08.vip.lixian.xunlei.com", "vod0759.aliyun04.vip.lixian.xunlei.com", "vod0760.aliyun04.vip.lixian.xunlei.com", "vod0769.aliyun04.vip.lixian.xunlei.com", "vod0770.aliyun04.vip.lixian.xunlei.com", "vod0771.aliyun04.vip.lixian.xunlei.com", "vod0772.aliyun04.vip.lixian.xunlei.com", "vod0773.aliyun04.vip.lixian.xunlei.com", "vod0774.aliyun04.vip.lixian.xunlei.com", "vod0775.aliyun04.vip.lixian.xunlei.com", "vod0776.aliyun04.vip.lixian.xunlei.com", "vod0777.aliyun04.vip.lixian.xunlei.com", "vod0778.aliyun04.vip.lixian.xunlei.com", "vod0779.aliyun04.vip.lixian.xunlei.com", "vod0780.aliyun04.vip.lixian.xunlei.com", "vod0781.aliyun04.vip.lixian.xunlei.com", "vod3522.aliyun04.vip.lixian.xunlei.com", "vod3523.aliyun04.vip.lixian.xunlei.com", "vod3533.aliyun04.vip.lixian.xunlei.com", "vod3535.aliyun04.vip.lixian.xunlei.com", "vod3550.aliyun04.vip.lixian.xunlei.com", "vod3551.aliyun04.vip.lixian.xunlei.com", "vod3552.aliyun04.vip.lixian.xunlei.com", "vod3553.aliyun04.vip.lixian.xunlei.com", "vod3554.aliyun04.vip.lixian.xunlei.com", "vod3555.aliyun04.vip.lixian.xunlei.com"
				],
				"getLink": "https://api-pan.xunlei.com/drive/v1/files/"
			},
			"mount": {
				"home": ".FileMenu__menu--XBFEH",
				"share": ".Share__batchActionBox--VKPyR"
			}
		},
		"quark": {
			"api": {
				"ua": {
					"downloadLink": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) quark-cloud-drive/2.5.20 Chrome/100.0.4896.160 Electron/18.3.5.4-b478491100 Safari/537.36 Channel/pckk_other_ch"
				},
				"getLink": "https://drive.quark.cn/1/clouddrive/file/download?pr=ucpro&fr=pc"
			},
			"mount": {
				"home": ".btn-operate .btn-main",
				"share": ".file-info-share-buttom"
			}
		},
		"mcloud": {
			"api": {
				"getLink": "https://personal-kd-njs.yun.139.com/hcy/file/getDownloadUrl"
			},
			"mount": {
				"home": ".top_button",
				"share": ".top-btns"
			}
		}
	}

	/* åŸºç¡€å‡½æ•° */
	let base = {
		// åˆ›å»º GreaseMonkey èœå•
		registerMenuCommand() {
			GM_registerMenuCommand('âš™ï¸ è®¾ç½®', function () {
				base.showSetting();
			});
			GM_registerMenuCommand('ğŸƒï¸ ç¾åŒ–', function () {
				base.showBeautify();
			});
			GM_registerMenuCommand('ğŸ“ƒ æ›´æ–°', function () {
				base.showUpdateLog();
			});
			GM_registerMenuCommand('ğŸ› ï¸ è°ƒè¯•', function () {
				base.showDebug();
			});
		},

		// å–æ¶ˆæ³¨å†Œ
		unRegisterInit(value) {
			message.warning("æ­£åœ¨æ³¨å…¥è®¾ç½®é¡¹ç›®...");
			base.setValue('setting_init_code', value);
			base.setValue('setting_init_license', value);
			base.setValue('baidu_access_token', "");
			if (location.host.includes("baidu")) base.setStorage('baiduyunPlugin_BDUSS', "")
			history.go(0)
		},

		/*-- å¯¹è±¡ç±»å‹åˆ¤æ–­
		ç¤ºä¾‹ï¼š
			isType([]) // è¾“å‡º"array"
			isType(123) // è¾“å‡º"number"
			isType(null) // è¾“å‡º"null"
			isType(new Date()) // è¾“å‡º"date"
		*/
		isType(obj) {
			return Object.prototype.toString.call(obj).replace(/^\[object (.+)\]$/, '$1').toLowerCase();
		},


		// è·å–æœ¬åœ°ä¿å­˜çš„æ•°å€¼ï¼ˆä»…ç”¨äº Greasemonkeyï¼‰
		getValue(name) {
			return GM_getValue(name);
		},

		// å¢æ”¹æœ¬åœ°ä¿å­˜çš„æ•°å€¼ï¼ˆä»…ç”¨äº Greasemonkeyï¼‰
		setValue(name, value) {
			GM_setValue(name, value);
		},

		// åˆ é™¤æœ¬åœ°ä¿å­˜çš„æ•°å€¼ï¼ˆä»…ç”¨äº Greasemonkeyï¼‰
		deleteValue(name) {
			GM_deleteValue(name);
		},

		// è·å–æœ¬åœ°ä¿å­˜çš„æ•°å€¼
		getStorage(key) {
			try {
				return JSON.parse(localStorage.getItem(key));
			} catch (e) {
				return localStorage.getItem(key);
			}
		},

		// ä¿®æ”¹æœ¬åœ°ä¿å­˜çš„æ•°å€¼
		setStorage(key, value) {
			if (this.isType(value) === 'object' || this.isType(value) === 'array') {
				return localStorage.setItem(key, JSON.stringify(value));
			}
			return localStorage.setItem(key, value);
		},

		// è®¾ç½®å‰ªè´´æ¿
		setClipboard(text) {
			GM_setClipboard(text, 'text');
		},

		// åŠ å¯†æˆbase64ï¼ˆå…ˆè½¬æ¢æˆURLç¼–ç ï¼‰
		encode(str) {
			return btoa(unescape(encodeURIComponent(str)));
		},

		// ä»base64è§£å¯†
		decode(str) {
			return decodeURIComponent(escape(atob(str)));
		},

		// æ•°å­—è¡¥é›¶
		repairTimer(i) {
			if (i >= 0 && i <= 9) {
				return "0" + i;
			} else {
				return i;
			}
		},

		// æ¥å—æ–‡ä»¶åå¹¶è¿”å›å¤§å†™æ‰©å±•å
		getExtension(name) {
			const reg = /(?!\.)\w+$/;
			if (reg.test(name)) {
				let match = name.match(reg);
				return match[0].toUpperCase();
			}
			return '';
		},

		// æ–‡ä»¶å¤§å°è½¬æ¢ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰
		sizeFormat(value) {
			if (value === +value) {
				let unit = ["å­—èŠ‚(B)", "åƒå­—èŠ‚(KB)", "å…†å­—èŠ‚(MB)", "å‰å­—èŠ‚(GB)", "å¤ªå­—èŠ‚(TB)", "æ‹å­—èŠ‚(PB)", "è‰¾å­—èŠ‚(EB)", "æ³½å­—èŠ‚(ZB)", "å°§å­—èŠ‚(YB)"];
				if (value === 0) {
					return "0å­—èŠ‚(B)";
				} else {
					let index = Math.floor(Math.log(value) / Math.log(1024));
					let size = value / Math.pow(1024, index);
					size = size.toFixed(1);
					return size + unit[index];
				}
			}
			return '';
		},

		// æ ¹æ®æ•°ç»„ä¸­çš„æ¯ä¸ªæ–‡ä»¶åè¿›è¡Œæ’åºï¼Œä½¿ç”¨ localeCompare æ–¹æ³•æ¥æ¯”è¾ƒä¸­æ–‡å­—ç¬¦ä¸²çš„é¡ºåºã€‚
		sortByName(arr) {
			const handle = function () {
				return (a, b) => {
					const p1 = a.filename ? a.filename : a.server_filename;
					const p2 = b.filename ? b.filename : b.server_filename;
					return p1.localeCompare(p2, "zh-CN");
				};
			};
			arr.sort(handle());
		},

		// æ›¿æ¢ç‰¹æ®Šå­—ç¬¦ä¸ºä¸‹åˆ’çº¿
		fixFilename(name) {
			let replace = /[!?&|`"'*\/:<>\\]/g
			return name.replace(replace, '_');
		},

		// ä¼ é€’ Document Cookie
		getCookie(name) {
			let cname = name + "=";
			let ca = document.cookie.split(';');
			for (let i = 0; i < ca.length; i++) {
				let c = ca[i].trim();
				if (c.indexOf(cname) == 0) return c.substring(cname.length, c.length);
			}
			return "";
		},

		// æ¥å—Blobå¯¹è±¡å’Œæ–‡ä»¶åï¼Œç„¶ååˆ›å»ºä¸´æ—¶é“¾æ¥æŒ‡å‘blobå¯¹è±¡ï¼Œä¹‹ååˆ›å»ºaæ ‡ç­¾æŒ‡å‘ä¸´æ—¶é“¾æ¥å’Œè®¾ç½®æ–‡ä»¶åï¼Œæœ€åæ¨¡æ‹Ÿç‚¹å‡»aæ ‡ç­¾å®ç°ä¸‹è½½å’Œé‡Šæ”¾ä¸´æ—¶é“¾æ¥
		blobDownload(blob, filename) {
			if (blob instanceof Blob) {
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = filename;
				a.click();
				URL.revokeObjectURL(url);
			}
		},

		xmlHttpRequest(option) {
			// æ£€æŸ¥ GM_xmlhttpRequest æ˜¯å¦å¯ç”¨ï¼Œå¹¶ä½¿ç”¨å¯ç”¨çš„è¯·æ±‚æ–¹å¼
			let request = (typeof GM_xmlhttpRequest !== "undefined") ? GM_xmlhttpRequest : GM.xmlHttpRequest;
			// è°ƒç”¨è¯·æ±‚å‡½æ•°å¹¶ä¼ å…¥ option
			if (request && typeof request === 'function') {
				return request(option);
			}
		},

		/* è¯·æ±‚ */
		// ä½¿ç”¨ Post å‘é€è¯·æ±‚
		post(url, data, headers, type, maxRetries = 3, currentRetry = 0) {
			if (this.isType(data) === 'object') {
				data = JSON.stringify(data);
			}
			return new Promise((resolve, reject) => {
				const sendRequest = function () {
					base.xmlHttpRequest({
						method: "POST", url, headers, data,
						responseType: type || 'json',
						onloadstart() {
							console.log('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Post(start)\nè¯·æ±‚åœ°å€ï¼š' + url + '\nè¯·æ±‚å¤´éƒ¨ï¼š', headers);
						},
						onload: function (res) {
							// å°è¯•æ ¼å¼åŒ–è¯·æ±‚ç»“æœä»¥æ–¹ä¾¿è°ƒè¯•
							if (res.response) {
								try {
									res.decodedResponse = JSON.parse(res.response);
								} catch (e) { }
								try {
									res.decodedResponse = JSON.parse(base.decode(res.response));
								} catch (e) { }
							}
							if (res.responseText) {
								try {
									res.decodedResponseText = JSON.stringify(JSON.parse(res.responseText));
								} catch (e) { }
								try {
									res.decodedResponseText = JSON.stringify(base.decode(res.responseText));
								} catch (e) { }
							}
							console.log('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Post(load)\nè¯·æ±‚åœ°å€ï¼š' + url + '\nè¯·æ±‚å¤´éƒ¨ï¼š', headers, '\nè¯·æ±‚æ•°æ®ï¼š' + JSON.stringify(data) + '\nè¯·æ±‚ç»“æœï¼š', res);
							type === 'blob' ? resolve(res) : resolve(res.response || res.responseText);
						},
						onerror: function (err) {
							if (currentRetry < maxRetries) {
								currentRetry++;
								console.error(`ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Post(error)\nè¯·æ±‚å‡ºç°é”™è¯¯ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜\n5ç§’åå°†é‡è¯• (é”™è¯¯æ¬¡æ•°ï¼š${currentRetry}/${maxRetries})...`, err);
								setTimeout(function () {
									console.log(`ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Post(error)\né‡æ–°å°è¯•è¯·æ±‚...`);
									sendRequest(); // é‡æ–°å‘é€è¯·æ±‚
								}, 5000)
							} else {
								reject('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Post(error)\nè¯·æ±‚å‡ºç°é”™è¯¯ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜\næ— æ³•ç»§ç»­è¯·æ±‚ï¼Œè¾¾åˆ°æœ€å¤§é”™è¯¯æ¬¡æ•°ã€‚', err); // è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ‹’ç» Promise
							}
						},
					});
				};
				sendRequest(); // åˆå§‹è¯·æ±‚
			});
		},

		// ä½¿ç”¨ Get å‘é€è¯·æ±‚
		get(url, headers, type, extra, maxRetries = 3, currentRetry = 0) {
			return new Promise((resolve, reject) => {
				const sendRequest = function () {
					let requestObj = base.xmlHttpRequest({
						method: "GET", url, headers,
						responseType: type || 'json',
						onload: function (res) {
							if (res.status === 204) {
								console.log('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Get(load)\n\x1B[31mè¯¥è¯·æ±‚å·²è¢«æŸä¸ªä¸‹è½½å·¥å…·æ•è·ã€‚' + (res.statusText ? ("\n\x1B[0må·¥å…·æç¤ºï¼š\x1B[31m" + res.statusText) : "") + '\x1B[0m\nè¯·æ±‚åœ°å€ï¼š' + url + '\nè¯·æ±‚å¤´éƒ¨ï¼š', headers, '\nè¯·æ±‚ç»“æœï¼š', res);
								requestObj.abort();
								idm[extra.index] = true;
								return;
							}
							if (type === 'blob') {
								console.log('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Get(load) Blob\nè¯·æ±‚åœ°å€ï¼š' + url + '\nè¯·æ±‚å¤´éƒ¨ï¼š', headers, '\nè¯·æ±‚ç»“æœï¼š', res);
								res.status === 200 && base.blobDownload(res.response, extra.filename);
								resolve(res);
							} else {
								// å°è¯•æ ¼å¼åŒ–è¯·æ±‚ç»“æœä»¥æ–¹ä¾¿è°ƒè¯•
								if (res.response) {
									try {
										res.decodedResponse = JSON.parse(res.response);
									} catch (e) { }
									try {
										res.decodedResponse = JSON.parse(base.decode(res.response));
									} catch (e) { }
								}
								if (res.responseText) {
									try {
										res.decodedResponseText = JSON.stringify(JSON.parse(res.responseText));
									} catch (e) { }
									try {
										res.decodedResponseText = JSON.stringify(base.decode(res.responseText));
									} catch (e) { }
								}
								console.log('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Get(load)\nè¯·æ±‚åœ°å€ï¼š' + url + '\nè¯·æ±‚å¤´éƒ¨ï¼š', headers, '\nè¯·æ±‚ç»“æœï¼š', res);
								resolve(res.response || res.responseText);
							}
						},
						onprogress: function (res) {
							if (res.status === 204) {
								console.log('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Get(progress)\n\x1B[31mè¯¥è¯·æ±‚å·²è¢«æŸä¸ªä¸‹è½½å·¥å…·æ•è·ã€‚' + (res.statusText ? ("\n\x1B[0må·¥å…·æç¤ºï¼š\x1B[31m" + res.statusText) : "") + '\x1B[0m\nè¯·æ±‚åœ°å€ï¼š' + url + '\nè¯·æ±‚å¤´éƒ¨ï¼š', headers, '\nè¯·æ±‚ç»“æœï¼š', res);
								requestObj.abort();
								idm[extra.index] = true;
								return;
							}
							if (extra && extra.filename && extra.index) {
								res.total > 0 ? progress[extra.index] = (res.loaded * 100 / res.total).toFixed(2) : progress[extra.index] = 0.00;
								// console.log('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Get(progress)\n\x1B[31mè¯¥è¯·æ±‚æ­£åœ¨è¿›è¡Œä¸­ã€‚' + (progress[extra.index] ? ("\n\x1B[0mä¸‹è½½è¿›åº¦ï¼š\x1B[31m" + progress[extra.index]) : "") + '\x1B[0m');
							}
						},
						onloadstart(res) {
							if (res.status === 204) {
								console.log('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Get(start)\n\x1B[31mè¯¥è¯·æ±‚å·²è¢«æŸä¸ªä¸‹è½½å·¥å…·æ•è·ã€‚' + (res.statusText ? ("\n\x1B[0må·¥å…·æç¤ºï¼š\x1B[31m" + res.statusText) : "") + '\x1B[0m\nè¯·æ±‚åœ°å€ï¼š' + url + '\nè¯·æ±‚å¤´éƒ¨ï¼š', headers, '\nè¯·æ±‚ç»“æœï¼š', res);
								requestObj.abort();
								idm[extra.index] = true;
								return;
							}
							console.log('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Get(start)\nè¯·æ±‚åœ°å€ï¼š' + url + '\nè¯·æ±‚å¤´éƒ¨ï¼š', headers);
							if (extra && extra.filename && extra.index) request[extra.index] = requestObj;
						},
						onerror: function (err) {
							if (currentRetry < maxRetries) {
								currentRetry++;
								console.error(`ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Get(error)\nè¯·æ±‚å‡ºç°é”™è¯¯ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜\n5ç§’åå°†é‡è¯• (é”™è¯¯æ¬¡æ•°ï¼š${currentRetry}/${maxRetries})...`, err);
								setTimeout(function () {
									console.log(`ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Get(error)\né‡æ–°å°è¯•è¯·æ±‚...`);
									sendRequest(); // é‡æ–°å‘é€è¯·æ±‚
								}, 5000)
							} else {
								reject('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Get(error)\nè¯·æ±‚å‡ºç°é”™è¯¯ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜\næ— æ³•ç»§ç»­è¯·æ±‚ï¼Œè¾¾åˆ°æœ€å¤§é”™è¯¯æ¬¡æ•°ã€‚', err); // è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ‹’ç» Promise
							}
						},
					});
				};

				sendRequest(); // åˆå§‹è¯·æ±‚
			});
		},

		// ä½¿ç”¨ Get å‘é€è¯·æ±‚è·å–è·³è½¬åçš„é“¾æ¥
		getFinalUrl(url, headers, maxRetries = 3, currentRetry = 0) {
			return new Promise((resolve, reject) => {
				const sendRequest = function () {
					base.xmlHttpRequest({
						method: "GET", url, headers,
						onloadstart() {
							console.log('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Get(start) FinalUrl\nè¯·æ±‚åœ°å€ï¼š' + url + '\nè¯·æ±‚å¤´éƒ¨ï¼š', headers);
						},
						onload: function (res) {
							console.log('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Get(load) FinalUrl\nè¯·æ±‚åœ°å€ï¼š' + url + '\nè¯·æ±‚å¤´éƒ¨ï¼š', headers, '\nè¿”å›ç»“æœï¼š', res);
							resolve(res.finalUrl)
						},
						onerror: function (err) {
							if (currentRetry < maxRetries) {
								currentRetry++;
								console.error(`ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Get(error) FinalUrl\nè¯·æ±‚å‡ºç°é”™è¯¯ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜\n5ç§’åå°†é‡è¯• (é”™è¯¯æ¬¡æ•°ï¼š${currentRetry}/${maxRetries})...`);
								setTimeout(function () {
									console.log(`ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Get(error) FinalUrl\né‡æ–°å°è¯•è¯·æ±‚...`);
									sendRequest(); // é‡æ–°å‘é€è¯·æ±‚
								}, 5000)
							} else {
								reject('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Get(error) FinalUrl\nè¯·æ±‚å‡ºç°é”™è¯¯ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜\næ— æ³•ç»§ç»­è¯·æ±‚ï¼Œè¾¾åˆ°æœ€å¤§é”™è¯¯æ¬¡æ•°ã€‚', err); // è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ‹’ç» Promise
							}
						},
					});
				};
				sendRequest(); // åˆå§‹è¯·æ±‚
			});
		},

		// RPCæµ‹è¯•
		async rpcTest(domain, port, path, token) {
			return new Promise((resolve, reject) => {
				let rpc = { domain, port, path, token };
				let url = `${rpc.domain}:${rpc.port}${rpc.path}`;
				let rpcData = {
					id: new Date().getTime(),
					jsonrpc: '2.0',
					method: 'system.listMethods',
					params: [`token:${rpc.token}`],
				};
				base.xmlHttpRequest({
					method: "POST", url, headers: {}, data: JSON.stringify(rpcData),
					responseType: 'json',
					onloadstart() {
						console.log('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Post(start) RPCTest\nè¯·æ±‚åœ°å€ï¼š' + url + '\nè¯·æ±‚å†…å®¹ï¼š', rpcData);
					},
					onload: function (res) {
						console.log('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Post(load) RPCTest\nè¯·æ±‚åœ°å€ï¼š' + url + '\nè¯·æ±‚ç»“æœï¼š', res);
						if (res.response) {
							resolve("success");
						} else {
							resolve("fail");
						}
					},
					onerror: function (err) {
						console.error('ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘Post(error) RPCTest\nè¯·æ±‚å¤±è´¥', err);
						resolve("fail");
					},
				});
			});
		},

		_resetData() {
			progress = {};
			$.each(request, function (key) {
				(request[key]).abort();
			});
			$.each(ins, function (key) {
				clearInterval(ins[key]);
			});
			idm = {};
			ins = {};
			request = {};
		},

		// å°†å¯¹è±¡è½¬æ¢ä¸º URL åŠ å¯†
		stringify(obj) {
			let str = '';
			for (let key in obj) {
				if (obj.hasOwnProperty(key)) {
					let value = obj[key];
					if (Array.isArray(value)) {
						for (let i = 0; i < value.length; i++) {
							str += encodeURIComponent(key) + '=' + encodeURIComponent(value[i]) + '&';
						}
					} else {
						str += encodeURIComponent(key) + '=' + encodeURIComponent(value) + '&';
					}
				}
			}
			return str.slice(0, -1); // å»æ‰æœ«å°¾çš„ "&"
		},

		// åŠ¨æ€æ·»åŠ æ ·å¼
		addStyle(id, tag, css, element, position = "append") {
			tag = tag || 'style';
			element = element || 'body';
			let styleDom = document.getElementById(id);
			if (styleDom) styleDom.remove();
			let style = document.createElement(tag);
			style.rel = 'stylesheet';
			style.id = id;
			tag === 'style' ? style.innerHTML = css : style.href = css;
			if (position === "before") {
				$(element).before($(style));
			} else if (position === "after") {
				$(element).after($(style));
			} else if (position === "prepend") {
				$(element).prepend($(style));
			} else {
				$(element).append($(style));
			}
		},

		hexToRgba(hex) {
			// å»æ‰ # å·
			hex = hex.replace(/^#/, '');
			// å¦‚æœæ˜¯å››ä½åå…­è¿›åˆ¶é¢œè‰²å€¼ï¼Œè½¬æ¢ä¸ºå…«ä½
			if (hex.length === 4) {
				hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2] + hex[3] + hex[3];
			}
			// è§£æ RGB åˆ†é‡
			let r = parseInt(hex.substring(0, 2), 16);
			let g = parseInt(hex.substring(2, 4), 16);
			let b = parseInt(hex.substring(4, 6), 16);
			let a = '';
			// å¦‚æœæ˜¯å…«ä½åå…­è¿›åˆ¶é¢œè‰²å€¼ï¼Œè§£æ alpha é€šé“
			if (hex.length === 8) {
				a = parseInt(hex.substring(6, 8), 16) / 255; // å°† alpha å€¼è½¬æ¢ä¸º 0 åˆ° 1 ä¹‹é—´çš„å°æ•°
				a = ',' + a
			}
			// è¿”å› rgba æ ¼å¼å­—ç¬¦ä¸²
			return r + ', ' + g + ', ' + b + a;
		},

		rgbaToHex(rgba) {
			// å»æ‰å‰ç¼€ "rgba" æˆ– "rgb" å¹¶ç§»é™¤ç©ºæ ¼
			rgba = rgba.replace(/^(rgba?|RGBA?)\(/, '').replace(/\s+/g, '').replace(')', '');

			// å°†é¢œè‰²å€¼åˆ†å‰²ä¸ºæ•°ç»„
			let [r, g, b, a] = rgba.split(',');

			// å°† RGB è½¬æ¢ä¸ºåå…­è¿›åˆ¶
			r = parseInt(r).toString(16).padStart(2, '0');
			g = parseInt(g).toString(16).padStart(2, '0');
			b = parseInt(b).toString(16).padStart(2, '0');

			// å¦‚æœå­˜åœ¨ alpha é€šé“ï¼Œå¤„ç†é€æ˜åº¦å€¼
			if (a !== undefined) {
				// å°† alpha è½¬æ¢ä¸º 0 åˆ° 255 çš„åå…­è¿›åˆ¶
				a = Math.round(parseFloat(a) * 255).toString(16).padStart(2, '0');
				return `#${r}${g}${b}${a}`;
			}

			// å¦‚æœæ²¡æœ‰ alpha é€šé“ï¼Œè¿”å›æ ‡å‡†å…­ä½çš„åå…­è¿›åˆ¶é¢œè‰²
			return `#${r}${g}${b}`;
		},

		replaceColors(cssText, baseURI, type, colorMap) {
			if (!cssText) return '';
			let colorList = ['#09AAFF', '#cc3235', '#518c17', '#ed944b', '#f969a5', '#bca280', '#574AB8', '#b673ab', '#1d2327', '#18a497', '#637dff', '#0d53ff', '#3181f9', '#f8d800', '#0396ff', '#32ccbc', '#f6416c', '#2271b1', '#59524c', '#ff679a', '#f44236', '#fec107', '#8bc24a', '#2594ed', '#9c28b1']
			colorList.forEach(function (oldColor) {
				cssText = cssText.replace(new RegExp(base.hexToRgba(oldColor), 'ig'), base.hexToRgba(color));
				cssText = cssText.replace(new RegExp(oldColor, 'ig'), color);
			});
			if (type === 'other') {
				// éå†é¢œè‰²æ˜ å°„æ•°ç»„ï¼Œå°†æ—§é¢œè‰²æ›¿æ¢ä¸ºæ–°é¢œè‰²ï¼Œå¹¶æ·»åŠ è¿‡æ¸¡æ•ˆæœ
				colorMap.forEach(function (colorPair) {
					let oldColor = colorPair[0];
					let newColor = colorPair[1];
					// åˆ¤æ–­æ–°é¢œè‰²æ˜¯å¦ä¸º color
					cssText = cssText.replace(new RegExp(oldColor, 'ig'), newColor);
				});
				return cssText;
			}
			if (colorMap) {
				// éå†é¢œè‰²æ˜ å°„æ•°ç»„ï¼Œå°†æ—§é¢œè‰²æ›¿æ¢ä¸ºæ–°é¢œè‰²ï¼Œå¹¶æ·»åŠ è¿‡æ¸¡æ•ˆæœ
				colorMap.forEach(function (colorPair) {
					let oldColor = colorPair[0];
					let newColor = colorPair[1];
					// åˆ¤æ–­æ–°é¢œè‰²æ˜¯å¦ä¸º color
					if (oldColor.includes("#")) {
						cssText = cssText.replace(new RegExp(oldColor + '(.*?)}', 'ig'), newColor + '$1; ' + 'transition: all 0.1s ease;}');
					} else {
						cssText = cssText.replace(new RegExp(oldColor, 'ig'), newColor);
					}
				});
			};
			if (baseURI) {
				// æ›¿æ¢ç›¸å¯¹è·¯å¾„èµ„æºä¸ºç»å¯¹è·¯å¾„
				cssText = cssText.replace(/url\(\s*(['"]?)([^'"]*?)\1\s*\)/ig, (match, quote, url) => {
					// å¦‚æœ URL æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
					if (url && !/^(data:|https?:|\/\/)/i.test(url)) {
						try {
							let absoluteURL = new URL(url, baseURI).href;
							return `url(${absoluteURL})`;
						} catch (e) {
							return match;
						}
					}
					return match;
				});
			}
			return cssText;
		},

		setColors(colorMap, type) {
			let cssText
			document.querySelectorAll('[id^="Panlinker-ColorUI-"]').forEach(function (tag) {
				if (!tag.parentElement) return;
				// æ›¿æ¢é¢œè‰²å¹¶æ·»åŠ æ ·å¼
				if (
					tag.innerText === base.replaceColors(tag.innerText, '', type, colorMap)
				) return;
				cssText = base.replaceColors(tag.innerText, '', type, colorMap);
				tag.innerText = cssText;
				console.log(`ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘UI\nä¿®æ”¹ Panlinker-ColorUI <style> å…ƒç´  æ ·å¼\nå…ƒç´ ï¼š`, tag);
			});
			let count = 0;
			if (!colored) {
				base.waitForKeyElements('link[rel="stylesheet"]', function (tag) {
					if (!tag.parent() || !tag.attr('href')) return;

					let href = tag.attr('href');

					// ç¡®ä¿ href æ˜¯ç»å¯¹è·¯å¾„ï¼Œå¦‚æœæ˜¯ç›¸å¯¹è·¯å¾„ï¼Œåˆ™å°†å…¶è½¬æ¢ä¸ºç»å¯¹è·¯å¾„
					try {
						href = new URL(href, location.href).href;
					} catch (e) {
						return; // å¦‚æœ href æ— æ•ˆï¼Œé€€å‡º
					}

					fetch(href)
						.then(response => response.text())
						.then(responseText => {
							let id = 'Panlinker-ColorUI-' + href;

							// æ›¿æ¢é¢œè‰²å¹¶æ·»åŠ æ ·å¼
							let cssText = base.replaceColors(responseText, href, type, colorMap);

							// å¦‚æœæ ·å¼æ²¡æœ‰å˜åŒ–ï¼Œç›´æ¥è¿”å›
							if (responseText === base.replaceColors(responseText, '', type, colorMap)) return;

							base.addStyle(id, 'style', cssText, tag[0], "after");
							let newStyle = document.querySelector(`[id="${id}"]`);

							console.log(`ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘UI\n<link> å…ƒç´  è½¬ <style> å…ƒç´  æ ·å¼\nå…ƒç´ ï¼š`, tag[0], `\næ ·å¼ï¼š`, newStyle);
						})
				});
				base.waitForKeyElements('style:not([id^="Panlinker-"],[id^="swal-pub"],[class^="darkreader"])', function (tag) {
					if (!tag.parent()) return;
					let id = tag[0].id;
					let text = tag.text()
					// æ›¿æ¢é¢œè‰²å¹¶æ·»åŠ æ ·å¼
					if (text === base.replaceColors(text, '', type, colorMap)) return;
					id = id ? id : `Panlinker-ColorUI-${count++}`
					cssText = base.replaceColors(text, '', type, colorMap);
					base.addStyle(id, 'style', cssText, tag[0], "after");
					let newStyle = document.querySelector(`[id="${id}"]`)
					console.log(`ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘UI\nä¿®æ”¹ <style> å…ƒç´  æ ·å¼\nå…ƒç´ ï¼š`, newStyle);
				})
				base.waitForKeyElements('svg', function (element) {
					element.find('*').each(function () {
						let fill = $(this).attr('fill');
						let stroke = $(this).attr('stroke');
						if (fill) {
							let newFill = base.replaceColors(fill, '', type, colorMap);
							if (newFill !== fill) {
								$(this).attr('fill', newFill);
								console.log(`ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘UI\nä¿®æ”¹ <svg> å…ƒç´  æ ·å¼\nå…ƒç´ ï¼š`, $(this)[0]);
							}
						}
						if (stroke) {
							let newStroke = base.replaceColors(stroke, '', type, colorMap);
							if (newStroke !== stroke) {
								$(this).attr('stroke', newStroke);
								console.log(`ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘UI\nä¿®æ”¹ <svg> å…ƒç´  æ ·å¼\nå…ƒç´ ï¼š`, $(this)[0]);
							}
						}
					});
				});
				colored = true;
			}
		},

		// å»¶è¿Ÿ
		sleep(time) {
			return new Promise(resolve => setTimeout(resolve, time));
		},

		// è·å–å¤§ç‰ˆæœ¬
		getMajorVersion(version) {
			const [major] = (version || '').split('.');
			return /^\d+$/.test(major) ? major : null;
		},

		// æŸ¥æ‰¾ React ç»„ä»¶å®ä¾‹
		findReact(dom, traverseUp = 0) {
			const key = Object.keys(dom).find(key => {
				return key.startsWith("__reactFiber$")
					|| key.startsWith("__reactInternalInstance$");
			});
			const domFiber = dom[key];
			if (domFiber == null) return null;

			if (domFiber._currentElement) {
				let compFiber = domFiber._currentElement._owner;
				for (let i = 0; i < traverseUp; i++) {
					compFiber = compFiber._currentElement._owner;
				}
				return compFiber._instance;
			}

			const GetCompFiber = fiber => {
				let parentFiber = fiber.return;
				while (typeof parentFiber.type == "string") {
					parentFiber = parentFiber.return;
				}
				return parentFiber;
			};
			let compFiber = GetCompFiber(domFiber);
			for (let i = 0; i < traverseUp; i++) {
				compFiber = GetCompFiber(compFiber);
			}
			return compFiber.stateNode || compFiber;
		},

		// åˆå§‹åŒ–è®¾ç½®é¡¹ç›®
		initDefaultConfig() {
			let value = [
				// RPC è®¾ç½®
				{
					name: 'setting_rpc_domain',
					value: 'http://localhost'
				}, {
					name: 'setting_rpc_port',
					value: '16800'
				}, {
					name: 'setting_rpc_path',
					value: '/jsonrpc'
				}, {
					name: 'setting_rpc_token',
					value: ''
				}, {
					name: 'setting_rpc_dir',
					value: 'D:\\Downloads\\'
				},
				// æ‚é¡¹
				{
					name: 'setting_terminal_type',
					value: 'wc'
				}, {
					name: 'setting_theme_color',
					value: '#574AB8'
				}, {
					name: 'setting_init_code',
					value: ''
				}, {
					name: 'setting_init_license',
					value: ''
				},
				// é¢å¤–
				{
					name: 'setting_theme_baidu',
					value: 'no'
				}, {
					name: 'setting_theme_ali',
					value: 'no'
				}, {
					name: 'setting_theme_mcloud',
					value: 'no'
				}, {
					name: 'setting_theme_tcloud',
					value: 'no'
				}, {
					name: 'setting_theme_xunlei',
					value: 'no'
				}, {
					name: 'setting_theme_quark',
					value: 'no'
				}];

			value.forEach(function (v) {
				// æ²¡æœ‰å¯¹åº”çš„é¡¹ç›®å°±æ·»åŠ ä¸Šé¡¹ç›®
				if (!base.getValue(v.name)) base.setValue(v.name, v.value);
			});
		},

		// è®¾ç½®ç•Œé¢
		showSetting() {
			let dom = ''
			dom += `<div style="text-align: center;">å¸¦æ˜Ÿå·çš„è®¾ç½®é¡¹ç›®å°†åœ¨ç½‘é¡µåˆ·æ–°åç”Ÿæ•ˆ</div>`
			dom += `<label class="pl-setting-label"><div class="pl-label">RPCä¸»æœº</div><input type="text"  placeholder="ä¸»æœºåœ°å€ï¼Œéœ€å¸¦ä¸Šhttp(s)://ï¼Œä½†ä¸éœ€è¦å†™ç«¯å£ä¸è·¯å¾„" class="swal2-input pl-input listener-rpc-domain" value="${base.getValue('setting_rpc_domain')}"></label>`;
			dom += `<label class="pl-setting-label"><div class="pl-label">RPCç«¯å£</div><input type="text" placeholder="ç«¯å£å·ï¼Œä¾‹å¦‚ï¼šMotrixä¸‹è½½å™¨ä¸º16800" class="swal2-input pl-input listener-rpc-port" value="${base.getValue('setting_rpc_port')}"></label>`;
			dom += `<label class="pl-setting-label"><div class="pl-label">RPCè·¯å¾„</div><input type="text" placeholder="è·¯å¾„ï¼Œé»˜è®¤ä¸º/jsonrpc" class="swal2-input pl-input listener-rpc-path" value="${base.getValue('setting_rpc_path')}"></label>`;
			dom += `<label class="pl-setting-label"><div class="pl-label">RPCå¯†é’¥</div><input type="text" placeholder="æ— å¯†é’¥æ— éœ€å¡«å†™" class="swal2-input pl-input listener-rpc-token" value="${base.getValue('setting_rpc_token')}"></label>`;
			dom += `<label class="pl-setting-label"><div class="pl-label">RPCä¿å­˜</div><input type="text" placeholder="æ–‡ä»¶ä¸‹è½½åä¿å­˜è·¯å¾„ï¼Œä¾‹å¦‚ï¼šD:\\Downloads\\" class="swal2-input pl-input listener-rpc-dir" value="${base.getValue('setting_rpc_dir')}"></label>`;
			dom += `<label class="pl-setting-label"><div class="pl-label">å½“å‰RPC</div><div><span id="pl-rpcDomain">${base.getValue('setting_rpc_domain')}</span>:<span id="pl-rpcPort">${base.getValue('setting_rpc_port')}</span><span id="pl-rpcPath">${base.getValue('setting_rpc_path')}</span><button type="button" class="pl-button-mini swal2-confirm swal2-styled listener-rpc-test">æµ‹è¯•</button></div></label>`;
			dom += `<label class="pl-setting-label" style="padding-top:0;flex-direction:row-reverse;text-align:right;"><span><a href="https://www.youxiaohou.com/zh-cn/motrix.html#ä½¿ç”¨æŒ‡å—" target="_blank" class="pl-a" data-no-instant="1">RPCé…ç½®è¯´æ˜</a>ï¼Œé€‚ç”¨äºRPCä¸‹è½½ğŸ‘†</span></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">ç»ˆç«¯ç±»å‹</div><select class="swal2-select pl-input listener-terminal">`;
			Object.keys(terminalType).forEach(k => {
				dom += `<option value="${k}" ${base.getValue('setting_terminal_type') === k ? 'selected' : ''}>${terminalType[k]}</option>`;
			});
			dom += `</select></label>`;
			dom += `<label class="pl-setting-label" style="padding-top:0;flex-direction:row-reverse;text-align:right;"><span><a href="https://www.youxiaohou.com/zh-cn/curl.html" target="_blank" class="pl-a" data-no-instant="1">cURLä½¿ç”¨æ•™ç¨‹</a>ï¼Œé€‚ç”¨äºcURLä¸‹è½½ğŸ‘†</span></label>`;

			dom += `<button type="button" style="margin-top: 30px;" class="pl-button-mini swal2-deny swal2-styled listener-register">ç†„ç­å·²ç»ç‚¹äº®çš„æŒ‰é’®*</button>`

			dom = '<div>' + dom + '</div>';

			Swal.fire({
				title: 'åŠ©æ‰‹è®¾ç½®',
				html: dom,
				icon: 'info',
				iconHtml: 'âš™ï¸',
				allowOutsideClick: false,
				showCloseButton: true,
				showConfirmButton: false,
				footer: config.base.dom.footer,
				...swalDefault
			});
			doc.on('click', '.listener-register', async function (e) {
				base.unRegisterInit(111111);
			});
			doc.on('click', '.listener-rpc-test', async function (e) {
				e.preventDefault();
				let domain = base.getValue('setting_rpc_domain'),
					port = base.getValue('setting_rpc_port'),
					path = base.getValue('setting_rpc_path'),
					token = base.getValue('setting_rpc_token');
				if (e.target.innerHTML !== "æµ‹è¯•") return;
				e.target.innerHTML = "ç­‰å¾…";
				e.target.style.opacity = 0.9;
				let result = await base.rpcTest(domain, port, path, token);
				if (result === "success") {
					e.target.innerHTML = "æˆåŠŸ";
					e.target.style.backgroundColor = "#52c41a";
				} else {
					e.target.innerHTML = "å¤±è´¥";
					e.target.style.backgroundColor = "#cb1616";
				}
				e.target.style.opacity = "";
				setTimeout(function () {
					e.target.innerHTML = "æµ‹è¯•";
					e.target.style.backgroundColor = "";
				}, 3000)
			});
			doc.on('input', '.listener-rpc-domain', async function (e) {
				base.setValue('setting_rpc_domain', e.target.value);
				document.getElementById("pl-rpcDomain").innerHTML = e.target.value;
			});
			doc.on('input', '.listener-rpc-port', async function (e) {
				base.setValue('setting_rpc_port', e.target.value);
				document.getElementById("pl-rpcPort").innerHTML = e.target.value;
			});
			doc.on('input', '.listener-rpc-path', async function (e) {
				base.setValue('setting_rpc_path', e.target.value);
				document.getElementById("pl-rpcPath").innerHTML = e.target.value;
			});
			doc.on('input', '.listener-rpc-token', async function (e) {
				base.setValue('setting_rpc_token', e.target.value);
			});
			doc.on('input', '.listener-rpc-dir', async function (e) {
				base.setValue('setting_rpc_dir', e.target.value);
			});
			doc.on('change', '.listener-terminal', async function (e) {
				base.setValue('setting_terminal_type', e.target.value);
			});
		},

		// ç¾åŒ–ç•Œé¢
		showBeautify() {
			let dom = '',
				btn = '',
				colorList = ['#09AAFF', '#cc3235', '#518c17', '#ed944b', '#f969a5', '#bca280', '#b673ab', '#574AB8', '#1d2327', '#18a497', '#637dff', '#0d53ff', '#3181f9', '#f8d800', '#0396ff', '#32ccbc', '#f6416c', '#2271b1', '#59524c', '#ff679a', '#f44236', '#fec107', '#8bc24a', '#2594ed', '#9c28b1'],
				colorNameList = ['åº¦ç›˜<br/>ç»å…¸è“', 'åº¦ç›˜<br/>å¹³å®‰çº¢', 'åº¦ç›˜<br/>ç›ç„¶ç»¿', 'åº¦ç›˜<br/>å‘¨å¹´æ©™', 'åº¦ç›˜<br/>å¹¸ä¼šç²‰', 'åº¦ç›˜<br/>åˆåæ£•', 'åº¦ç›˜<br/>ç‰©è¯­ç´«', 'åº¦ç›˜<br/>æ˜Ÿç©ºç´«', 'OpenAI<br/>é»˜è®¤é»‘', 'OpenAI<br/>é»˜è®¤é’', 'é‡Œåº¦<br/>éœå…‰ç´«', 'å¤¸å…‹<br/>æç®€è“', 'ç§»åŠ¨<br/>å½©äº‘è“', 'æœæ ¸<br/>æŸ æª¬é»„', 'æœæ ¸<br/>é»˜è®¤è“', 'æœæ ¸<br/>ç¢§æ³¢ç»¿', 'æœæ ¸<br/>ç«ç‘°çº¢', 'æ–‡æ´¾<br/>é»˜è®¤è“', 'æ–‡æ´¾<br/>å’–å•¡ç°', 'å“”å“©<br/>å°‘å¥³ç²‰', 'å“”å“©<br/>é«˜èƒ½çº¢', 'å“”å“©<br/>å’¸è›‹é»„', 'å“”å“©<br/>æ—©è‹—ç»¿', 'å“”å“©<br/>å®çŸ³è“', 'å“”å“©<br/>ç½—å…°ç´«'];
			dom += `<div style="text-align: center;">å¸¦æ˜Ÿå·çš„ç¾åŒ–é¡¹ç›®å°†åœ¨ç½‘é¡µåˆ·æ–°åç”Ÿæ•ˆ</div>`

			colorList.forEach((v, i) => {
				btn += `<div style="background: ${v};border: 1px solid ${v}" class="pl-color-box ${v === base.getValue('setting_theme_color') ? 'listener-color' : 'listener-color'}">
				<div data-color="${v}" class="pl-mask">${colorNameList[i]} ${v === base.getValue('setting_theme_color') ? '<span id="pl-thisColor">(å½“å‰)</span>' : ''}</div>
			</div>`;
			});

			dom += `<label class="pl-setting-label"><div class="pl-label">ä¸»é¢˜é¢œè‰²</div> <div class="pl-color">${btn}</div></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">[ç™¾åº¦ç½‘ç›˜]<br/>æ›´æ¢ç•Œé¢ä¸ºä¸»é¢˜é¢œè‰²*</div><select class="swal2-select pl-input listener-baidu-theme">`;
			Object.keys(assistantTheme).forEach(value => { dom += `<option value="${value}" ${base.getValue('setting_theme_baidu') === value ? 'selected' : ''}>${assistantTheme[value]}</option>`; });
			dom += `</select></label>`;
			dom += `<label class="pl-setting-label" style="padding-top:0;flex-direction:row-reverse;text-align:right;"><span>æ—§ç‰ˆé¡µé¢ä¼šç¾åŒ–,æ–°ç‰ˆé¡µé¢åˆ™æ˜¯æ›´æ¢ä¸»é¢˜è‰²ğŸ‘†</span></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">[é˜¿é‡Œäº‘ç›˜]<br/>æ›´æ¢ç•Œé¢ä¸ºä¸»é¢˜é¢œè‰²*</div><select class="swal2-select pl-input listener-ali-theme">`;
			Object.keys(assistantTheme).forEach(value => { dom += `<option value="${value}" ${base.getValue('setting_theme_ali') === value ? 'selected' : ''}>${assistantTheme[value]}</option>`; });
			dom += `</select></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">[å¤©ç¿¼äº‘ç›˜]<br/>æ›´æ¢ç•Œé¢ä¸ºä¸»é¢˜é¢œè‰²*</div><select class="swal2-select pl-input listener-tcloud-theme">`;
			Object.keys(assistantTheme).forEach(value => { dom += `<option value="${value}" ${base.getValue('setting_theme_tcloud') === value ? 'selected' : ''}>${assistantTheme[value]}</option>`; });
			dom += `</select></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">[è¿…é›·äº‘ç›˜]<br/>æ›´æ¢ç•Œé¢ä¸ºä¸»é¢˜é¢œè‰²*</div><select class="swal2-select pl-input listener-xunlei-theme">`;
			Object.keys(assistantTheme).forEach(value => { dom += `<option value="${value}" ${base.getValue('setting_theme_xunlei') === value ? 'selected' : ''}>${assistantTheme[value]}</option>`; });
			dom += `</select></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">[å¤¸å…‹ç½‘ç›˜]<br/>æ›´æ¢ç•Œé¢ä¸ºä¸»é¢˜é¢œè‰²*</div><select class="swal2-select pl-input listener-quark-theme">`;
			Object.keys(assistantTheme).forEach(value => { dom += `<option value="${value}" ${base.getValue('setting_theme_quark') === value ? 'selected' : ''}>${assistantTheme[value]}</option>`; });
			dom += `</select></label>`;

			dom += `<label class="pl-setting-label"><div class="pl-label">[ç§»åŠ¨äº‘ç›˜]<br/>æ›´æ¢ç•Œé¢ä¸ºä¸»é¢˜é¢œè‰²*</div><select class="swal2-select pl-input listener-mcloud-theme">`;
			Object.keys(assistantTheme).forEach(value => { dom += `<option value="${value}" ${base.getValue('setting_theme_mcloud') === value ? 'selected' : ''}>${assistantTheme[value]}</option>`; });
			dom += `</select></label>`;

			dom = '<div>' + dom + '</div>';

			Swal.fire({
				title: 'åŠ©æ‰‹ç¾åŒ–',
				html: dom,
				icon: 'success',
				iconHtml: 'ğŸƒï¸',
				allowOutsideClick: false,
				showCloseButton: true,
				showConfirmButton: false,
				footer: config.base.dom.footer,
				...swalDefault
			});
			doc.on('click', '.listener-color', async function (e) {
				if (e.target.dataset.color) {
					if (document.getElementById("pl-thisColor")) {
						document.getElementById("pl-thisColor").remove();
					}
					e.target.innerHTML += '<span id="pl-thisColor">(å½“å‰)</span>';
					base.setValue('setting_theme_color', e.target.dataset.color);
					base.addPanLinkerStyle();
				}
			});
			doc.on('change', '.listener-baidu-theme', async function (e) {
				base.setValue('setting_theme_baidu', e.target.value);
			});
			doc.on('change', '.listener-ali-theme', async function (e) {
				base.setValue('setting_theme_ali', e.target.value);
			});
			doc.on('change', '.listener-tcloud-theme', async function (e) {
				base.setValue('setting_theme_tcloud', e.target.value);
			});
			doc.on('change', '.listener-xunlei-theme', async function (e) {
				base.setValue('setting_theme_xunlei', e.target.value);
			});
			doc.on('change', '.listener-quark-theme', async function (e) {
				base.setValue('setting_theme_quark', e.target.value);
			});
			doc.on('change', '.listener-mcloud-theme', async function (e) {
				base.setValue('setting_theme_mcloud', e.target.value);
			});
		},

		// è°ƒè¯•ä¿¡æ¯ç•Œé¢
		showDebug() {
			let debugInfo = '';
			debugInfo += `<span>ä»¥ä¸‹å†…å®¹å‡ä¸ºè„šæœ¬è‡ªæ£€ä¿¡æ¯<br/>æœ¬é¡µé¢ä»…ä½œä¸ºè°ƒè¯•ä½¿ç”¨<span>`;
			debugInfo += `<label class="pl-setting-label"><div class="pl-label">[å¤–ç½®]<br/>ç®¡ç†å™¨åç§°</div>${manageHandler ? manageHandler : "æ— æ³•è·å–"}</label>`;
			debugInfo += `<label class="pl-setting-label"><div class="pl-label">[å¤–ç½®]<br/>ç®¡ç†å™¨ç‰ˆæœ¬</div>${manageVersion ? manageVersion : "æ— æ³•è·å–"}</label>`;
			debugInfo += `<label class="pl-setting-label"><div class="pl-label">[å†…ç½®]<br/>è„šæœ¬åç§°</div>${realName ? realName : "æ— æ³•è·å–"}</label>`;
			debugInfo += `<label class="pl-setting-label"><div class="pl-label">[å†…ç½®]<br/>è„šæœ¬ç‰ˆæœ¬</div>${realVersion ? realVersion : "æ— æ³•è·å–"}</label>`;
			debugInfo += `<label class="pl-setting-label"><div class="pl-label">[å†…ç½®]<br/>è„šæœ¬ä½œè€…</div>${realAuthor ? realAuthor : "æ— æ³•è·å–"}</label>`;

			debugInfo += `<label class="pl-setting-label"><div class="pl-label">[å†…ç½®]<br/>å…¬ä¼—å·ç </div>${config.base.service.account ? `${config.base.service.account}<img src="${config.base.service.account}"></img>` : "æ— æ³•è·å–"}</label>`;
			debugInfo += `<label class="pl-setting-label"><div class="pl-label">[å†…ç½®]<br/>Toasté¡µè„š</div>${config.base.dom.footer ? config.base.dom.footer : "æ­¤ç½‘ç«™æš‚æ— "}</label>`;


			debugInfo = '<div>' + debugInfo + '</div>';

			Swal.fire({
				icon: 'info',
				title: 'è°ƒè¯•ä¿¡æ¯',
				html: debugInfo,
				allowOutsideClick: false,
				showCloseButton: true,
				confirmButtonText: 'å…³é—­',
				...swalDefault
			});
		},

		// æ›´æ–°æ—¥å¿—ç•Œé¢
		showUpdateLog() {
			Swal.fire({
				icon: 'info',
				title: 'æ›´æ–°æ—¥å¿—',
				html: `<div style="text-align: left;">
				V1.0.9.7<br/>1ã€ä¿®å¤ç§»åŠ¨äº‘ç›˜ä¸‹è½½é”™è¯¯ï¼›<br/>2ã€ä¼˜åŒ–ä»£ç ï¼Œæ›´å¥½çš„é”™è¯¯è¯†åˆ«ï¼›<br/>3ã€å»é™¤äº†æ¸¸å°çŒ´äº‘æœåŠ¡ã€‚<br/><br/>
				V1.0.9.6<br/>1ã€æ”¯æŒåœ¨ç™¾åº¦ç½‘ç›˜ä¸­é€‰æ‹©æ–‡ä»¶å¤¹ä¸‹è½½ï¼›<br/>2ã€ä¼˜åŒ–éƒ¨åˆ†æç¤ºã€‚<br/><br/>
				V1.0.9.5<br/>1ã€ä¿®å¤å› ä»£ç é€»è¾‘é”™è¯¯è€Œæ— æ³•è·å–é“¾æ¥çš„ Bugã€‚<br/><br/>
				V1.0.9.4<br/>1ã€ä¿®å¤å› ç™¾åº¦ç½‘ç›˜ AccessToken è¿‡æœŸå¯¼è‡´æ— æ³•è·å–é“¾æ¥çš„ Bugã€‚<br/><br/>
				V1.0.9.3<br/>1ã€è‹¥ç½‘ç›˜ä¸æ”¯æŒåœ¨åˆ†äº«ä¸­ä¸‹è½½ï¼Œå°†ä»…æ˜¾ç¤ºä¿å­˜ç½‘ç›˜æŒ‰é’®ï¼›<br/>2ã€ä¼˜åŒ–ä¸‹è½½ç•Œé¢ï¼Œæ”¯æŒé€‰æ‹© Iframe æˆ– Blob çš„æ–¹å¼æ¥ä¸‹è½½æ–‡ä»¶ï¼Œå¢åŠ æŒ‰é’®çš„æç¤ºæ–‡æœ¬ï¼›<br/>3ã€ä¼˜åŒ– CSS æ ·å¼ï¼Œç»Ÿä¸€äº† SweetAlert2 æŒ‰é’®æ ·å¼ï¼ŒåŒæ—¶é€‚é…äº† Dark Reader æ’ä»¶ï¼Œç•Œé¢æ›´åè°ƒï¼›<br/>4ã€æ”¯æŒä¿®æ”¹æ²¹å°çŒ´ç½‘ç«™ä¸»é¢˜è‰²ï¼›<br/>5ã€åŸæœ‰ä¸»é¢˜ç›¸å…³è®¾ç½®ç°å·²ç§»åŠ¨è‡³åŠ©æ‰‹ç¾åŒ–é¡µé¢ä¸­ã€‚<br/><br/>
				V1.0.9.2<br/>1ã€ä¿®å¤ä½¿ç”¨APIä¸‹è½½æ—¶æœ‰å¯èƒ½ä¼šå¯¼è‡´IDMæ— é™å¼¹çª—çš„Bugã€‚<br/><br/>
				V1.0.9.1<br/>1ã€ä¿®å¤åœ¨ç™¾åº¦ç½‘ç›˜æ—§ç‰ˆä¸‹è„šæœ¬æ— æ³•åˆ é™¤å…ƒç´ çš„Bugã€‚<br/><br/>
				V1.0.9<br/>1ã€è·Ÿè¿›å®˜æ–¹V6.2.7ï¼Œä¿®å¤å› æ— æ³•è¿›è¡Œç™¾åº¦æˆæƒè€Œå¯¼è‡´è·å–ç›´é“¾æŠ¥é”™ 9019 çš„ Bugã€‚<br/><br/>
				V1.0.8.9<br/>1ã€è·Ÿè¿›å®˜æ–¹V6.2.3ï¼Œä¼˜åŒ–ä¿å­˜åˆ°ç½‘ç›˜æç¤ºï¼Œä¿®å¤é˜¿é‡Œäº‘ç›˜ã€ç§»åŠ¨äº‘ç›˜å¤±æ•ˆçš„é—®é¢˜ï¼›<br/>2ã€ä¼˜åŒ–ä¿®æ”¹ç½‘ç›˜ä¸»é¢˜çš„ä»£ç ï¼Œå‡å°‘å¯¹é¡µé¢çš„ç ´åã€‚<br/><br/>
				V1.0.8.8<br/>1ã€ä¿®å¤ä¸‹è½½èœå•å­—ä½“è¿‡å°çš„Bugã€‚<br/><br/>
				V1.0.8.7<br/>1ã€ä¿®å¤åœ¨é˜¿é‡Œäº‘ç›˜åˆ†äº«é¡µé¢ä¸‹ç‚¹å‡»â€œæœªç‚¹äº®â€æŒ‰é’®æ—¶æ²¡æœ‰ä»»ä½•ååº”çš„Bugï¼›<br/>2ã€æ›´æ–°å¹¶ä¼˜åŒ–ç½‘ç›˜ç•Œé¢ç²¾ç®€è§„åˆ™ï¼›<br/>3ã€æ”¯æŒæ›´æ¢ ç™¾åº¦ç½‘ç›˜ã€é˜¿é‡Œäº‘ç›˜ã€è¿…é›·äº‘ç›˜ã€å¤¸å…‹ç½‘ç›˜ã€ç§»åŠ¨äº‘ç›˜ ç•Œé¢çš„ä¸»é¢˜é¢œè‰²ã€‚<br/><br/>
				V1.0.8.6<br/>1ã€æ–°å¢ç§»åŠ¨äº‘ç›˜ä¼šå‘˜ä¸­å¿ƒé¡µé¢ï¼Œå¯åœ¨ç½‘ç›˜ä¸­ç‚¹å‡»â€œä¼šå‘˜ä¸­å¿ƒâ€æŒ‰é’®æŸ¥çœ‹(ä½†æ— æ³•ä½¿ç”¨ç¬¬ä¸‰æ–¹æ”¯ä»˜)ã€‚<br/><br/>
				V1.0.8.5<br/>1ã€è·Ÿè¿›å®˜æ–¹V6.1.6ï¼Œä¿®å¤è¿…é›·ç½‘ç›˜åˆ†äº«é¡µé¢æ— æ³•é€‰ä¸­æ–‡ä»¶ï¼Œä¿®å¤ç§»åŠ¨äº‘ç›˜æ— æ³•åˆ¤æ–­é¡µé¢ã€‚<br/><br/>
				V1.0.8.4<br/>1ã€ä¿®å¤å› é‡å¤ç»‘å®šæŒ‰é’®è€Œå¯¼è‡´å‘½ä»¤é‡å¤æ‰§è¡Œçš„Bugï¼›<br/>2ã€ä¼˜åŒ–è°ƒè¯•ä¿¡æ¯ç•Œé¢æ’ç‰ˆï¼›<br/>3ã€ç§»é™¤å¯¹ç™¾åº¦ç½‘ç›˜æ‰‹æœºç½‘é¡µç‰ˆçš„æ”¯æŒã€‚<br/><br/>
				V1.0.8.3<br/>1ã€é€‚é…é˜¿é‡Œäº‘ç›˜æ–°åŸŸåalipan.comã€‚<br/><br/>
				V1.0.8.2<br/>1ã€æ›´æ¢æ–°å›¾æ ‡ã€‚<br/><br/>
				V1.0.8.1<br/>1ã€ä¿®å¤å› é‡å¤ç»‘å®šæŒ‰é’®è€Œå¯¼è‡´RPCä¸‹è½½ä¼šå‘é€å¤šæ¡ä¸‹è½½è¯·æ±‚çš„Bugï¼›<br/>2ã€é€‰æ‹©ä¸ä½¿ç”¨æ²¹å°çŒ´æœåŠ¡å™¨æ—¶ï¼Œâ€œç”¨ghproxyè¿æ¥Githubä»“åº“â€æ›´æ¢ä¸ºâ€œç”¨jsdelivrè¿æ¥Githubä»“åº“â€ï¼›<br/>3ã€è·Ÿè¿›å®˜æ–¹V6.1.4ç‰ˆæœ¬ï¼Œä¿®å¤ç§»åŠ¨ç½‘ç›˜æ— æ³•è·å–é“¾æ¥ï¼Œæ”¯æŒé˜¿é‡Œäº‘ç›˜æ–°åŸŸåalipan.comã€‚<br/><br/>
				V1.0.8<br/>1ã€ä¿®å¤è¿…é›·ç½‘ç›˜æ— æ³•å‹¾é€‰æ–‡ä»¶ã€‚<br/><br/>
				V1.0.7.9<br/>1ã€æ›´æ–°ç²¾ç®€ç½‘ç›˜å…ƒç´ åŒ¹é…è§„åˆ™ï¼Œé˜²æ­¢å› é€šçŸ¥æ¨ªæ¡è€Œå¯¼è‡´ä¸èƒ½ç‚¹åˆ°â€œAPIä¸‹è½½â€ä»¥ä¸‹çš„æŒ‰é’®ã€‚<br/><br/>
				V1.0.7.8<br/>1ã€è·Ÿè¿›å®˜æ–¹V6.1.2ï¼ŒåŠ å…¥V2æ¥å£ã€‚<br/>2ã€ä¿®å¤ç™¾åº¦ç½‘ç›˜ä¸‹è½½æ—¶å› ä¸ºè·å–ä¸åˆ°accessTokenè€Œä¸€ç›´è½¬åœˆã€‚<br/><br/>
				V1.0.7.7<br/>1ã€ä¿®å¤ç™¾åº¦ç½‘ç›˜çš„æŒ‰é’®ä¼šå› ä¸ºä¸»é¢˜ä¸åŒè€Œè¢«æ”¹å˜é¢œè‰²çš„Bugï¼›<br/>2ã€æ›´æ–°å¤¸å…‹ç½‘ç›˜æŒ‰é’®ä¸ç•Œé¢ã€‚<br/><br/>
				V1.0.7.6<br/>1ã€ä¿®å¤â€œæ³¨å…¥â€åŠŸèƒ½ï¼›<br/>2ã€é»‘æš—æ¨¡å¼æ”¯æŒéšè®¾ç½®çƒ­åˆ‡æ¢ã€‚<br/><br/>
				V1.0.7.5<br/>1ã€ä¿®å¤é˜¿é‡Œäº‘ç›˜ä¸‹è½½é€»è¾‘ï¼›<br/>2ã€ç²¾ç®€ä»£ç ï¼›<br/>3ã€æ”¯æŒæ·±è‰²æ¨¡å¼ï¼›<br/>4ã€ä¿®æ”¹éƒ¨åˆ†æç¤ºæ–‡æœ¬ï¼›<br/>5ã€ä¿®æ”¹éƒ¨åˆ†CSSï¼›<br/>6ã€è®¾ç½®å¯æµ‹è¯•RPCè¿æ¥ã€‚<br/><br/>
				V1.0.7.4<br/>1ã€ä¼˜åŒ–ä¸‹è½½é€»è¾‘ï¼›<br/>2ã€ä¿®å¤é˜¿é‡Œäº‘ç›˜æ— æ³•ä½¿ç”¨APIä¸‹è½½ã€‚<br/><br/>
				V1.0.7.3<br/>1ã€å¦‚æœå‡ºç°ç½‘ç»œè¯·æ±‚é”™è¯¯æ—¶æ”¯æŒè‡ªåŠ¨é‡æ–°è¯·æ±‚ï¼›<br/>2ã€å¯é€‰æ‹©æ˜¯å¦ä½¿ç”¨æ²¹å°çŒ´æœåŠ¡å™¨ã€‚<br/><br/>
				V1.0.7.2<br/>1ã€ä¿®å¤ä½¿ç”¨RPCä¸‹è½½æ—¶ä¼šé‡å¤å‘é€é“¾æ¥çš„Bugã€‚<br/><br/>
				V1.0.7.1<br/>1ã€[å®éªŒåŠŸèƒ½ï¼Œä¸å½±å“æ­£å¸¸ä½¿ç”¨]æ”¯æŒç™¾åº¦ç½‘ç›˜æ‰‹æœºç½‘é¡µç‰ˆï¼Œå‹¾é€‰æ–‡ä»¶åå¯åœ¨é¡¶æ æ‰¾åˆ°â€œä¸‹è½½åŠ©æ‰‹â€æŒ‰é’®ã€‚<br/><br/>
				V1.0.7<br/>1ã€é‡æ„å¤¸å…‹ç½‘ç›˜ã€é˜¿é‡Œäº‘ç›˜æŒ‰é’®ã€‚<br/><br/>
				V1.0.6.9<br/>1ã€ä¸‹è½½çª—å£åŠ å…¥å…³é—­æŒ‰é’®ã€‚<br/><br/>
				V1.0.6.8<br/>1ã€ä¿®å¤å¤¸å…‹ç½‘ç›˜æŒ‰é’®é”™ä½ã€‚<br/><br/>
				V1.0.6.7<br/>1ã€å°†ç™¾åº¦ç½‘ç›˜ç•Œé¢ä¿®æ”¹ä¸ºä¸»é¢˜è‰²ï¼Œå¯åœ¨è®¾ç½®é€‰æ‹©æ˜¯å¦ä¿®æ”¹ï¼›<br/>2ã€å¢åŠ ä¸»é¢˜è‰²åç§°ï¼Œæ›´æ”¹éƒ¨åˆ†å†…å®¹é¢œè‰²ï¼›<br/>3ã€ç§»åŠ¨äº‘ç›˜APIä¸‹è½½æ”¯æŒæ‰¹é‡å¤åˆ¶ï¼›<br/>4ã€ä¼˜åŒ–æ§åˆ¶å°è¾“å‡ºç»“æœï¼›<br/>5ã€ç™¾åº¦ç½‘ç›˜APIä¸‹è½½ä¸ä½¿ç”¨IDMæ—¶å¯ä»¥æ˜¾ç¤ºå‰©ä½™æ—¶é—´ï¼›<br/>6ã€â€œå–æ¶ˆç‚¹äº®æŒ‰é’®â€æŒ‰é’®çš„ä½ç½®ç°å·²ç§»åŠ¨åˆ°è®¾ç½®é¡µé¢ã€‚<br/>7ã€homoç‰¹æœ‰çš„å½©è›‹åˆå›æ¥åŠ›(å–œ)ã€‚<br/><br/>
				V1.0.6.6<br/>1ã€ä¿®å¤æš—å·é”™è¯¯ã€‚<br/><br/>
				V1.0.6.5<br/>1ã€ä¿®å¤å³ä½¿è¾“å…¥æ­£ç¡®æš—å·ä¹Ÿä¸èƒ½æˆåŠŸç‚¹äº®æŒ‰é’®çš„æœåŠ¡å™¨é”™è¯¯ã€‚<br/><br/>
				V1.0.6.4<br/>1ã€è·Ÿè¿›å®˜æ–¹V6.1.1ç‰ˆæœ¬ï¼Œä¿®å¤é˜¿é‡Œäº‘ç›˜è·å–ä¸‹è½½é“¾æ¥æ—¶çš„é—®é¢˜ã€‚<br/><br/>
				V1.0.6.3<br/>1ã€ç…§é¡¾å°å±å¹•ç”¨æˆ·ï¼Œå°†å§‹ç»ˆæ˜¾ç¤ºå¤åˆ¶å…¨éƒ¨é“¾æ¥çš„æŒ‰é’®ï¼›<br/>2ã€å¢åŠ å–æ¶ˆä¸‹è½½æ—¶çš„åŠ¨ç”»ã€‚<br/><br/>
				V1.0.6.2<br/>1ã€ä¿®å¤éƒ¨åˆ†ç•Œé¢é”™ä½ï¼Œå®ç°CSSå†…ç½®ï¼›<br/>2ã€ç™¾åº¦ç½‘ç›˜ç•Œé¢å°†å˜å¾—æ›´åŠ ç®€æ´ã€‚<br/><br/>
				V1.0.6.1<br/>1ã€æ–°å¢ç™¾åº¦äº‘ç›˜APIä¸‹è½½æ”¯æŒå¤åˆ¶é“¾æ¥ï¼›<br/>2ã€ä¸ºäº†ç…§é¡¾æ‰‹æœºæµè§ˆå™¨ç”¨æˆ·ï¼Œå¢å¤§é¡¹ç›®ä¹‹é—´é—´éš™ï¼Œæ–°å¢éšè—IDMæç¤ºé€‰é¡¹ï¼Œå¯åœ¨åŠ©æ‰‹è®¾ç½®ä¸­å¯ç”¨ï¼›<br/>3ã€ä¿®æ”¹CSSï¼Œç•Œé¢ä¼šå‡ºç°æ›´å¤šçš„ä¸»é¢˜è‰²ï¼›<br/>4ã€æ”¯æŒåœ¨æ¸¸å°çŒ´å®˜ç½‘æŸ¥çœ‹æš—å·ï¼›<br/>5ã€ä¿®å¤éƒ¨åˆ†è¯­æ³•é”™è¯¯ã€‚<br/><br/>
				V1.0.6<br/>1ã€ä¿®å¤äº†æ‰“å¼€é˜¿é‡Œäº‘ç›˜åˆ†äº«è¿æ¥æ—¶å› ä¸‹è½½ç§»åŠ¨ç«¯å¹¿å‘Šå¯¼è‡´åªèƒ½ç‚¹å‡»APIä¸‹è½½ï¼›<br/>2ã€è·Ÿè¿›å®˜æ–¹6.0.4ç‰ˆæœ¬ï¼Œä¿®å¤å¤¸å…‹ç½‘ç›˜è·å–ä¸‹è½½é“¾æ¥å¤±æ•ˆã€æ”¯æŒç§»åŠ¨äº‘ç›˜ã€‚<br/><br/>
				V1.0.5.5<br/>1ã€æ„Ÿè°¢<a href="https://github.com/Night-stars-1">Night-stars-1</a>çš„å¸®åŠ©ï¼Œä¿®å¤å› ä¸ºåŸä½œè€…æœåŠ¡å™¨å¯¼è‡´çš„åˆå§‹åŒ–æš—å·è¯†åˆ«é”™è¯¯ï¼›<br/>2ã€ä¿®æ”¹ä¸€äº›æ–‡æœ¬ä»¥åŠæä¾›ç»™æœåŠ¡å™¨çš„ä¿¡æ¯ã€‚<br/><br/>
				V1.0.5.4<br/>1ã€å°ä¿®å°æ”¹cssï¼Œè®©ä¸»é¢˜è‰²å‡ºç°åœ¨æ›´å¤šåœ°æ–¹ï¼›<br/>2ã€ä¿®æ”¹ä¸‹è½½é“¾æ¥è·å–å¤±è´¥çš„æç¤ºï¼›<br/>3ã€å¢åŠ æ›´å¤šçš„ä¸»é¢˜è‰²ï¼Œå¯åœ¨åŠ©æ‰‹è®¾ç½®æŸ¥çœ‹ï¼›<br/>4ã€homoå½©è›‹è¢«åˆ å»åŠ›ï¼ˆæ‚²ï¼‰ã€‚<br/><br/>
				V1.0.5.3<br/>1ã€ä¿®å•¦ä¿®å•¦ï¼Œé˜¿é‡Œäº‘ç›˜å¯ä»¥æ‘¸åˆ°ä¸‹è½½èœå•äº†ã€‚<br/><br/>
				V1.0.5.2<br/>1ã€å¢åŠ è„šæœ¬ä¿¡æ¯èœå•ï¼ˆæ²¡æœ‰ç”¨ï¼‰ï¼›<br/>2ã€ä¼˜åŒ–é˜¿é‡Œäº‘ç›˜æ˜¾ç¤ºsvgå›¾ç‰‡ï¼›<br/>3ã€ä¿®æ”¹å¼¹çª—æŒ‰é’®é¢œè‰²ã€‚<br/><br/>
				V1.0.5.1<br/>1ã€ä¿®å¤åœ¨åˆ‡æ¢æŒ‰é’®ä¸»é¢˜åå¤¸å…‹ç½‘ç›˜ä¸èƒ½æ­£å¸¸æ˜¾ç¤ºæŒ‰é’®ã€‚<br/><br/>
				V1.0.5<br/>1ã€è·Ÿè¿›å®˜æ–¹V5.0.4ç‰ˆæœ¬ï¼›<br/>2ã€å°æ”¹åŠ¨ï¼Œç…§ç€å®˜æ–¹ç‰ˆæœ¬æ›´æ­£æ–‡ä»¶åç§°æ£€æµ‹ï¼›<br/>3ã€ä¿ç•™å½©è›‹ï¼Œä½†å¿…é¡»èˆå¼ƒå®˜æ–¹æš—å·ã€‚<br/><br/>
				V1.0.4<br/>å¤§æ”¹ï¼<br/>1ã€ä¿®å¤äº†åŸä½œè€…ç•™ä¸‹çš„å¤¸å…‹ç½‘ç›˜åˆ‡æ¢æ–‡ä»¶å¤¹å°±å¤šä¸€ä¸ªâ€œä¸‹è½½åŠ©æ‰‹â€æŒ‰é’®çš„å¤§BUGï¼›<br/>2ã€ç»ˆäºæ¥äº†ï¼Œåœ¨ä¸‹è½½èœå•å¢åŠ â€œåŠ©æ‰‹è®¾ç½®â€â€œæ›´æ–°æ—¥å¿—â€æŒ‰é’®ï¼›<br/>ã€å†ä¹Ÿä¸ç”¨ç‚¹è¿›æ²¹çŒ´ç®¡ç†å†è¿›è®¾ç½®äº†(ä¿ç•™æ²¹çŒ´ç®¡ç†å†…è®¾ç½®)ã€‘<br/>3ã€ä¿®æ”¹é˜¿é‡Œäº‘ç›˜å’Œå¤¸å…‹ç½‘ç›˜ä¸‹è½½åŠ©æ‰‹æŒ‰é’®æ ·å¼ï¼›<br/>4ã€å¢åŠ â€œå–æ¶ˆç‚¹äº®æŒ‰é’®â€æ²¹çŒ´èœå•ï¼›<br/>5ã€ä¿®æ”¹éƒ¨åˆ†cssï¼Œä½¿å…¶ä¸é€‰æ‹©çš„ä¸»é¢˜æ›´è´´åˆ‡ã€‚<br/><br/>
				V1.0.3<br/>1ã€å¢åŠ ä¸€ä¸ªå°å½©è›‹ï¼› æç¤ºï¼š<br/>homoï¼ˆéœ€åœ¨æœªç‚¹äº®æŒ‰é’®çŠ¶æ€è§¦å‘ï¼‰<br/>ã€éœ€è¦é‡æ–°æ¢å¤æŒ‰é’®ä¸ºæœªç‚¹äº®çŠ¶æ€è¯·è¿›å…¥ å·²å®‰è£…è„šæœ¬->ç¼–è¾‘->å¼€å‘è€…->é‡ç½®åˆ°å‡ºå‚->ç¡®å®šã€‘<br/>2ã€ä¿®æ”¹/å¢åŠ é»˜è®¤ä¸»é¢˜è‰²ã€‚<br/><br/>
				V1.0.2<br/>1ã€ä¿®æ”¹å¹¶åŠ å®½ç•Œé¢ï¼Œè°ƒæ•´éƒ¨åˆ†cssï¼Œä½¿Sweetalert2ç•Œé¢æ›´ç¾è§‚ï¼Œæ›´ä¸åŸç‰ˆç›¸è¿‘ï¼›<br/>2ã€ä¿®æ”¹éƒ¨åˆ†æç¤ºæ–‡å­—ï¼Œä½¿æ–‡å­—æ›´å®¹æ˜“å¤åˆ¶ã€‚ <br/><br/>
				V1.0.1<br/>1ã€å»é™¤æ›´æ–°æç¤ºï¼›<br/>2ã€æ›´æ–°Sweetalert2è‡³11ç‰ˆæœ¬ï¼›<br/>3ã€éƒ¨åˆ†CDNèŠ‚ç‚¹æ›´æ¢ä¸ºjsdelivrã€‚<br/><br/>
				V1.0.0<br/>1ã€å¢åŠ â€œæ³¨å…¥â€åŠŸèƒ½ï¼ˆbushiï¼‰ï¼›<br/>2ã€å»é™¤å¹¿å‘Šã€‚
				</div>`,
				allowOutsideClick: false,
				showCloseButton: false,
				confirmButtonText: 'æˆ‘å·²é˜…',
				...swalDefault
			});
		},

		// åˆ›å»ºæµ®åŠ¨æ ‡ç­¾
		createTip() {
			// æ·»åŠ æç¤ºæ¡†åˆ° body
			$('body').append('<div class="pl-tooltip"></div>');

			// ç›‘å¬æ‰€æœ‰å¸¦æœ‰ .listener-tip ç±»çš„å…ƒç´ çš„é¼ æ ‡ç§»åŠ¨äº‹ä»¶
			$(document).on('mousemove', '.listener-tip', function (e) {
				// è·å–æç¤ºæ–‡å­—
				let tip = e.currentTarget.dataset.title || `${e.currentTarget.innerText} <span style="margin-left: 10px;color: ${color}">${e.currentTarget.dataset.size}</span>`;

				// è®¾ç½®æç¤ºæ¡†çš„ä½ç½®å¹¶ä½¿ç”¨ fadeIn() æ¸å˜æ˜¾ç¤º
				$('.pl-tooltip').html(tip).css({
					'left': e.pageX + 10 + 'px',
					'top': e.pageY + 20 + 'px' // å¢åŠ ä¸€äº›é—´è·
				}).show();
			});

			$(document).on('mouseleave', '.listener-tip, .pl-tooltip', function (e) {
				$('.pl-tooltip').hide();
			});
		},


		// åˆ›å»ºåŠ è½½å¼¹çª—
		createLoading() {
			return $('<div class="pl-loading"><div class="pl-loading-box"><div><div></div><div></div></div></div></div>');
		},

		// åˆ›å»ºä¸‹è½½ç”¨çš„éšè— iframe
		createDownloadIframe() {
			let $div = $('<div style="padding:0;margin:0;display:block"></div>');
			let $iframe = $('<iframe src="javascript:;" id="downloadIframe" style="display:none"></iframe>');
			$div.append($iframe);
			$('body').append($div);
		},

		// è·å–é•œåƒåˆ—è¡¨
		getMirrorList(link, mirror, thread = 2) {
			let host = new URL(link).host;
			let mirrors = [];
			for (let i = 0; i < mirror.length; i++) {
				for (let j = 0; j < thread; j++) {
					let item = link.replace(host, mirror[i]) + '&'.repeat(j);
					mirrors.push(item);
				}
			}
			return mirrors.join('\n');
		},

		// ç›‘å¬å…ƒç´ å‡ºç°å¹¶æ‰§è¡Œå›è°ƒ
		listenElement(element, callback) {
			let checkInterval = 1000; // æ£€æŸ¥å…ƒç´ çš„é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
			let wasElementFound = false; // ç”¨äºè·Ÿè¸ªå…ƒç´ æ˜¯å¦ä¹‹å‰å·²ç»æ‰¾åˆ°

			function checkElement() {
				if (document.querySelector(element)) {
					wasElementFound = true;
					callback();
				} else if (wasElementFound) {
					wasElementFound = false; // å…ƒç´ æ¶ˆå¤±åé‡ç½®æ ‡å¿—
				}

				setTimeout(checkElement, checkInterval);
			}
			checkElement();
		},

		// åˆ›å»ºåŸºç¡€æ ·å¼
		addPanLinkerStyle() {
			color = base.getValue('setting_theme_color');

			let swalcss = `
			.swal2-styled{transition: all 0.2s ease;}
			.swal2-loader{display:none;align-items:center;justify-content:center;width:2.2em;height:2.2em;margin:0 1.875em;-webkit-animation:swal2-rotate-loading 1.5s linear 0s infinite normal;animation:swal2-rotate-loading 1.5s linear 0s infinite normal;border-width:.25em;border-style:solid;border-radius:100%;border-color:${color} transparent }
			.swal2-styled.swal2-confirm{border:0;border-radius:.25em;background:initial;background-color:${color};color:#fff;font-size:1em}
			.swal2-styled.swal2-confirm:hover,.swal2-styled.swal2-deny:hover{opacity:0.8;background-image:none!important}
			.swal2-styled.swal2-confirm:focus{box-shadow:0 0 0 3px ${color}80}
			.swal2-styled.swal2-deny:focus{box-shadow:0 0 0 3px #dc374180}
			.swal2-timer-progress-bar-container{position:absolute;right:0;bottom:0;left:0;grid-column:auto;overflow:hidden;border-bottom-right-radius:5px;border-bottom-left-radius:5px}
			.swal2-timer-progress-bar{width:100%;height:.25em;background:${color}33 }
			.swal2-progress-steps .swal2-progress-step{z-index:20;flex-shrink:0;width:2em;height:2em;border-radius:2em;background:${color};color:#fff;line-height:2em;text-align:center}
			.swal2-progress-steps .swal2-progress-step.swal2-active-progress-step{background:${color} }
			.swal2-progress-steps .swal2-progress-step-line{z-index:10;flex-shrink:0;width:2.5em;height:.4em;margin:0 -1px;background:${color}}
			.swal2-popup {padding:1.25em 0 1.25em;flex-direction:column}
			.swal2-close {position:absolute;top:1px;right:1px;transition: all 0.2s ease;}
			div:where(.swal2-container) .swal2-html-container{padding: 1.3em 1.3em 0.3em;}
			div:where(.swal2-container) button:where(.swal2-close):hover {color:${color}!important;font-size:60px!important}
			div:where(.swal2-icon) .swal2-icon-content {font-family: sans-serif;}
			`;

			// å…ˆç›‘å¬é¢œè‰²æ–¹æ¡ˆå˜åŒ– Panlinker-SweetAlert2-Default
			window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
				if (e.matches) {
					// åˆ‡æ¢åˆ°æš—è‰²ä¸»é¢˜
					base.addStyle('swal-pub-style', 'style', GM_getResourceText('SwalDark'));
				} else {
					// åˆ‡æ¢åˆ°æµ…è‰²ä¸»é¢˜
					base.addStyle('swal-pub-style', 'style', GM_getResourceText('Swal'));
				}
				base.addStyle('Panlinker-SweetAlert2-User', 'style', swalcss);
			});
			// å†ä¿®æ”¹ä¸»é¢˜ Panlinker-SweetAlert2-Default
			if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
				// åˆ‡æ¢åˆ°æš—è‰²ä¸»é¢˜
				base.addStyle('swal-pub-style', 'style', GM_getResourceText('SwalDark'));
			} else {
				// åˆ‡æ¢åˆ°æµ…è‰²ä¸»é¢˜
				base.addStyle('swal-pub-style', 'style', GM_getResourceText('Swal'));
			}
			base.addStyle('Panlinker-SweetAlert2-User', 'style', swalcss);

			let uicss = `
			::-webkit-scrollbar {
				width: 8px;
				height: 8px;
				transition: all 0.2s ease;
			}

			::-webkit-scrollbar-track {
				border-radius: 10px;
				background: #fff;
			}

			::-webkit-scrollbar-thumb,
			::-webkit-scrollbar-thumb:hover {
				border-radius: 10px;
			}

			::-webkit-scrollbar-thumb {
				background-color: ${color}90 !important
			}

			::-webkit-scrollbar-thumb:hover {
				background-color: ${color}D0 !important
			}

			.swal2-popup {
				font-size: 16px
			}

			.pl-a {
				vertical-align: baseline;
				color: ${color};
			}

			.pl-a:hover {
				color: ${color}90;
			}

			.pl-popup {
				font-size: 12px;
				width: 90%;
			}

			.pl-popup a:not(.pl-btn-primary) {
				color: ${color};
			}

			.pl-popup a:hover:not(.pl-btn-primary) {
				color: ${color}90;
			}

			.pl-header {
				padding: 0;
				align-items: flex-start;
				border-bottom: 1px solid #eee;
				margin: 0 0 10px;
				padding: 0 0 5px;
			}

			.pl-title {
				font-size: 16px;
				line-height: 1;
				white-space: nowrap;
				text-overflow: ellipsis;
			}

			.pl-content {
				padding: 0;
				font-size: 12px;
			}

			.pl-main {
				background-color:${color}15;
				overflow: auto;
				border-radius: 10px;
				max-height:calc(${document.documentElement.clientHeight}px - 250px);
			}

			.pl-footer {
				font-size: 15px;
				margin-top: 10px;
				padding-top: 5px;
				color: #f56c6c;
				text-align: center;
				display: flex !important;
				align-items: center;
				justify-content: center;
			}

			.pl-item {
				display: flex;
				align-items: center;
				line-height: 22px;
				height: 50px;
				background-color: ${color}30;
				border-radius: 5px;
				margin: 8px 6px;
			}

			.pl-item-name {
				flex: 0 0 170px;
				text-align: left;
				margin: 6px;
				overflow: hidden;
				white-space: nowrap;
				text-overflow: ellipsis;
				cursor: default;
				height: 30px;
			}

			.pl-item-link {
				flex: 1;
				text-align: left;
				white-space: nowrap;
				text-overflow: ellipsis;
				cursor: pointer;
				overflow: hidden;
			}

			.pl-item-tip {
				display: flex;
				justify-content: space-between;
				flex: 1;
			}

			.pl-ext {
				display: inline-block;
				width: 44px;
				background: #999;
				color: #fff;
				height: 16px;
				line-height: 16px;
				font-size: 12px;
				border-radius: 3px;
			}

			.pl-retry {
				padding: 3px 10px;
				background: #cc3235;
				color: #fff;
				border-radius: 3px;
				cursor: pointer;
			}

			.pl-browserdownload {
				padding: 3px 10px;
				background: ${color};
				color: #fff;
				border-radius: 3px;
				cursor: pointer;
			}

			.pl-item-progress {
				display: flex;
				flex: 1;
				align-items: center
			}

			.pl-progress {
				display: inline-block;
				vertical-align: middle;
				width: 100%;
				box-sizing: border-box;
				line-height: 1;
				position: relative;
				height: 20px;
				margin: 0 6px;
				flex: 1
			}

			.pl-progress-outer {
				height: 20px;
				border-radius: 100px;
				background-color: #c1c1c1a1;
				overflow: hidden;
				position: relative;
				vertical-align: middle;
			}

			.pl-progress-inner {
				position: absolute;
				left: 0;
				top: 0;
				background-color: ${color};
				border-radius: 100px;
				line-height: 1;
				white-space: nowrap;
				transition: width .6s ease;
				height: 20px;
				display: inline-flex;
				text-align: center;
				align-items: center
			}

			.pl-progress-inner-text {
				display: inline-block;
				vertical-align: middle;
				cursor: default;
				color: #ffffff;
				font-size: 12px;
				margin: 0 5px;
				height: 20px;
				width: 100%;
			}

			.pl-progress-how {
				flex: 0 0 100px;
				background: #ddd;
				border-radius: 3px;
				margin-left: 10px;
				cursor: pointer;
				text-align: center;
				color: #000;
			}

			.pl-progress-inner-text:after {
				display: inline-block;
				content: "";
				height: 100%;
				vertical-align: middle;
			}

			.pl-btn-primary {
				background: ${color};
				border: 0;
				border-radius: 4px;
				color: #ffffff;
				cursor: pointer;
				font-size: 12px;
				outline: none;
				display: flex;
				align-items: center;
				justify-content: center;
				margin: 6px 6px;
				padding: 0.625em 1.1em;
				transition: 0.3s opacity;
			}

			.pl-btn-primary:hover {
				opacity: 0.8;
				transition: 0.3s opacity;
			}

			.pl-btn-primary:focus{
				box-shadow:0 0 0 3px ${color}80;
			}

			.pl-btn-success {
				background: #55af28;
			}

			.pl-btn-success:focus{
				box-shadow:0 0 0 3px #55af2880;
			}

			.pl-btn-info {
				background: #606266;
			}

			.pl-btn-info:focus{
				box-shadow:0 0 0 3px #60626680;
			}

			.pl-btn-warning {
				background: #da9328;
			}

			.pl-btn-warning:focus{
				box-shadow:0 0 0 3px #da932880;
			}

			.pl-btn-danger {
				background: #cc3235;
			}

			.pl-btn-danger:focus{
				box-shadow:0 0 0 3px #cc323580;
			}

			.pl-btn-opacity {
				animation: easeOpacity 1.2s 2;
				animation-fill-mode: forwards
			}

			.pl-button-mini {
				padding: 5px 10px;
			}

			.pl-dropdown-menu-item {
				height: 30px;
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				color: ${color};
				transition: all 0.2s ease;
			}

			.pl-dropdown-menu-item:hover {
				background-color: ${color}15;
			}

			.pl-button-mode {
				padding: 0px;
				padding-left: 0px !important;
				color: ${color} !important;
				transition: all 0.2s ease;
			}

			.pl-button-mode:hover {
				background-color: ${color}33 !important;
			}

			.g-button-menu.pl-button-mode {
				padding: 0px !important;
			}

			.pl-button,
			.pl-dropdown-menu {
				transition: all 0.2s ease;
			}

			.pl-button .pl-dropdown-menu {
				/*display: none;*/
				opacity: 0;
				pointer-events: none;
			}

			.pl-button:hover .pl-dropdown-menu {
				/*display: block;*/
				opacity: 1;
				pointer-events: auto;
			}

			.pl-button-init {
				opacity: 0.5;
				animation: easeInitOpacity 1.2s 3;
				animation-fill-mode: forwards
			}

			@keyframes easeInitOpacity {
				from {
					opacity: 0.5;
				}

				50% {
					opacity: 1
				}

				to {
					opacity: 0.5;
				}
			}

			@keyframes easeOpacity {
				from {
					opacity: 1;
				}

				50% {
					opacity: 0.35
				}

				to {
					opacity: 1;
				}
			}

			.baidu-button {
				background: ${color} !important;
				border-color: ${color} !important;
				border: 1px solid ${color} !important;
				display: inline-flex;
			}

			.baidu-button:hover {
				background: ${color}b0 !important;
				border-color: ${color} !important;
			}

			header[style="display: none;"]~.pl-button {
				display: inline-block;
				position: fixed;
				top: 0.6em;
				left: 65%;
				z-index: 99999;
			}

			.ali-button {
				background: ${color};
				border: 0 solid transparent;
				font-size: 14px;
				margin-left: 20px;
				padding: 8px 16px;
				position: relative;
				height: 32px;
				border-radius: 100px;
				display: flex;
				align-items: center;
				justify-content: center;
				color: var(--basic_white);
				cursor: pointer;
				transition: all .3s ease;
			}

			.ali-button:hover {
				background: ${color}D0
			}

			.ali-btn-icon {
				vertical-align: -0.2em;
			}

			.tcloud-button {
				color: #fff;
				border: 1px solid ${color};
				background: ${color};

				position: relative;
				height: 30px;
				padding: 0 12px;
				margin-right: 12px;
				font-size: 12px;
				line-height: 28px;
				cursor: pointer;
			}

			.tcloud-button:hover {
				border-color: ${color}b0;
				background: ${color}b0;
			}

			.mcloud-button {
				float: left;
				position: relative;
				margin: 20px 24px 20px 0;
				width: 110px;
				height: 36px;
				background: ${color};
				border-radius: 2px;
				font-size: 14px;
				color: #fff;
				line-height: 39px;
				text-align: center;
				cursor: pointer;
			}

			.mcloud-share-button {
				display: inline-block;
				position: relative;
				font-size: 14px;
				line-height: 36px;
				height: 36px;
				text-align: center;
				color: #fff;
				border: 1px solid ${color};
				border-radius: 2px;
				padding: 0 24px;
				background: ${color};
			}

			.mcloud-share-button:hover {
				background: ${color}b0;
			}

			.mcloud-button:hover {
				background: ${color}b0;
			}

			.mcloud-btn {
				background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAMAAAC7IEhfAAAAAXNSR0IB2cksfwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAGNQTFRFAAAA////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////mkUNoAAAACF0Uk5TAAbHPP9AMRtr9PwrV8zqXfmNgDODHTLD4iJxhGJJ8Z269m0aDgAAAMZJREFUeJzd0ssOgyAQBVDUK74rWq0PFP3/ryxqTMdGqJtuvGHD5CTDTGDs3nFc17kEPcC7BH3At/Tjvk5AYbBU+NcrwghL4uQDk3gtRSF1KWCCQEpghkd+3jp/ICNQoDANU0AQCJQmWAJ3h8+q3mFdvSywQdttsGvRWGAPLReoHXrbG6WWAzBoJ+3DaCnWI39NLbcvszvLeuTB2fYoqbNBNo7sGjzk31BhMsEJitxmiKk8zSQwE8gFjBGcNuCzOmdqPrib5A2JRQ7qK9g+hQAAAABJRU5ErkJggg==);
				height: 20px;
				line-height: 20px;
				display: inline-block;
				background-repeat: no-repeat;
				background-size: 20px 20px;
				text-indent: 25px;
			}

			.xunlei-button {
				display: inline-flex;
				align-items: center;
				justify-content: center;
				border: 0 solid transparent;
				border-radius: 5px;
				box-shadow: 0 0 0 0 transparent;
				width: fit-content;
				white-space: nowrap;
				flex-shrink: 0;
				font-size: 14px;
				line-height: 1.5;
				outline: 0;
				touch-action: manipulation;
				transition: background .3s ease, color .3s ease, border .3s ease, box-shadow .3s ease;
				color: #fff;
				background: ${color};
				margin-left: 12px;
				padding: 0px 12px;
				position: relative;
				cursor: pointer;
				height: 36px;
			}

			.xunlei-button:hover {
				background: ${color}b0;
			}

			.quark-button {
				background: ${color} !important;
				background-color:${color} !important;
			}

			.quark-button:hover {
				background: ${color}b0 !important;
				background-color:${color}b0 !important;
			}

			.quark-btn-icon {
				width: 20px;
				height: 20px;
				vertical-align: -0.3em;
			}

			.element-clicked {
				opacity: 0.5;
			}

			.pl-extra {
				margin-top: 10px;
				background-color:${color}15;
				border-radius: 10px;
				display: flex
			}

			.pl-extra button {
				flex: 1
			}

			.pointer {
				cursor: pointer
			}

			.pl-setting-label {
				display: flex;
				align-items: center;
				justify-content: space-between;
				padding-top: 10px;
			}

			.pl-label {
				flex: 0 0 100px;
				text-align: left;
			}

			.pl-input {
				flex: 1;
				padding: 8px 10px !important;
				border: 1px solid #c2c2c2;
				border-radius: 5px;
				font-size: 14px !important;
				min-width: 300px;
				margin: 0;
				darktheme
			}

			.init-input {
				width: 400px;
				margin: 1em 1em 3px;
				font-size: 20px;
				text-align: center;
				font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", sans-serif;
				font-weight: 300;
			}

			.pl-color {
				flex: 1;
				display: flex;
				flex-wrap: wrap
			}

			.pl-color-box {
				width: 55px;
				height: 55px;
				margin: 10px 10px 0 0;
				box-sizing: border-box;
				border: 1px solid #fff;
				cursor: pointer
			}

			.pl-mask {
				width: 53px;
				height: 53px;
				opacity: 0;
				transition: opacity 0.3s;
				color: #fff;
				font-size: 13px;
				display: flex;
				align-items: center;
				justify-content: center;
				flex-direction: column;
			}

			.pl-color-box:hover .pl-mask {
				opacity: 1;
			}

			.pl-close:focus {
				outline: 0;
				box-shadow: none;
			}

			.tag-danger {
				color: #cc3235;
				margin: 0 5px;
			}

			.pl-tooltip {
				position: absolute;
				color: #ffffff;
				max-width: 600px;
				font-size: 12px;
				padding: 5px 10px;
				background: #333;
				border-radius: 5px;
				z-index: 110000;
				line-height: 1.3;
				display: none;
				word-break: break-all;
			}

			@keyframes load {
				0% {
					transform: rotate(0deg)
				}

				100% {
					transform: rotate(360deg)
				}
			}

			.pl-loading-box>div>div {
				position: absolute;
				border-radius: 50%;
			}

			.pl-loading-box>div>div:nth-child(1) {
				top: 9px;
				left: 9px;
				width: 82px;
				height: 82px;
				background: #ffffff;
			}

			.pl-loading-box>div>div:nth-child(2) {
				top: 14px;
				left: 38px;
				width: 25px;
				height: 25px;
				background: #666666;
				animation: load 1s linear infinite;
				transform-origin: 12px 36px;
			}

			.pl-loading {
				width: 16px;
				height: 16px;
				display: inline-block;
				overflow: hidden;
				background: none;
			}

			.pl-loading-box {
				width: 100%;
				height: 100%;
				position: relative;
				transform: translateZ(0) scale(0.16);
				backface-visibility: hidden;
				transform-origin: 0 0;
			}

			.pl-loading-box div {
				box-sizing: content-box;
			}

			.pl-dropdown-menu {
				position: absolute;
				padding: 5px 0;
				color: ${color};
				background: themecolor;
				z-index: 999;
				width: 110px;
				border-radius: 5px;
				box-shadow: 0 1px 6px ${color}33;
				-webkit-box-shadow: 0 1px 6px ${color}33;
				text-align: center;
				border: none;
				transition: all 0.2s ease;
			}

			.pl-button-save {
				background-color: ${color} !important;
				color:#fff !important;
			}

			.pl-button-save:hover {
				background-color: ${color}D0 !important;
				color:#fff !important;
			}

			.swal2-container {
				z-index: 100000;
			}

			body.swal2-height-auto {
				height: inherit;
			}

			svg.icon-rpc-devices {
				width: 13px;
				height: 13px;
			}

			[class^="swal2-"], [class*="pl-btn"] {
				transition:all 0.3s ease;
			}

			/* é€‚é…ï¼ˆæ”¹ï¼‰ç™¾åº¦ç½‘ç›˜ä¼šå‘˜é’æ˜¥ç‰ˆ */
			a.downloadSubtitle, button.downloadSubtitle {
				transition:all 0.3s ease;
				background-color: ${color};
			}

			a.downloadSubtitle:hover, button.downloadSubtitle:hover {
				background-color: ${color}D0;
			}

			a.downloadSubtitle:disabled, button.downloadSubtitle:disabled {
				background-color: ${color}D0;
			}

			@media (prefers-color-scheme: dark) [data-theme=system] * {
				color-scheme: dark;
			}

			/* RGB! */
			@keyframes hue-rotate {
				0% {
					filter: hue-rotate()
				}

				to {
					filter: hue-rotate(-360deg)
				}
			}

			/* Webkit, Opera, IE9, Chrome*/
			::selection {
				background-color: ${color} !important;
				background: ${color} !important;
				color: white !important;
			}

			/* Mozilla Firefox */
			::-moz-selection {
				background-color: ${color} !important;
				background: ${color} !important;
				color: white !important;
			}

			/* ç™¾åº¦ç½‘ç›˜ */
			:not([class*="rwl-exempt"]) ::selection {
				background-color: ${color} !important;
				background: ${color} !important;
				color: white !important;
			}
			`;
			// å…ˆç›‘å¬é¢œè‰²æ–¹æ¡ˆå˜åŒ–
			window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
				if (e.matches) {
					// åˆ‡æ¢åˆ°æš—è‰²ä¸»é¢˜
					let dark = uicss.replace("themecolor", "#19191a").replace("darktheme", "color-scheme: dark;");
					base.addStyle('Panlinker-UI', 'style', dark);
				} else {
					// åˆ‡æ¢åˆ°æµ…è‰²ä¸»é¢˜
					let light = uicss.replace("themecolor", "#fff").replace("darktheme", "");
					base.addStyle('Panlinker-UI', 'style', light);
				}
			});
			// å†ä¿®æ”¹ä¸»é¢˜
			if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
				let dark = uicss.replace("themecolor", "#19191a").replace("darktheme", "color-scheme: dark;");
				base.addStyle('Panlinker-UI', 'style', dark);
			} else {
				// åˆ‡æ¢åˆ°æµ…è‰²ä¸»é¢˜
				let light = uicss.replace("themecolor", "#fff").replace("darktheme", "");
				base.addStyle('Panlinker-UI', 'style', light);
			}

			if (/(pan|yun).baidu.com/.test(location.host) && location.pathname !== '/disk/home' && base.getValue('setting_theme_baidu') === 'yes') {
				base.setColors([
					['#717fff', `${color}`],
					['#717FFF', `${color}`],
					['#06a8ff', `${color}`],
					['#06A8FF', `${color}`],
					['#06a7ff', `${color}`],
					['#06A7FF', `${color}`],
					['#dcdfe6', `${color}`],
					['#DCDFE6', `${color}`],
					['#0095ff', `${color}`],
					['#0095FF', `${color}`],
					['#09aaff', `${color}`],
					['#09AAFF', `${color}`],
					['#0ca6ff', `${color}`],
					['#0CA6FF', `${color}`],
					['#5040ff', `${color}`],
					['#5040FF', `${color}`],
					['#454d5a', `${color}`],
					['#454D5A', `${color}`],
					['#a2abbd', `${color}`],
					['#A2ABBD', `${color}`],
					['#030b1a', `${color}`],
					['#030B1A', `${color}`],
					['#afb3bf', `${color}`],
					['#AFB3BF', `${color}`],
					['#ff436a', `${color}`],
					['#FF436A', `${color}`],
					['#03081a', `${color}`],
					['#03081A', `${color}`],
					['#2974b6', `${color}`],
					['#2974B6', `${color}`],
					['#0596e6', `${color}`],
					['#0596E6', `${color}`],

					['#C3EAFF', `${color}`],
					['#c0d9fe', `${color}50`],
					['#0098EA', `${color}D0`],

					['#38b9ff', `${color}D0`],
					['#38B9FF', `${color}D0`],
					['#42d8ff', `${color}D0`],
					['#42D8FF', `${color}D0`],
					['#a48dff', `${color}D0`],
					['#A48DFF', `${color}D0`],
					['#6b79f2', `${color}D0`],
					['#6B79F2', `${color}D0`],

					['#9c86f2', `${color}90`],
					['#9C86F2', `${color}90`],
					['#83d3ff', `${color}90`],
					['#83D3FF', `${color}90`],
					['#C4D8F4', `${color}90`],

					['#fafafc', `${color}20`],
					['#FAFAFC', `${color}20`],
					['#f5fbff', `${color}20`],
					['#F5FBFF', `${color}20`],
					['#b4e5ff', `${color}20`],
					['#B4E5FF', `${color}20`],
					['#f0faff', `${color}20`],
					['#F0FAFF', `${color}20`],
					['#c4d8f4', `${color}20`],

					['#f1f3f8', `${color}15`],
					['#F1F3F8', `${color}15`],

					['#f2faff', `${color}10`],
					['#F2FAFF', `${color}10`],
					['#eef9fe', `${color}10`],
					['#EEF9FE', `${color}10`],
					['#f7f9fc', `${color}10`],
					['#F7F9FC', `${color}10`],
					['#f5f6fa', `${color}10`],
					['#F5F6FA', `${color}10`],
					['#b4e5ff', `${color}10`],
					['#B4E5FF', `${color}10`],
					['#e6f6ff', `${color}10`],
					['#E6F6FF', `${color}10`],

					['0,149,255', base.hexToRgba(color)],
					['30, 175, 255', base.hexToRgba(color)],
					['6, 167, 255, 0.1', base.hexToRgba(`${color}1a`)],
					['6,167,255,.1', base.hexToRgba(`${color}1a`)],
					['6,167,255,.23', base.hexToRgba(`${color}3b`)],
					['164,141,255,.2', base.hexToRgba(`${color}30`)],
					['196,182,255,.2', base.hexToRgba(`${color}20`)],
					['113,127,255,.2', base.hexToRgba(`${color}40`)],
					['3,8,26,.6', base.hexToRgba(`${color}D0`)],
					['255,32,102,.4', base.hexToRgba(`${color}66`)],
					['72,166,248,.7', base.hexToRgba(`${color}66`)],
				]);
			};
			if (/(pan|yun).baidu.com/.test(location.host) && base.getValue('setting_theme_baidu') === 'yes') {
				base.addStyle('Panlinker-UI-Baidu', 'style', `
				#layoutMain,
				.DxdbeCb {
					border-radius: 10px;
					border-bottom-left-radius: 0;
					border-bottom-right-radius: 0;
					background: #ffffffA0 !important
				}
				.KPDwCE,
				.DxdbeCb .OFaPaO .tanwePYr,
				.xGLMIab .fufHyA:hover,
				.module-search-timeline .form-box {
					background: #ffffffA0 !important;
				}
				.KPDwCE .JDeHdxb,
				.NHcGw .AuPKyz,
				.xGLMIab .tvPMvPb,
				.xGLMIab .FcQMwt,
				.cazEfA .yfHIsP,
				.hscjZ4QL .bbxnZ0Bq .ehnyLxWZ span,
				.module-topToolBar,
				.module-timeline-view .timeline-title-curday {
					background: transparent !important;
					border-bottom: 0;
				}
				.MdLxwM {
					background :#fff !important;
				}
				.aside-absolute-container {
					position: absolute !important;
				}
				.aside-absolute-container .QGOvsxb .remainingSpaceUi_span {
					background: #8af248 !important;
					border-radius: 10px 0 0 10px;
					border-right: #fff 1px solid;
					border-bottom: #fff 1px solid;
				}
				.xtJbHcb .CDaavKb .KQcHyA {
					background: rgb(244,207,0) !important;
					padding: 8px 15px;
				}
				.xtJbHcb .web-header-nav-new-version-inner {
					background: ${color} !important;
					padding: 8px 15px;
					line-height: 15px;
					width: auto;
					height: auto;
				}
				a {
					transition: all 0.2s ease !important;
				}
				#bd-main .bd-left {
					margin: auto !important;
				}
				.verify-input input {
					padding-left: 0 !important;
					text-align: center !important;
				}
				.verify-input input:focus {
					border: 2px solid ${color} !important;
				}
				[data-theme=light] .vp-video-page-card .vp-video-page-card__video-detail {
					color: #030b1a;
				}
				dt.level-1 {
					background: #fd6d65 !important;
				}
				dt.level-2 {
					background: #f3a723 !important;
				}
				dt.level-1 i.desc-arrow {
					border-bottom: 10px solid #dd6966 !important;
				}
				dt.level-2 i.desc-arrow {
					border-bottom: 10px solid #d29633 !important;
				}
				`, 'body');
				base.setColors([
					['#717fff', `${color}`],
					['#717FFF', `${color}`],
					['#06a8ff', `${color}`],
					['#06A8FF', `${color}`],
					['#06a7ff', `${color}`],
					['#06A7FF', `${color}`],
					['#dcdfe6', `${color}`],
					['#DCDFE6', `${color}`],
					['#0095ff', `${color}`],
					['#0095FF', `${color}`],
					['#09aaff', `${color}`],
					['#09AAFF', `${color}`],
					['#0ca6ff', `${color}`],
					['#0CA6FF', `${color}`],
					['#5040ff', `${color}`],
					['#5040FF', `${color}`],
					['#454d5a', `${color}`],
					['#454D5A', `${color}`],
					['#a2abbd', `${color}`],
					['#A2ABBD', `${color}`],
					['#030b1a', `${color}`],
					['#030B1A', `${color}`],
					['#afb3bf', `${color}`],
					['#AFB3BF', `${color}`],
					['#ff436a', `${color}`],
					['#FF436A', `${color}`],
					['#03081a', `${color}`],
					['#03081A', `${color}`],
					['#2974b6', `${color}`],
					['#2974B6', `${color}`],
					['#0596e6', `${color}`],
					['#0596E6', `${color}`],

					['#C3EAFF', `${color}`],
					['#c0d9fe', `${color}50`],
					['#0098EA', `${color}D0`],

					['#38b9ff', `${color}D0`],
					['#38B9FF', `${color}D0`],
					['#42d8ff', `${color}D0`],
					['#42D8FF', `${color}D0`],
					['#a48dff', `${color}D0`],
					['#A48DFF', `${color}D0`],
					['#6b79f2', `${color}D0`],
					['#6B79F2', `${color}D0`],

					['#9c86f2', `${color}90`],
					['#9C86F2', `${color}90`],
					['#83d3ff', `${color}90`],
					['#83D3FF', `${color}90`],
					['#C4D8F4', `${color}90`],

					['#fafafc', `${color}20`],
					['#FAFAFC', `${color}20`],
					['#f5fbff', `${color}20`],
					['#F5FBFF', `${color}20`],
					['#b4e5ff', `${color}20`],
					['#B4E5FF', `${color}20`],
					['#f0faff', `${color}20`],
					['#F0FAFF', `${color}20`],
					['#c4d8f4', `${color}20`],

					['#f1f3f8', `${color}15`],
					['#F1F3F8', `${color}15`],

					['#f2faff', `${color}10`],
					['#F2FAFF', `${color}10`],
					['#eef9fe', `${color}10`],
					['#EEF9FE', `${color}10`],
					['#f7f9fc', `${color}10`],
					['#F7F9FC', `${color}10`],
					['#f5f6fa', `${color}10`],
					['#F5F6FA', `${color}10`],
					['#b4e5ff', `${color}10`],
					['#B4E5FF', `${color}10`],
					['#e6f6ff', `${color}10`],
					['#E6F6FF', `${color}10`],

					['0,149,255', base.hexToRgba(color)],
					['30, 175, 255', base.hexToRgba(color)],
					['6, 167, 255, 0.1', base.hexToRgba(`${color}1a`)],
					['6,167,255,.1', base.hexToRgba(`${color}1a`)],
					['6,167,255,.23', base.hexToRgba(`${color}3b`)],
					['164,141,255,.2', base.hexToRgba(`${color}30`)],
					['196,182,255,.2', base.hexToRgba(`${color}20`)],
					['113,127,255,.2', base.hexToRgba(`${color}40`)],
					['3,8,26,.6', base.hexToRgba(`${color}D0`)],
					['255,32,102,.4', base.hexToRgba(`${color}66`)],
					['72,166,248,.7', base.hexToRgba(`${color}66`)],
				], "other");
			};
			if (/www.(aliyundrive|alipan).com/.test(location.host) && base.getValue('setting_theme_ali') === 'yes') {
				base.setColors([
					['#3763ff', `${color}`],
					['#8664ff', `${color}D0`],
					['99, 125, 255', base.hexToRgba(color)],
					['132, 133, 141', base.hexToRgba(color)],
					['112, 136, 255', base.hexToRgba(color)],
					['97, 122, 250', base.hexToRgba(color)],
					['68, 109, 255', base.hexToRgba(color)],
					['82, 110, 250', base.hexToRgba(`${color}20`)],
					['122, 144, 255', base.hexToRgba(`${color}D0`)],
					['138, 157, 255', base.hexToRgba(`${color}D0`)],
					//['49, 49, 54', base.hexToRgba(color)],
				]);
			};
			if (/cloud.189.cn/.test(location.host) && base.getValue('setting_theme_tcloud') === 'yes') {
				base.setColors([
					['#2b89ea', `${color}`],
					['#1874d3', `${color}F0`],
					['#1890ff', `${color}`],
					['#388fc9', `${color}`],
					['#0087ff', `${color}`],
					['#255697', `${color}`],
					['#3ea6ff', `${color}80`],
					['#1d52f2', `${color}`],
					['#3699ff', `${color}D0`],
					['#f4f9fe', `${color}10`],
					['#eaf5ff', `${color}20`],
				], "other");
			}
			if (/pan.xunlei.com/.test(location.host) && base.getValue('setting_theme_xunlei') === 'yes') {
				base.setColors([
					['#3f85ff', `${color}`],
					['63,133,255,.1', base.hexToRgba(`${color}20`)],
					['#2670ea', `${color}D0`],
					['#619bff', `${color}D0`],
					['#ecf3ff', `${color}10`],
					['#f6faff', `${color}10`],
					['#1a2845', `${color}20`],
					['#eee', `${color}20`],
				], "other");
				base.addStyle('Panlinker-UI-Xunlei', 'style', `
					.web-header {
						background: linear-gradient(0deg,${color}D0,${color})
					}
				`);
			};
			if (/pan.quark.cn/.test(location.host) && base.getValue('setting_theme_quark') === 'yes') {
				base.setColors([
					['#0d53ff', `${color}`],
					['#e6f1ff', `${color}20`],
					['#f0faff', `${color}20`],
					['#7da3ff', `${color}D0`],
					['#ddd', `${color}D0`],
					['17,17,17,.9', base.hexToRgba(`${color}D0`)],
					['40,40,255,.04', base.hexToRgba(`${color}20`)],
					['#f7f7ff', 'transparent'],
					['238,247,255,0', base.hexToRgba(`${color}00`)],
				]);
				base.addStyle('Panlinker-UI-Quark', 'style', `
				.file-list .hover-oper .hover-transparent-bg {
					background: transparent !important;
				}
				`);
			};
			if (/(yun|caiyun).139.com/.test(location.host) && base.getValue('setting_theme_mcloud') === 'yes') {
				base.setColors([
					['#3181f9', `${color}`],
					['#5a9afa', `${color}`],
					['#98c0fc', `${color}D0`],
					['#2d76e5', `${color}D0`],
					['49,129,249,.08', base.hexToRgba(`${color}20`)],
				]);
			};
			if (/.*.youxiaohou.com/.test(location.host)) {
				base.setColors([
					['#00aefe', `${color}`],
					['#4e6e8e', `${color}`],
					['#009fe8', `${color}`],
					['#008fd1', `${color}`],
					['#05b0ff', `${color}D0`],
				], "other");
				base.addStyle('Panlinker-UI-Youxiaohou', 'style', `
					a[aria-label="View source on GitHub"] svg[style^="fill"] {
						fill: ${color} !important;
					}
				`);
			};
		},

		// æš—å·ç•Œé¢
		async initDialog() {
			let dialog = await Swal.fire({
				title: `è¯·é˜…è¯»å®Œä»¥ä¸‹å…¨æ–‡å†ç»§ç»­`,
				allowOutsideClick: false,
				showCloseButton: true,
				showDenyButton: true,
				confirmButtonText: 'ç¡®è®¤',
				denyButtonText: 'æ‡’å¾—è¾“å…¥...æˆ‘è¦ç›´æ¥ç‚¹äº®ï¼',
				html: `
				<div>
					${config.base.service.account ? `<img style="width: 250px;margin-bottom: 10px;" src="${config.base.service.account}">` : ``}
					<input class="swal2-input init-input" id="init" type="text" placeholder="è¾“å…¥å†…å®¹..."></div>
					<div><span>ä½ å¿ƒæƒ³é“: â€œæ²¡ä»€ä¹ˆå¯ä»¥è¾“å…¥çš„â€</span>
				</div>
				<div>â†“</div>
				<div>ä½†ä½ ä¸çŸ¥é“çš„æ˜¯...</div>
				<div>ä½ å¯ä»¥ç›´æ¥æŒ‰ä¸‹ä¸‹æ–¹çš„<span style="color:red;font-style:italic;vertical-align:unset;">çº¢è‰²æŒ‰é’®</span>æ¥è·³è¿‡è¿™ä¸€æœ‰è¶£çš„æµç¨‹</div>
				<div>æˆ–è€…ç»§ç»­æµç¨‹,è¾“å…¥æŸäº›<span style="font-style:italic;vertical-align:unset;">æ¶è‡­çš„æ•°å­—</span>æŸ¥çœ‹å½©è›‹å¹¶ç‚¹äº®</div>
				<div>â†“</div>
				<div><a target="_blank" href="https://www.youxiaohou.com" style="vertical-align:unset;">åŸä½œè€…</a>å¼€å‘å¾ˆè¾›è‹¦,æ‰€ä»¥è¯·æœ‰èƒ½åŠ›çš„ä½ è¯·æ”¯æŒä¸‹ä»–çš„å…¬ä¼—å·</div>
				<div>åˆæˆ–è€…...æ¥ç»™è¿™ä¸ªæ”¹ç‰ˆç‚¹ä¸ª<a href="https://github.com/hmjz100/LinkSwift/" style="vertical-align:unset;">Star</a>ï¼Ÿ</div>
				<div>ç‚¹äº®åä¸ä»…èƒ½ç²¾ç®€ç½‘ç›˜ç•Œé¢ è¿˜èƒ½æ”¹å˜ä¼—å¤šç½‘ç›˜ä¸»é¢˜è‰²å“¦!</div>
				`,
				...swalDefault
			});
			if (dialog.isDenied) {
				console.log("ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘\næ­£åœ¨â€œæ³¨å…¥â€ç‚¹äº®æŒ‰é’®è®¾ç½®é¡¹ç›®...");
				message.warning("æ­£åœ¨â€œæ³¨å…¥â€è®¾ç½®é¡¹ç›®...");
				await base.sleep(2500);
				base.setValue('setting_init_code', config.base.num);
				base.setValue('setting_init_license', config.base.license);
				message.success("â€œæ³¨å…¥â€æˆåŠŸäº†!");
				await base.sleep(1500);
				location.reload();
			};
			if (dialog.isConfirmed) {
				if ($('#init').val() === '114514' || $('#init').val() === '1919810' || $('#init').val() === '1145141919810') {
					/*---
						homoå½©è›‹åˆå›æ¥åŠ›ï¼ˆå–œï¼‰
						imageUrl: 'https://pic4.zhimg.com/80/v2-1b97a088e156c015108dec663bba8b04.jpg',
						imageUrl: 'https://lh1.hetaousercontent.com/img/7d4c1c0b4adb0e95.jpg',
					*/
					await Swal.fire({
						icon: 'error',
						title: '1145141919810',
						html: '<span>homoç‰¹æœ‰çš„æ•°å­—å½“ç„¶ä¸è¡Œå•¦<br/>å“¼å“¼å“¼å•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Š</span>',
						timer: 4000,
						imageUrl: 'https://pic1.zhimg.com/v2-1b97a088e156c015108dec663bba8b04.avis',
						allowOutsideClick: false,
						timerProgressBar: true,
						showConfirmButton: false,
						showDenyButton: true,
						denyButtonText: 'å“¼å“¼å“¼å•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Š',
						...swalDefault
					});
					message.info("æˆå°±ï¼šä½ è§¦å‘äº†ä¸€ä¸ªhomoç‰¹æœ‰çš„å½©è›‹ï¼");
					await base.sleep(4000)
					Swal.fire({
						title: '1145141919810',
						text: 'homoç‰¹æœ‰çš„æ•°å­—å½“ç„¶ä¸è¡Œå•¦...å—ï¼Ÿ',
						icon: 'question',
						imageUrl: 'https://lh1.hetaousercontent.com/img/7d4c1c0b4adb0e95.jpg',
						showConfirmButton: false,
						allowOutsideClick: false,
						...swalDefault
					});
					await base.sleep(3000)
					base.setValue('setting_init_code', config.base.num);
					base.setValue('setting_init_license', config.base.license);
					message.success("æˆå°±ï¼šå“¼å“¼å“¼å•Šå•Šå•Šå•Šå•Šå•Šå•Šå•Šåœ°æ³¨å…¥æˆåŠŸ(å–œ)");
					await base.sleep(1500)
					location.reload();
				} else {
					console.log("ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘\næš—å·é”™è¯¯")
					await this.initDialog();
					return;
				};
			}
		},
		/*--- waitForKeyElements(): ä¸€ä¸ªå®ç”¨å‡½æ•°ï¼Œç”¨äº Greasemonkey è„šæœ¬ï¼Œ
		å®ƒå¯ä»¥æ£€æµ‹å’Œå¤„ç†AJAXåŠ è½½çš„å†…å®¹ã€‚
		ä½¿ç”¨ç¤ºä¾‹ï¼š
			base.waitForKeyElements (
				"div.comments"
				, commentCallbackFunction
			);
			// é¡µé¢ç‰¹å®šçš„å‡½æ•°ï¼Œç”¨äºåœ¨æ‰¾åˆ°èŠ‚ç‚¹æ—¶æ‰§è¡Œæˆ‘ä»¬æƒ³è¦çš„æ“ä½œã€‚
			function commentCallbackFunction (jNode) {
				jNode.text ("waitForKeyElements() æ›´æ”¹äº†è¿™æ®µæ³¨é‡Šã€‚");
			}
		é‡è¦æç¤ºï¼šè¿™ä¸ªå‡½æ•°éœ€è¦ä½ çš„è„šæœ¬åŠ è½½äº†jQueryã€‚
		*/
		waitForKeyElements(selectorTxt, actionFunction, bWaitOnce, iframeSelector) {
			let targetNodes, btargetsFound;

			if (typeof iframeSelector == "undefined")
				targetNodes = $(selectorTxt);
			else
				targetNodes = $(iframeSelector).contents()
					.find(selectorTxt);

			if (targetNodes && targetNodes.length > 0) {
				btargetsFound = true;
				targetNodes.each(function () {
					let jThis = $(this);
					let alreadyFound = jThis.data('alreadyFound') || false;

					if (!alreadyFound) {
						//--- è°ƒç”¨è½½è·å‡½æ•°ã€‚
						let cancelFound = actionFunction(jThis);
						if (cancelFound) {
							btargetsFound = false;
						} else {
							jThis.data('alreadyFound', true);
						}
					}
				});
			} else {
				btargetsFound = false;
			}

			//--- è·å–è¿™ä¸ªé€‰æ‹©å™¨çš„å®šæ—¶å™¨æ§åˆ¶å˜é‡ã€‚
			let controlObj = base.waitForKeyElements.controlObj || {};
			let controlKey = selectorTxt.replace(/[^\w]/g, "_");
			let timeControl = controlObj[controlKey];

			//--- ç°åœ¨æ ¹æ®æƒ…å†µè®¾ç½®æˆ–æ¸…é™¤å®šæ—¶å™¨ã€‚
			if (btargetsFound && bWaitOnce && timeControl) {
				//--- å”¯ä¸€éœ€è¦æ¸…é™¤å®šæ—¶å™¨çš„æƒ…å†µã€‚
				clearInterval(timeControl);
				delete controlObj[controlKey]
			} else {
				//--- å¦‚æœéœ€è¦çš„è¯ï¼Œè®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ã€‚
				if (!timeControl) {
					timeControl = setInterval(function () {
						base.waitForKeyElements(selectorTxt, actionFunction, bWaitOnce, iframeSelector);
					}, 1000);
					controlObj[controlKey] = timeControl;
				}
			}
			base.waitForKeyElements.controlObj = controlObj;
		},
	};

	//ç™¾åº¦ç½‘ç›˜
	let baidu = {
		_getExtra() {
			let seKey = decodeURIComponent(base.getCookie('BDCLND'));
			return '{' + '"sekey":"' + seKey + '"' + "}";
		},

		_getSurl() {
			let reg = /(?<=s\/|surl=)([a-zA-Z0-9_-]+)/g;
			if (reg.test(location.href)) {
				return location.href.match(reg)[0];
			}
			return '';
		},

		setBDUSS() {
			try {
				GM_cookie('list', { name: 'BDUSS' }, (cookies, error) => {
					if (!error) {
						let BDUSS = cookies?.[0]?.value;
						if (BDUSS) {
							base.setStorage("baiduyunPlugin_BDUSS", { BDUSS });
						}
					} else {
						throw new Error(error)
					}
				});
			} catch (e) {
				console.error("ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘\nsetBDUSS\né”™è¯¯ä¿¡æ¯ï¼š", e)
				try {
					let BDUSS = document.cookie.match(/BDUSS=(.*?)(;|$)/);
					if (!!BDUSS || BDUSS === null) throw new Error("document.cookie dosen't had cookie")
					base.setStorage("baiduyunPlugin_BDUSS", { BDUSS: BDUSS });
				} catch (e) {
					console.error("ã€ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹ã€‘\nsetBDUSS\né”™è¯¯ä¿¡æ¯ï¼š", e)
				}
			}
		},

		getBDUSS() {
			doc.find('#loadingText').html(`<div>å‡­è¯è·å–ä¸­</div><div>æ­£åœ¨è·å–å½“å‰è´¦å·å‡­è¯~</div>`);
			let baiduyunPlugin_BDUSS = base.getStorage('baiduyunPlugin_BDUSS') ? base.getStorage('baiduyunPlugin_BDUSS') : { BDUSS: '' };
			return baiduyunPlugin_BDUSS.BDUSS || '';
		},

		async getToken() {
			try {
				doc.find('#loadingText').html(`<div>ä»¤ç‰Œè·å–ä¸­</div><div>æ­£åœ¨è·å–æˆæƒçŠ¶æ€~</div>`);

				// è·å–æˆæƒçŠ¶æ€
				let authorize = await base.getFinalUrl(config.baidu.api.getAccessToken);

				// åˆ¤æ–­æˆæƒæƒ…å†µ
				if (authorize.includes('authorize')) {
					// æ²¡æˆæƒï¼Œå…ˆè·å–æˆæƒçš„é¡µé¢
					doc.find('#loadingText').html(`<div>æˆæƒè·å–ä¸­</div><div>æ­£åœ¨è·å–æˆæƒé¡µé¢~</div>`);

					let html = await base.get(config.baidu.api.getAccessToken, {}, 'text');

					// æå–é¡µé¢çš„å‘é€ç¡®è®¤æˆæƒçš„å‚æ•°
					let bdstoken = html.match(/name="bdstoken"\s+value="([^"]+)"/)?.[1];
					let client_id = html.match(/name="client_id"\s+value="([^"]+)"/)?.[1];
					let data = {
						grant_permissions_arr: 'netdisk',
						bdstoken: bdstoken,
						client_id: client_id,
						response_type: "token",
						display: "page",
						grant_permissions: "basic,netdisk"
					};

					doc.find('#loadingText').html(`<div>æˆæƒè·å–ä¸­</div><div>æ­£åœ¨è‡ªåŠ¨ç¡®è®¤æˆæƒ~</div>`);

					// å‘é€è¯·æ±‚è¾¾åˆ°è‡ªåŠ¨è¿›è¡Œæˆæƒ
					await base.post(config.baidu.api.getAccessToken, base.stringify(data), {
						'Content-Type': 'application/x-www-form-urlencoded',
					});

					// å†æ¬¡è·å–æˆæƒçŠ¶æ€
					let res2 = await base.getFinalUrl(config.baidu.api.getAccessToken);
					let accessToken = res2.match(/access_token=([^&]+)/)?.[1];
					if (!!accessToken) {
						doc.find('#loadingText').html(`<div>ä»¤ç‰Œè·å–ä¸­</div><div>æˆæƒæˆåŠŸï¼Œä»¤ç‰Œå·²ç¼“å­˜~</div>`);
						base.setValue('baidu_access_token', accessToken);
						return accessToken;
					} else {
						doc.find('#loadingText').html(`<div>ä»¤ç‰Œè·å–ä¸­</div><div>æˆæƒå¤±è´¥ï¼Œç­‰å¾…ä¸‹ä¸€æ­¥æ“ä½œ~</div>`);
						return '';
					}
				} else if (authorize.includes('access_token=')) {
					let accessToken = authorize.match(/access_token=([^&]+)/)?.[1];
					if (!!accessToken) {
						doc.find('#loadingText').html(`<div>ä»¤ç‰Œè·å–ä¸­</div><div>è·å–æˆåŠŸï¼Œä»¤ç‰Œå·²ç¼“å­˜~</div>`);
						base.setValue('baidu_access_token', accessToken);
						return accessToken;
					} else {
						doc.find('#loadingText').html(`<div>ä»¤ç‰Œè·å–ä¸­</div><div>è·å–å¤±è´¥ï¼Œç­‰å¾…ä¸‹ä¸€æ­¥æ“ä½œ~</div>`);
						return '';
					}
				} else {
					return '';
				}
			} catch (error) {
				return '';
			}
		},

		convertLinkToAria(link, filename, ua) {
			let BDUSS = this.getBDUSS();
			if (!!BDUSS) {
				filename = base.fixFilename(filename);
				return encodeURIComponent(`aria2c "${link}" --out "${filename}" --header "User-Agent: ${ua}" --header "Cookie: BDUSS=${BDUSS}"`);
			}
			return {
				link: config.base.assistant.link,
				text: config.base.assistant.message
			};
		},

		convertLinkToBC(link, filename, ua) {
			let BDUSS = this.getBDUSS();
			if (!!BDUSS) {
				let cookie = `BDUSS=${BDUSS}`;
				let bc = `AA/${encodeURIComponent(filename)}/?url=${encodeURIComponent(link)}&cookie=${encodeURIComponent(cookie)}&user_agent=${encodeURIComponent(ua)}ZZ`;
				return encodeURIComponent(`bc://http/${base.encode(bc)}`);
			}
			return {
				link: config.base.assistant.link,
				text: config.base.assistant.message
			};
		},

		convertLinkToCurl(link, filename, ua) {
			let BDUSS = this.getBDUSS();
			if (!!BDUSS) {
				let terminal = base.getValue('setting_terminal_type');
				filename = base.fixFilename(filename);
				return encodeURIComponent(`${terminal !== 'wp' ? 'curl' : 'curl.exe'} -L -C - "${link}" -o "${filename}" -A "${ua}" -b "BDUSS=${BDUSS}"`);
			}
			return {
				link: config.base.assistant.link,
				text: config.base.assistant.message
			};
		},

		addPageListener() {
			/*
			é˜²æ­¢ä»£ç å› å…¶ä»–åŸå› è¢«æ‰§è¡Œå¤šæ¬¡
			è¿™æ®µä»£ç å‡ºè‡ª Viaè½»æ’ä»¶ï¼Œä½œè€…è°·èŠ±æ³°
			*/
			const key = encodeURIComponent('ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹:ç™¾åº¦ç½‘ç›˜');
			if (window[key]) return;
			window[key] = true;

			function _factory(e) {
				let target = $(e.target);
				let item = target.parents('.pl-item');
				let link = item.find('.pl-item-link.blob');
				let directLink = item.find('.pl-item-link.browser');
				let progress = item.find('.pl-item-progress');
				let tip = item.find('.pl-item-tip');
				let copy = item.find('.pl-item-copy');
				let howidm = item.find('.pl-progress-how');
				let back = item.find('.pl-progress-back');
				let stop = item.find('.pl-progress-stop');
				return {
					item, link, directLink, progress, tip, copy, howidm, back, stop, target,
				};
			}

			function _reset(i) {
				ins[i] && clearInterval(ins[i]);
				request[i] && request[i].abort();
				progress[i] = 0;
				idm[i] = false;
			}

			doc.on('mouseenter mouseleave click', '.pl-button.g-dropdown-button', function (e) {
				if (e.type === 'mouseleave') {
					$(e.currentTarget).removeClass('button-open');
				} else {
					$(e.currentTarget).addClass('button-open');
					$(e.currentTarget).find('.pl-dropdown-menu').show();
				}
			});
			doc.on('mouseleave', '.pl-button.g-dropdown-button .pl-dropdown-menu', function (e) {
				$(e.currentTarget).hide();
			});

			doc.on('click', '.pl-button-mode', function (e) {
				mode = e.target.dataset.mode;
				if (!mode) return;
				Swal.fire({
					showConfirmButton: false,
					allowOutsideClick: false,
					allowEscapeKey: false,
					allowEnterKey: false,
					html: `<div id="loadingText">é“¾æ¥è·å–ä¸­</div>`,
					willOpen: function () {
						Swal.showLoading();
					},
					...swalDefault
				});
				baidu.getPCSLink();
			});
			doc.on('click', '.pl-button-save', async function (e) {
				e.preventDefault();
				selectList = baidu.getSelectedList();
				if (selectList.length === 0) {
					return message.error('æç¤ºï¼š<br/>è¯·å‹¾é€‰è¦ä¿å­˜åˆ°ç½‘ç›˜çš„æ–‡ä»¶å“¦~');
				}
				message.info('æç¤ºï¼š<br/>å› ç½‘ç›˜é™åˆ¶ï¼Œè¯·ä¿å­˜åˆ°è‡ªå·±ç½‘ç›˜åå†å»ä¸‹è½½å“¦~');
				await base.sleep(500);
				document.querySelector('.tools-share-save-hb').click();
			});
			doc.on('click', '.listener-link-api.browser', async function (e) {
				e.preventDefault();
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				$('#downloadIframe').attr('src', href);
			});
			doc.on('click', '.listener-link-api.blob', async function (e) {
				e.preventDefault();
				let o = _factory(e);
				let $width = o.item.find('.pl-progress-inner');
				let $text = o.item.find('.pl-progress-inner-text');
				let filename = o.link[0].dataset.filename;
				let index = o.link[0].dataset.index;
				_reset(index);
				base.get(o.link[0].dataset.link, { "User-Agent": config.baidu.api.ua.downloadLink }, 'blob', { filename, index });
				let startTime = Date.now(); // è®°å½•ä¸‹è½½å¼€å§‹æ—¶é—´
				let prevLoaded = 0; // ä¸Šä¸€æ¬¡çš„å·²ä¸‹è½½æ•°æ®é‡
				let prevTime = startTime; // ä¸Šä¸€æ¬¡çš„æ—¶é—´
				let size = Number(o.link[0].dataset.size);
				ins[index] = setInterval(function () {
					let prog = +progress[index] || 0;
					let isIDM = idm[index] || false;

					if (isIDM) {
						// å¤„ç†IDMçš„ä»£ç 
						o.tip.hide();
						o.progress.hide();
						o.copy.show();
						o.directLink.show()
						o.link.text('é“¾æ¥å·²è¢«IDMæ•è·~è¯·æŸ¥çœ‹IDMä¸‹è½½çª—å£å“¦!').animate({ opacity: '0.5' }, "slow").show();
						clearInterval(ins[index]);
						setTimeout(function () {
							o.link.text('å¢å¼ºä¸‹è½½(åŸºäºæµè§ˆå™¨æ–‡ä»¶æµ)').animate({ opacity: '1' }, "slow");
						}, 2000)
						idm[index] = false;
					} else {
						// å¤„ç†æ™®é€šä¸‹è½½çš„æƒ…å†µ...
						let currentTime = Date.now();
						let elapsedTime = currentTime - startTime;
						let totalProgress = prog / 100;
						let totalElapsedSeconds = elapsedTime / 1000;
						let estimatedTotalTimeSeconds = totalElapsedSeconds / totalProgress;
						let remainingTimeSeconds = estimatedTotalTimeSeconds - totalElapsedSeconds;

						// å°†å‰©ä½™æ—¶é—´è½¬æ¢ä¸ºå¤©ã€æ—¶ã€åˆ†ã€ç§’
						let remainingDays = Math.floor(remainingTimeSeconds / (60 * 60 * 24));
						remainingTimeSeconds %= (60 * 60 * 24);

						let remainingHours = Math.floor(remainingTimeSeconds / (60 * 60));
						remainingTimeSeconds %= (60 * 60);

						let remainingMinutes = Math.floor(remainingTimeSeconds / 60);
						let remainingSeconds = Math.floor(remainingTimeSeconds % 60);

						// è®¡ç®—ä¸‹è½½é€Ÿåº¦
						let loaded = prog * size / 100; // å·²ä¸‹è½½æ•°æ®é‡
						let currentTimeDiff = currentTime - prevTime; // å½“å‰æ—¶é—´ä¸ä¸Šä¸€æ¬¡æ—¶é—´çš„å·®å€¼
						let loadedDiff = loaded - prevLoaded; // å½“å‰å·²ä¸‹è½½æ•°æ®é‡ä¸ä¸Šä¸€æ¬¡çš„å·®å€¼
						let downloadSpeed = (currentTimeDiff !== 0) ? loadedDiff / (currentTimeDiff / 1000) : 0; // ä¸‹è½½é€Ÿåº¦ï¼ˆå•ä½ï¼šå­—èŠ‚/ç§’ï¼‰

						// æ›´æ–°ä¸Šä¸€æ¬¡çš„æ•°æ®
						prevLoaded = loaded;
						prevTime = currentTime;

						// æ›´æ”¹ç•Œé¢
						o.link.hide();
						o.directLink.hide();
						o.tip.hide();
						o.stop.show();
						o.copy.hide();
						o.progress.show();

						// æ›´æ–°è¿›åº¦æ¡
						$width.css('width', prog + '%');

						// æ›´æ–°è¿›åº¦æ¡æ–‡æœ¬
						let timeText = '';
						if (Number.isFinite(remainingDays) && remainingDays > 0) {
							timeText = remainingDays + 'å¤© ' + base.repairTimer(remainingHours) + 'æ—¶:' + base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
						} else if (Number.isFinite(remainingHours) && remainingHours > 0) {
							timeText = base.repairTimer(remainingHours) + 'æ—¶:' + base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
						} else if (Number.isFinite(remainingMinutes) && remainingMinutes > 0) {
							timeText = base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
						} else if (Number.isFinite(remainingSeconds) && remainingSeconds > 0) {
							timeText = remainingSeconds + 'ç§’';
						} else if (Number.isFinite(remainingSeconds) && remainingSeconds === 0) {
							timeText = 'å³å°†å®Œæˆ';
						} else {
							timeText = 'è®¡ç®—ä¸­...';
						}

						let speedText = '';
						speedText = base.sizeFormat(downloadSpeed)
						$text.text(prog + '% | å‰©ä½™æ—¶é—´ï¼š' + timeText + ' | é€Ÿåº¦ï¼š' + speedText + '/ç§’');

						if (prog === 100) {
							setTimeout(function () {
								clearInterval(ins[index]);
								progress[index] = 0;
								o.item.find('.pl-progress-stop').hide();
								o.howidm.hide();
								$text.text('ä¸‹è½½å®Œæˆ~ æµè§ˆå™¨ä¸‹è½½æ¡†åº”è¯¥å¼¹å‡ºæ¥äº†å“¦~');
								o.back.show()
								setTimeout(function () {
									o.link.text('å¢å¼ºä¸‹è½½(åŸºäºæµè§ˆå™¨æ–‡ä»¶æµ)').animate({ opacity: '1' }, "slow");
								}, 3000)
							}, 1000)
						}
					}
				}, 500);
			});
			doc.on('click', '.listener-retry', async function (e) {
				let o = _factory(e);
				o.tip.hide();
				o.link.show();
				o.directLink.show();
			});
			doc.on('click', '.listener-stop', async function (e) {
				let o = _factory(e);
				let index = o.link[0].dataset.index;
				if (request[index]) {
					request[index].abort();
					clearInterval(ins[index]);
					o.item.find('.pl-progress-inner-text').text('æ­£åœ¨å–æ¶ˆ...');
					o.item.find('.pl-progress-inner').css('width', 100 + '%');
					setTimeout(function () {
						o.tip.hide();
						o.back.hide();
						o.link.show();
						o.directLink.show();
						o.copy.show();
						o.progress.hide();
						o.stop.hide();
					}, 1050)
				}
			});
			doc.on('click', '.listener-back', async function (e) {
				let o = _factory(e);
				o.progress.hide();
				o.tip.hide();
				o.link.show();
				o.directLink.show();
				o.copy.show();
				o.stop.hide();
				o.back.hide();
			});
			doc.on('click', '.listener-download-all', function (e) {
				$('.pl-item-link.blob').each(function () {
					if ($(this).css('display') !== 'none') {
						$(this).click();
					}
				});
				$(e.target).text('ä¸‹è½½å¼€å§‹ï¼Œä¸‹è½½è¿›åº¦è§ä¸Šæ–¹æŒ‰é’®å“¦~').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('å…¨éƒ¨å¢å¼ºä¸‹è½½').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-aria, .listener-copy-all', function (e) {
				e.preventDefault();
				if (!e.target.dataset.link) {
					$(e.target).removeClass('listener-copy-all').addClass('pl-btn-danger').html(`${config.base.assistant.message}ğŸ‘‰<a href="${config.base.assistant.link}" target="_blank" class="pl-a">ç‚¹å‡»æ­¤å¤„å®‰è£…</a>ğŸ‘ˆ`);
				} else {
					base.setClipboard(decodeURIComponent(e.target.dataset.link));
					$(e.target).text('å¤åˆ¶æˆåŠŸ').animate({ opacity: '0.5' }, "slow");
					setTimeout(
						function () {
							$(e.target).text('é‡æ–°å¤åˆ¶').animate({ opacity: '1' }, "slow");
						}, 2000
					)
				}
			});
			doc.on('click', '.listener-link-rpc', async function (e) {
				let target = $(e.currentTarget);

				target.find('.icon-rpc-devices').remove();
				target.find('.pl-loading').remove();
				target.prepend(base.createLoading());

				let res = await baidu.sendLinkToRPC(e.currentTarget.dataset.filename, e.currentTarget.dataset.link);
				if (res === 'success') {
					$('.listener-rpc-task').show();
					target.removeClass('pl-btn-danger').html('å‘é€æˆåŠŸäº†!å¿«å»çœ‹çœ‹å§~').animate({ opacity: '0.5' }, "slow");
				} else if (res === 'assistant') {
					target.addClass('pl-btn-danger').html(`${config.base.assistant.message}ğŸ‘‰<a href="${config.base.assistant.link}" target="_blank" class="pl-a">ç‚¹å‡»æ­¤å¤„å®‰è£…</a>ğŸ‘ˆ`);
				} else {
					target.addClass('pl-btn-danger').text('å‘é€å¤±è´¥ï¼Œæ£€æŸ¥ä¸€ä¸‹æ‚¨çš„RPCé…ç½®ä¿¡æ¯å“¦!').animate({ opacity: '0.5' }, "slow");
				}
			});
			doc.on('click', '.listener-send-rpc', function (e) {
				$('.listener-link-rpc').click();
				$(e.target).text('å‘é€å®Œæˆï¼Œå‘é€ç»“æœè§ä¸Šæ–¹æŒ‰é’®å“¦~').animate({ opacity: '0.5' }, "slow");
			});
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdateLog();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-rpc-task', function (e) {
				e.preventDefault();
				let rpc = JSON.stringify({
					domain: base.getValue('setting_rpc_domain'),
					port: base.getValue('setting_rpc_port'),
				}), url = `${config.base.service.rpc}/?rpc=${base.encode(rpc)}#${base.getValue('setting_rpc_token')}`;
				GM_openInTab(url, { active: true });
			});
			document.documentElement.addEventListener('mouseup', function (e) {
				if (e.target.nodeName === 'A' && ~e.target.className.indexOf('pl-a')) {
					e.stopPropagation();
				}
			}, true);
		},

		removeAD() {
			base.waitForKeyElements(".wp-s-header-user__vip-center", function (tag) {
				tag.remove();
			});
			base.waitForKeyElements(".wp-s-header-user__create-team-content", function (tag) {
				tag.remove();
			});
			base.waitForKeyElements(".app-user-vip-center-box.vip-center-type-2", function (tag) {
				tag.remove();
			}, true);
			base.waitForKeyElements(".wp-s-header__vip-btn-tip", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".app-user-vip-center-tip", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements("#web-header-text-s-45", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".wp-s-header__vip-btn", function (tag) {
				tag[0].innerText = "ä¼šå‘˜ä¸­å¿ƒ";
			}, true);
			base.waitForKeyElements(".KQcHyA", function (tag) {
				tag[0].innerText = "ä¼šå‘˜ä¸­å¿ƒ";
			}, true);
			base.waitForKeyElements(".gOIbzPb", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".wp-s-header-user__create-team-title", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".web-header-ad-item", function (tag) {
				tag.fadeOut();
			});
			base.waitForKeyElements(".wp-s-header__game-entry", function (tag) {
				tag.fadeOut();
			}, true)
			base.waitForKeyElements(".bd-aside-ad", function (tag) {
				tag.fadeOut();
			}, true)
			base.waitForKeyElements(".btn-img-tips", function (tag) {
				tag.fadeOut();
			}, true)
			base.waitForKeyElements(".nd-operate-guidance", function (tag) {
				tag.fadeOut();
			}, true)
			base.waitForKeyElements(".module-operation-content", function (tag) {
				tag.fadeOut();
				document.querySelector(".operate-guide-close").click();
				document.querySelector(".module-canvas").click();
			}, true)
			base.waitForKeyElements("[class*='module-'][class*='-box'], [class*='module-'][class*='-mask']", function (tag) {
				tag.fadeOut();
				tag.find(".close-mask").click();
			}, true)
			base.waitForKeyElements(".newIcon", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".u-badge__content.is-dot", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".wp-side-options.g-clearfix", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".wp-s-header-user__drop-channel", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".app-download", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements('.g-button[title*="æ‰‹æœº"]', function (tag) {
				tag.fadeOut();
			}, true)
			base.waitForKeyElements('.yike-entrance', function (tag) {
				tag.remove();
			})
			base.waitForKeyElements("p.wp-s-aside-nav__main-item-text", function (tag) {
				if (tag[0].innerHTML.match(/(æ’ä»¶|ç›¸å†Œ|ç¬”è®°)/) && tag[0].closest('a') && tag[0].closest('a').getAttribute('target') !== "_blank") {
					$(tag[0].closest('a')).fadeOut();
				} else {
					tag[0].innerHTML = tag[0].innerHTML.replace("ç™¾åº¦", "");
				}
			}, true);
			base.waitForKeyElements('dd[node-type="header-link"]', function (tag) {
				tag.children().each(function () {
					let tag = $(this);
					if (!tag.attr("node-type")) return;
					let type = tag.attr("node-type");
					if (
						type !== "disk-home" &&
						type !== "mbox-homepage" &&
						type !== "find-apps"
					) {
						tag.fadeOut();
					}
				});
			}, true);
			base.waitForKeyElements(".__yunguanjia", function (tag) {
				tag[0].innerHTML = `
				<div class="yunguanjia-list __yunguanjia row g-clearfix _item sel">
					<span type="radio" class="radio-box _radioInput __yunguanjiaRadio">
						<span class="device-name">æ·»åŠ æˆ‘çš„ç”µè„‘</span>
					</span>
					<div class="__yunguanjiaTips radio-tips" style="display: block;">
						ç”¨ç”µè„‘ä¸‹è½½å¹¶ç™»å½•æœ€æ–°ç™¾åº¦ç½‘ç›˜å®¢æˆ·ç«¯ï¼Œå³è‡ªåŠ¨å®Œæˆæ·»åŠ ã€‚
						<a href="//pan.baidu.com/download" target="_blank">ä¸‹è½½ç™¾åº¦ç½‘ç›˜å®¢æˆ·ç«¯</a>
						<br/>ç”± <a>(æ”¹)ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹</a> ä¿®å¤è¯¥é€‰é¡¹
					</div>
				</div>`;
			}, true)
			// ç¾åŒ–åˆ†äº«é¡µé¢
			if (page === 'share') {
				base.waitForKeyElements(`iframe[src^="/buy/ad"]`, function (tag) {
					tag.fadeOut();
				}, true)
				base.waitForKeyElements(`.theme-white.init-new`, function (tag) {
					tag[0].style.background = '#DCEFFE url(https://nd-static.bdstatic.com/m-static/disk-share/widget/pageModule/init-new/image/init-bg_1708266.png) no-repeat center center'
				}, true)
				base.waitForKeyElements(`#layoutApp`, function (tag) {
					tag[0].style.background = '#DCEFFE url(https://nd-static.bdstatic.com/m-static/disk-share/widget/pageModule/init-new/image/init-bg_1708266.png) no-repeat center center'
					document.body.style.background = '#DCEFFE url(https://nd-static.bdstatic.com/m-static/disk-share/widget/pageModule/init-new/image/init-bg_1708266.png) no-repeat center center'
				}, true)
				base.waitForKeyElements(`#bd-main .bd-left`, function (tag) {
					tag[0].style.background = '#ffffffC0';
					tag[0].style.borderRadius = '10px';

				}, true)
				base.waitForKeyElements(`.KPDwCE`, function (tag) {
					tag[0].style.setProperty('background', 'transparent');
				}, true)
				base.waitForKeyElements('.share-list .KPDwCE .AuPKyz', function (tag) {
					tag[0].style.setProperty('background', 'transparent');
				}, true)
				base.waitForKeyElements(`#layoutMain`, function (tag) {
					tag.css({ "border-radius": "24px" });
				}, true)
				base.waitForKeyElements(".frame-content", function (tag) {
					tag.css({ "margin": "auto" });
				}, true)
			}
		},

		addButton() {
			if (!page) return;
			let $toolWrap;
			let $button = $(`
				<div class="g-dropdown-button pointer pl-button">
					<div class="baidu-button g-button g-button-blue"><span class="g-button-right"><em class="icon icon-download" style="color:#fff;"></em><span class="text" style="width: 60px;">ä¸‹è½½åŠ©æ‰‹</span></span></div>
					<div class="menu" style="color: ${color};border-color: ${color};width:auto;z-index:41;">
						<div class="g-button-menu pl-button-mode" data-mode="api">APIä¸‹è½½</div>
						<div class="g-button-menu pl-button-mode" data-mode="aria">Ariaä¸‹è½½</div>
						<div class="g-button-menu pl-button-mode" data-mode="rpc">RPCä¸‹è½½</div>
						<div class="g-button-menu pl-button-mode" data-mode="curl">cURLä¸‹è½½</div>
						<div class="g-button-menu pl-button-mode" data-mode="bc">BCä¸‹è½½</div>
						<div class="g-button-menu pl-button-mode listener-open-setting">åŠ©æ‰‹è®¾ç½®</div>
						<div class="g-button-menu pl-button-mode listener-open-beautify">åŠ©æ‰‹ç¾åŒ–</div>
						<div class="g-button-menu pl-button-mode listener-open-updatelog">æ›´æ–°æ—¥å¿—</div>
					</div>
				</div>
			`);
			if (page === 'home') $toolWrap = config.baidu.mount.home;
			if (page === 'main') {
				$toolWrap = config.baidu.mount.main;
				$button = $(`
				<div class="wp-s-agile-tool-bar__h-group pl-button">
					<div class="wp-s-agile-tool-bar__h-action is-need-left-sep is-main">
						<button type="button" class="u-button nd-file-list-toolbar-action-item u-button--primary u-button--small is-round is-has-icon pl-button baidu-button">
							<i class="u-icon u-icon-download"></i>
							<span>ä¸‹è½½åŠ©æ‰‹</span>
						</button>
						<ul class="dropdown-list nd-common-float-menu pl-dropdown-menu">
							<li class="sub cursor-p pl-button-mode" data-mode="api">APIä¸‹è½½</li>
							<li class="sub cursor-p pl-button-mode" data-mode="aria">Ariaä¸‹è½½</li>
							<li class="sub cursor-p pl-button-mode" data-mode="rpc">RPCä¸‹è½½</li>
							<li class="sub cursor-p pl-button-mode" data-mode="curl">cURLä¸‹è½½</li>
							<li class="sub cursor-p pl-button-mode" data-mode="bc">BCä¸‹è½½</li>
							<li class="sub cursor-p pl-button-mode listener-open-setting">åŠ©æ‰‹è®¾ç½®</li>
							<li class="sub cursor-p pl-button-mode listener-open-beautify">åŠ©æ‰‹ç¾åŒ–</li>
							<li class="sub cursor-p pl-button-mode listener-open-updatelog">æ›´æ–°æ—¥å¿—</li>
						</ul>
					</div>
				</div>`);
			}
			if (page === 'youth') {
				$toolWrap = config.baidu.mount.main;
				$button = $(`
				<div class="wp-s-agile-tool-bar__h-group pl-button">
					<div class="wp-s-agile-tool-bar__h-action is-need-left-sep is-main">
						<button type="button" class="u-button nd-file-list-toolbar-action-item u-button--primary u-button--small is-round is-has-icon pl-button baidu-button" style="font-size:14px;font-weight:700">
							<i class="u-icon u-icon-more"></i>
							<span>ç½‘ç›˜åŠ©æ‰‹</span>
						</button>
						<ul class="dropdown-list nd-common-float-menu pl-dropdown-menu">
							<li class="sub cursor-p pl-button-mode listener-open-setting">åŠ©æ‰‹è®¾ç½®</li>
							<li class="sub cursor-p pl-button-mode listener-open-beautify">åŠ©æ‰‹ç¾åŒ–</li>
							<li class="sub cursor-p pl-button-mode listener-open-updatelog">æ›´æ–°æ—¥å¿—</li>
						</ul>
					</div>
				</div>`);
			}
			if (page === 'share') {
				$toolWrap = config.baidu.mount.share;
				$button = $(`
					<div class="g-dropdown-button pointer pl-button">
						<div class="baidu-button g-button g-button-blue"><span class="g-button-right"><em class="icon icon-download" style="color:#fff;"></em><span class="text" style="width: 60px;">ä¸‹è½½åŠ©æ‰‹</span></span></div>
						<div class="menu" style="color: ${color};border-color: ${color};width:auto;z-index:41;">
							<div class="g-button-menu pl-button-mode pl-button-save"><em class="icon icon-save-disk" title="ä¿å­˜åˆ°ç½‘ç›˜"></em><span style="margin-left: 3px;">ä¿å­˜åä¸‹è½½</span></div>
							<div class="g-button-menu pl-button-mode listener-open-setting">åŠ©æ‰‹è®¾ç½®</div>
							<div class="g-button-menu pl-button-mode listener-open-beautify">åŠ©æ‰‹ç¾åŒ–</div>
							<div class="g-button-menu pl-button-mode listener-open-updatelog">æ›´æ–°æ—¥å¿—</div>
						</div>
					</div>
				`);
				base.listenElement($toolWrap, function () {
					$toolWrap = $($toolWrap);
					$('.pl-button').length === 0 && $toolWrap.append($button);
				})
			} else {
				base.listenElement($toolWrap, function () {
					$toolWrap = $($toolWrap);
					$('.pl-button').length === 0 && $toolWrap.prepend($button);
				})
			}
			this.setBDUSS();
			base.createDownloadIframe();
		},

		addInitButton() {
			if (!page) return;
			let $toolWrap;
			let $button = $(`<div class="g-dropdown-button pointer pl-button-init" style="opacity:0.5"><div style="color:#fff;" class="g-button g-button-blue"><span class="g-button-right"><em class="icon icon-download" style="color:#fff;"></em><span class="text" style="width: 60px;">ç‚¹æˆ‘ç‚¹äº®</span></span></div></div>`);
			if (page === 'home') {
				$toolWrap = config.baidu.mount.home;
			}
			if (page === 'main' || page === 'youth') {
				$toolWrap = config.baidu.mount.main;
				$button = $(`
				<div class="wp-s-agile-tool-bar__h-group pl-button-init">
					<div class="wp-s-agile-tool-bar__h-action is-need-left-sep is-main">
						<button type="button" class="u-button nd-file-list-toolbar-action-item u-button--primary u-button--small is-round is-has-icon pl-button baidu-button" style="font-size:14px;font-weight:700">
							<i class="u-icon u-icon-download"></i>
							<span>ç‚¹æˆ‘ç‚¹äº®</span>
						</button>
					</div>
				</div>`);
			}
			if (page === 'share') $toolWrap = config.baidu.mount.share;
			$button.click(function () { base.initDialog() });
			base.listenElement($toolWrap, function () {
				$toolWrap = $($toolWrap);
				$('.pl-button-init').length === 0 && $toolWrap.prepend($button);
			})
		},

		async getPCSLink() {
			// è·å–é€‰æ‹©çš„æ–‡ä»¶åˆ—è¡¨
			selectList = this.getSelectedList();
			let BDUSS = this.getBDUSS(), accessToken = (base.getValue('baidu_access_token') || await baidu.getToken());

			if (!accessToken) {
				message.info('æç¤ºï¼š<br/>ç¨åè¯·åœ¨æ–°æ ‡ç­¾é¡µä¸­æˆæƒåŠ©æ‰‹å“¦~');
				base.deleteValue('baidu_access_token');
				setTimeout(() => {
					GM_openInTab(config.baidu.api.getAccessToken, { active: true, insert: true, setParent: true })
					let attempts = 0;
					let interval = setInterval(function () {
						if (!!base.getValue('baidu_access_token')) {
							clearInterval(interval);
							accessToken = base.getValue('baidu_access_token')
						}
						attempts++;
						if (attempts > 120) {
							clearInterval(interval);
							return message.error('æç¤ºï¼š<br/>æ—¶é—´å¤ªé•¿ï¼Œæˆ‘å…ˆæ’¤ä¸‹å•¦~');
						}
					}, 1000);
				}, 3300);
				return;
			}

			if (!BDUSS) {
				let dialog = await Swal.fire({
					icon: 'info',
					title: `æç¤º`,
					html: 'ä½ å¥½å‘€ï¼Œä¸ºäº†è·å–ç™¾åº¦ç½‘ç›˜æ–‡ä»¶çš„ä¸‹è½½ç›´é“¾<br/>æˆ‘ä»¬éœ€è¦æ‚¨å®‰è£…åŸä½œè€…çš„è¾…åŠ©æ‰©å±•<br/>æ¥è®© â€œä¸‹è½½åŠ©æ‰‹â€ è¯»å–æ‚¨çš„ç½‘ç›˜è´¦å·å‡­è¯<br/>è·å–åˆ°çš„å‡­è¯ä»…ç”¨äºç”Ÿæˆç›´é“¾ï¼Œè¯·æ”¾å¿ƒå®‰è£…ãƒ¾(â‰§â–½â‰¦*)o<br/><br/>ä¸çŸ¥é“å¦‚ä½•å®‰è£…ç¬¬ä¸‰æ–¹æ‰©å±•ï¼Ÿ<a class="pl-a" target="_blank" href="https://www.youxiaohou.com/zh-cn/crx.html">ç‚¹æ­¤æŸ¥çœ‹è¯¦æƒ…</a><br/>å¦‚æœç»™æµè§ˆå™¨å¼€å¯äº†â€œå¼€å‘è€…æ¨¡å¼â€åé¢‘ç¹æç¤º<br/>â€œå…³é—­å¼€å‘è€…æ¨¡å¼â€ï¼Œè¯·ä½¿ç”¨<a class="pl-a" target="_blank" href="https://wws.lanzoub.com/b00vgnrha">æ­¤è¡¥ä¸</a>éšè—æç¤ºã€‚<a class="pl-a" target="_blank" href="https://ooo.0x0.ooo/2022/05/04/zrNGX.png">ç•Œé¢æ±‰åŒ–</a><br/>æ‰©å±•å®‰è£…åè¯·åˆ·æ–°æœ¬é¡µï¼Œä»¥åº”ç”¨æœ€æ–°æ›´æ”¹',
					showConfirmButton: true,
					showDenyButton: true,
					showCloseButton: true,
					allowOutsideClick: false,
					allowEscapeKey: false,
					allowEnterKey: false,
					confirmButtonText: 'å‰å¾€ Chromeï¼ˆCrxæœæœï¼‰',
					denyButtonText: 'å‰å¾€ Firefoxï¼ˆCrxæœæœï¼‰',
					position: 'center',
					...swalDefault
				});
				if (dialog.isConfirmed) {
					GM_openInTab('https://www.crxsoso.com/addon/detail/mphijdmblaalbakceeadippfkbgfgaaa', { active: true });
				}
				if (dialog.isDenied) {
					GM_openInTab('https://www.crxsoso.com/firefox/detail/baidunetdiskisasb', { active: true });
				}
				return;
			}

			if (page === 'home' || page === 'main') {
				if (!selectList.length) {
					return message.error('æç¤ºï¼š<br/>å…ˆå‹¾é€‰è¦ä¸‹è½½çš„æ–‡ä»¶å“¦~');
				}

				let cnt = 0;
				let processed = selectList.filter(f => !f.isdir).length;

				async function fetchFiles(dirs) {
					let files = [];

					for (let dir of dirs) {
						let url = `${config.baidu.api.getFiles}&dir=${encodeURIComponent(dir.path)}&access_token=${accessToken}`;
						let res = await base.get(url, { "User-Agent": config.baidu.api.ua.downloadLink });
						cnt++;

						if (res?.list?.length && (res.errno === 0 || res.errmsg === "succ")) {
							let subFiles = res.list.filter(f => !f.isdir);

							processed += subFiles.length;
							doc.find('#loadingText').html(`<div>æ–‡ä»¶è·å–ä¸­</div><div>å·²è·å– ${processed} ä¸ªæ–‡ä»¶ï¼Œè¯·è€å¿ƒç­‰å¾…å“¦~</div><div>${dir.path}</div>`);

							files = files.concat(subFiles);
							if (res.list.some(f => f.isdir)) {
								files = files.concat(await fetchFiles(res.list.filter(f => f.isdir)));
							}
						}
						if (cnt >= 50) {
							doc.find('#loadingText').html(`<div>æ–‡ä»¶è·å–ä¸­</div><div>å·²è·å– ${processed} ä¸ªæ–‡ä»¶ï¼Œè¯·è€å¿ƒç­‰å¾…å“¦~</div><div>ä¼‘æ¯ 3 ç§’...</div>`);
							await base.sleep(3000);
							cnt = 0;
						}
					}
					return files;
				}

				let files = selectList.filter(f => !f.isdir);

				if (selectList.some(f => f.isdir)) {
					files = files.concat(await fetchFiles(selectList.filter(f => f.isdir)));
				}
				if (!files.length) {
					return message.error('æç¤ºï¼š<br/>æ–‡ä»¶å¤¹æ˜¯ç©ºçš„å“¦~');
				}

				doc.find('#loadingText').html(`<div>é“¾æ¥è·å–ä¸­</div><div>æ­£åœ¨è·å–æ–‡ä»¶å¯¹åº”çš„ä¸‹è½½é“¾æ¥~</div>`);

				let fidList = files.map(f => f.fs_id);
				let batchSize = 100;
				let linkList = [];
				for (let i = 0; i < fidList.length; i += batchSize) {
					let url = `${config.baidu.api.getLink}&fsids=${encodeURIComponent(JSON.stringify(fidList.slice(i, i + batchSize)))}&access_token=${accessToken}`;
					let res = await base.get(url, { "User-Agent": config.baidu.api.ua.downloadLink });

					if (res?.list?.length && (res.errno === 0 || res.errmsg === "succ")) {
						linkList = linkList.concat(res.list);
						doc.find('#loadingText').html(`<div>é“¾æ¥è·å–ä¸­</div><div>å·²è·å– ${linkList.length} / ${fidList.length} ä¸ªé“¾æ¥ï¼Œè¯·è€å¿ƒç­‰å¾…å“¦~</div><div>æ­£åœ¨è·å–æ–‡ä»¶å¯¹åº”çš„ä¸‹è½½é“¾æ¥~</div>`);

					} else {
						if (res?.errno) {
							if (res.errno === 112) {
								return message.error('æç¤ºï¼š<br/>é¡µé¢è¿‡æœŸäº†ï¼Œåˆ·æ–°é‡è¯•ä¸‹å§~<br/>ä»£ç ï¼š' + res.errno);
							}
							if (res.errno === 9019) {
								base.deleteValue('baidu_access_token');
								return message.error('æç¤ºï¼š<br/>è®¿é—®ä»¤ç‰Œå·²è¿‡æœŸï¼Œåˆ·æ–°ç½‘é¡µåå†è·å–ä¸€æ¬¡å§~<br/>ä»£ç ï¼š' + res.errno);
							}

							base.deleteValue('baidu_access_token');
							return message.error('æç¤ºï¼š<br/>è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œåˆ·æ–°ç½‘é¡µåå†è¯•è¯•å§~<br/>ä»£ç ï¼š' + res.errno);

						} else {
							return message.error('æç¤ºï¼š<br/>è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œåˆ·æ–°ç½‘é¡µåå†è¯•è¯•å§~');
						}
					}
					await base.sleep(1000);
				}

				if (linkList.length) {
					this.showMainDialog(config.base.dom.button[mode].title, this.generateDom(linkList), config.base.dom.button[mode].footer);
				} else {
					return message.error('æç¤ºï¼š<br/>è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œåˆ·æ–°ç½‘é¡µåå†è¯•è¯•å§~');
				}
			} else {
				return message.error('æç¤ºï¼š<br/>é¡µé¢é”™è¯¯~');
			}
		},

		generateDom(list) {
			if (!list) {
				return message.error('æç¤ºï¼š<br/>è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œåˆ·æ–°ç½‘é¡µåå†è¯•è¯•å§~');
			}
			let content = '<div class="pl-main">';
			let alinkAllText = '';
			base.sortByName(list);
			list.forEach((v, i) => {
				if (v.isdir === 1) return;
				let filename = v.server_filename || v.filename;
				let size = base.sizeFormat(v.size);
				if (!v?.dlink || !v?.dlink.includes("http")) {
					content += `<div class="pl-item">
						<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
						<div class="pl-item-tip">è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œåˆ·æ–°ç½‘é¡µåå†è¯•è¯•å§~</div>
					</div>`;
				} else {
					let dlink = v.dlink + '&access_token=' + base.getValue('baidu_access_token');
					if (mode === 'api') {
						alinkAllText += dlink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<button class="pl-item-link listener-tip pl-btn-primary listener-link-api blob" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œè‹¥æ–‡ä»¶è¿‡å¤§ä¸‹è½½å®Œæˆåæœ‰å¯èƒ½ä¸ä¼šå¼¹å‡ºçª—å£ï¼Œæ­¤æ—¶è¯·æ¢ç”¨â€œRPCä¸‹è½½ + Mortixâ€çš„ç»„åˆ<br/>åŸºäºæµè§ˆå™¨çš„ Blob æ–‡ä»¶æµä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒæ–°çš„æµè§ˆå™¨ï¼Œå¯ä»¥åœ¨æ­¤çª—å£ä¸­æ˜¾ç¤ºä¸‹è½½å‰©ä½™æ—¶é—´å’Œä¸‹è½½é€Ÿåº¦ï¼Œæ­¤æ–¹å¼ä¸‹è½½æœ‰å¯èƒ½ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥" data-filename="${filename}" data-size="${v.size}" data-link="${dlink}" data-index="${i}">å¢å¼ºä¸‹è½½(åŸºäºæµè§ˆå™¨æ–‡ä»¶æµ)</button>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-info listener-link-api browser" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œè‹¥ä½¿ç”¨åé•¿æ—¶é—´æ²¡æœ‰å¼¹å‡ºä¸‹è½½æç¤ºåˆ™ä»£è¡¨è¯·æ±‚å¤±è´¥ï¼Œè¯·æ¢ç”¨â€œå¢å¼ºä¸‹è½½â€<br/>åŸºäºæµè§ˆå™¨ç›´æ¥æ‰“å¼€é“¾æ¥æ¥ä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒä¸ºå¤è€ä½†æ”¯æŒ iframe çš„æµè§ˆå™¨ï¼Œç‚¹å‡»â€œç›´æ¥ä¸‹è½½â€åéœ€ç­‰å¾…ä¸‹è½½æç¤ºå¼¹å‡ºæ‰èƒ½ç‚¹å‡»ä¸‹ä¸ªâ€œç›´æ¥ä¸‹è½½â€ï¼Œå¦åˆ™åªä¼šä¸‹è½½åè€…ï¼Œæ­¤æ–¹å¼ä¸‹è½½æœ‰å¯èƒ½ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥" data-filename="${filename}" data-link="${dlink}">ç›´æ¥ä¸‹è½½(åŸºäºæµè§ˆå™¨é“¾æ¥)</button>
							<button class="pl-item-copy listener-tip pl-btn-primary pl-btn-warning listener-copy-all" href="${dlink}" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œåœ¨æœ¬ç½‘ç›˜å•ç‹¬å¤åˆ¶é“¾æ¥å¹¶ç²˜è´´ä¸‹è½½å¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨å›æŠ¥ 403 é”™è¯¯" data-filename="${filename}" data-link="${dlink}">å¤åˆ¶é“¾æ¥</button>
							<div class="pl-item-tip" style="display: none"></div>
							<div class="pl-item-progress" style="display: none">
								<div class="pl-progress">
									<div class="pl-progress-outer"></div>
									<div class="pl-progress-inner" style="width:5%">
									<div class="pl-progress-inner-text">æ­£åœ¨åŠ è½½è¿›åº¦...0%</div>
									</div>
								</div>
								<span class="pl-btn-primary pl-btn-danger pl-progress-stop listener-stop">å–æ¶ˆä¸‹è½½</span>
								<span class="pl-btn-primary pl-btn-info pl-progress-back listener-back" style="display: none">è¿”å›</span>
							</div>
						</div>`;
					}
					if (mode === 'aria') {
						let alink = this.convertLinkToAria(dlink, filename, config.baidu.api.ua.downloadLink);
						if (typeof (alink) === 'object') {
							content += `<div class="pl-item">
								<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
								<a class="pl-item-link pl-a" target="_blank" href="${alink.link}" title="ç‚¹å‡»å¤åˆ¶ aria2c å‘½ä»¤è¡Œ" data-filename="${filename}" data-link="${alink.link}">${decodeURIComponent(alink.text)}<br/>å¤åˆ¶ ${filename} ä¸‹è½½å‘½ä»¤è¡Œ</a>
							</div>`;
						} else {
							alinkAllText += alink + '\r\n';
							content += `<div class="pl-item">
								<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
								<a class="pl-item-link pl-a listener-link-aria" href="${alink}" title="ç‚¹å‡»å¤åˆ¶ aria2c å‘½ä»¤è¡Œ" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>å¤åˆ¶ ${filename} ä¸‹è½½å‘½ä»¤è¡Œ</a>
							</div>`;
						}
					}
					if (mode === 'rpc') {
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<button class="pl-item-link listener-link-rpc pl-btn-primary pl-btn-info" data-filename="${filename}" data-link="${dlink}"><svg class="icon-rpc-devices" viewBox="-10 0 1034 1024"><g transform="matrix(1 0 0 -1 0 960)"><path fill="currentColor" d="M832 -64h-640q-53 0 -90.5 37.5t-37.5 90.5v768q0 53 37.5 90.5t90.5 37.5h640q53 0 90.5 -37.5t37.5 -90.5v-768q0 -53 -37.5 -90.5t-90.5 -37.5zM832 768q0 27 -18.5 45.5t-45.5 18.5h-512q-27 0 -45.5 -18.5t-18.5 -45.5v-320h640v320v0zM832 320h-640v-192q0 -27 18.5 -45.5t45.5 -18.5h512q27 0 45.5 18.5t18.5 45.5v192v0zM512 128q-27 0 -45.5 18.5t-18.5 45.5t18.5 45.5t45.5 18.5t45.5 -18.5t18.5 -45.5t-18.5 -45.5t-45.5 -18.5z" /></g></svg><span style="margin-left: 5px;">å°† ${filename} æ¨é€åˆ° RPC ä¸‹è½½å™¨</span></button>
						</div>`;
					}
					if (mode === 'curl') {
						let alink = this.convertLinkToCurl(dlink, filename, config.baidu.api.ua.downloadLink);
						if (typeof (alink) === 'object') {
							content += `<div class="pl-item">
								<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
								<a class="pl-item-link pl-a" target="_blank" href="${alink.link}" title="ç‚¹å‡»å¤åˆ¶ curl å‘½ä»¤è¡Œ" data-filename="${filename}" data-link="${alink.link}">${decodeURIComponent(alink.text)}<br/>å¤åˆ¶ ${filename} ä¸‹è½½å‘½ä»¤è¡Œ</a>
							</div>`;
						} else {
							alinkAllText += alink + '\r\n';
							content += `<div class="pl-item">
								<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
								<a class="pl-item-link pl-a listener-link-aria" href="${alink}" title="ç‚¹å‡»å¤åˆ¶ curl å‘½ä»¤è¡Œ" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>å¤åˆ¶ ${filename} ä¸‹è½½å‘½ä»¤è¡Œ</a>
							</div>`;
						}
					}
					if (mode === 'bc') {
						let alink = this.convertLinkToBC(dlink, filename, config.baidu.api.ua.downloadLink);
						if (typeof (alink) === 'object') {
							alinkAllText += decodeURIComponent(alink.text) + '\r\n';
							content += `<div class="pl-item">
								<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
								<a class="pl-item-link pl-a" href="${decodeURIComponent(alink.link)}" title="ç‚¹å‡»ç”¨æ¯”ç‰¹å½—æ˜Ÿä¸‹è½½" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink.text)}<br/>ä¸‹è½½ ${filename}</a>
							</div>`;
						} else {
							alinkAllText += alink + '\r\n';
							content += `<div class="pl-item">
								<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
								<a class="pl-item-link pl-a" href="${decodeURIComponent(alink)}" title="ç‚¹å‡»ç”¨æ¯”ç‰¹å½—æ˜Ÿä¸‹è½½" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>ä¸‹è½½ ${filename}</a>
							</div>`;
						}
					}
				}
			});

			content += '</div>';

			if (mode === 'api')
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-tip listener-download-all" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œè‹¥æ–‡ä»¶è¿‡å¤§ä¸‹è½½å®Œæˆåæœ‰å¯èƒ½ä¸ä¼šå¼¹å‡ºçª—å£ï¼Œæ­¤æ—¶è¯·æ¢ç”¨â€œRPCä¸‹è½½ + Mortixâ€çš„ç»„åˆ<br/>åŸºäºæµè§ˆå™¨çš„ Blob æ–‡ä»¶æµä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒæ–°çš„æµè§ˆå™¨ï¼Œå¯ä»¥åœ¨æ­¤çª—å£ä¸­æ˜¾ç¤ºä¸‹è½½å‰©ä½™æ—¶é—´å’Œä¸‹è½½é€Ÿåº¦ï¼Œæ­¤æ–¹å¼ä¸‹è½½æœ‰å¯èƒ½ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥">å…¨éƒ¨å¢å¼ºä¸‹è½½</button><button class="pl-btn-primary listener-tip listener-copy-all" data-link="${alinkAllText}" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œåœ¨æœ¬ç½‘ç›˜å•ç‹¬å¤åˆ¶é“¾æ¥å¹¶ç²˜è´´ä¸‹è½½å¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨å›æŠ¥ 403 é”™è¯¯">å¤åˆ¶å…¨éƒ¨é“¾æ¥</button></div>`;
			if (mode === 'aria')
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨å‘½ä»¤è¡Œ</button></div>`;
			if (mode === 'rpc') {
				let rpc = base.getValue('setting_rpc_domain') + ':' + base.getValue('setting_rpc_port') + base.getValue('setting_rpc_path');
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-send-rpc">å‘é€å…¨éƒ¨é“¾æ¥</button><button title="${rpc}" class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px">ä¿®æ”¹ RPC å‚æ•°ï¼ˆ${rpc}ï¼‰</button><button class="pl-btn-primary pl-btn-success pl-btn-opacity listener-rpc-task" style="margin-left: 10px;display: none">æŸ¥çœ‹ä¸‹è½½ä»»åŠ¡</button></div>`;
			}
			if (mode === 'curl') {
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨å‘½ä»¤è¡Œ</button><button class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px;">ä¿®æ”¹ç»ˆç«¯ç±»å‹ï¼ˆ${terminalType[base.getValue('setting_terminal_type')]}ï¼‰</button></div>`;
			}
			if (mode === 'bc') {
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨é“¾æ¥</button></div>`;
			}
			return content;
		},

		async sendLinkToRPC(filename, link) {
			let rpc = {
				domain: base.getValue('setting_rpc_domain'),
				port: base.getValue('setting_rpc_port'),
				path: base.getValue('setting_rpc_path'),
				token: base.getValue('setting_rpc_token'),
				dir: base.getValue('setting_rpc_dir'),
			};
			let BDUSS = this.getBDUSS();
			if (!BDUSS) return 'assistant';

			let url = `${rpc.domain}:${rpc.port}${rpc.path}`;
			let rpcData = {
				id: new Date().getTime(),
				jsonrpc: '2.0',
				method: 'aria2.addUri',
				params: [`token:${rpc.token}`, [link], {
					dir: rpc.dir,
					out: filename,
					header: [`User-Agent: ${config.baidu.api.ua.downloadLink}`, `Cookie: BDUSS=${BDUSS}`]
				}]
			};
			try {
				let res = await base.post(url, rpcData, { "User-Agent": config.baidu.api.ua.downloadLink }, '');
				if (res.result) return 'success';
				return 'fail';
			} catch (e) {
				return 'fail';
			}
		},

		getSelectedList() {
			let List, selectList
			try {
				List = require("system-core:context/context.js").instanceForSystem.list;
				selectList = List.getSelected();
				/*if (!selectList.length) {
					selectList = List.getCurrentList();
				}*/
				return selectList;
			} catch (e) { }
			try {
				List = unsafeWindow.document.querySelector('.wp-s-core-pan');
				if (List && List.__vue__.selectedList) {
					selectList = List.__vue__.selectedList;
					return selectList;
				}
			} catch (e) { }
			try {
				List = unsafeWindow.document.querySelector('.file-list');
				if (List && List.__vue__.allFileList) {
					selectList = List.__vue__.allFileList.filter(function (item) { return !!item.selected; });
					return selectList;
				}
			} catch (e) { }
		},

		getLogid() {
			let ut = require("system-core:context/context.js").instanceForSystem.tools.baseService;
			return ut.base64Encode(base.getCookie("BAIDUID"));
		},

		getShareData() {
			let res = locals.dump();
			shareParams.shareType = 'secret';
			shareParams.sign = '';
			shareParams.timestamp = '';
			shareParams.bdstoken = res.bdstoken.value;
			shareParams.channel = 'chunlei';
			shareParams.clienttype = 0;
			shareParams.web = 1;
			shareParams.app_id = 250528;
			shareParams.encrypt = 0;
			shareParams.product = 'share';
			shareParams.logid = this.getLogid();
			shareParams.primaryid = res.shareid.value;
			shareParams.uk = res.share_uk.value;
			shareParams.shareType === 'secret' && (shareParams.extra = this._getExtra());
			shareParams.surl = this._getSurl();
		},

		detectPage() {
			let path = location.pathname;
			if (/^\/disk\/home/.test(path)) return 'home';
			if (/^\/disk\/main/.test(path)) return 'main';
			if (/^\/youth\/pan\/main/.test(path)) return 'youth';
			if (/^\/(s|share)\//.test(path)) return 'share';
			return '';
		},

		showMainDialog(title, html, footer) {
			Swal.fire({
				title,
				html,
				footer,
				customClass,
				position: 'center',
				padding: '15px 20px 5px',
				confirmButtonText: 'å…³é—­',
				showCloseButton: true,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				willClose: function () {
					base._resetData();
				},
				...swalDefault
			}).then(function () {
				base._resetData();
			});
		},

		async initAuthorize() {
			base.registerMenuCommand();
			Swal.fire({
				showConfirmButton: false,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				html: `è¯·ç¨å`,
				willOpen: function () {
					Swal.showLoading();
				},
				...swalDefault
			});
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				let url = new URL(location.href);
				let auth = new URL(config.baidu.api.getAccessToken);
				const allowedClientIds = [
					auth.searchParams.get("client_id"),
					'L6g70tBRRIXLsY0Z3HwKqlRE', // pcstest_oauth
					'fSds3K4w43rw37tOqlQmTa2kDwaczK4U', // å°åº¦æ™ºèƒ½è¯å…¸ç¬”ä¸“ä¸šç‰ˆ
					'TFwtw8uwHxpdkvVqVKdIlx1XqXUnr1zG', // å°è±¡ç¬”è®°
					'9dgBV9yesuBVOXaxls7aVHbLBLqU8yyg', // WPSæ–‡æ¡£
					'l9DdBOG4RYroMscmzK5OChdaGelgd92M', // å°çŒ´äº‘å°PCç‰ˆ
					'Kyr013gHQBf2immy3fQt1jZ3nZVpiGAm', // ç®€å•æ‰“å°
					'iYCeC9g08h5vuP9UqvPHKKSVrKFXGa1v', // Alist
					'IlLqBbU3GjQ0t46TRwFateTprHWl39zF',  // ç™¾åº¦æ‰‹æœºåŠ©æ‰‹
				];
				// https://openapi.baidu.com/oauth/2.0/authorize?response_type=code&client_id=&scope=basic,netdisk,mobile&display=page&redirect_uri=
				if (
					/openapi.baidu.com\/oauth\/2.0\/authorize/.test(location.href) &&
					url.searchParams.get("response_type").includes("token") &&
					url.searchParams.get("scope").includes("netdisk") &&
					allowedClientIds.includes(url.searchParams.get("client_id"))
				) {
					let dialog = await Swal.fire({
						icon: 'info',
						title: `æç¤º`,
						html: 'ä½ å¥½å‘€ï¼Œä¸ºäº†è·å–ç™¾åº¦ç½‘ç›˜æ–‡ä»¶çš„ä¸‹è½½ç›´é“¾<br/>æˆ‘ä»¬éœ€è¦æ‚¨çš„æˆæƒæ¥ä½¿ â€œä¸‹è½½åŠ©æ‰‹â€ è¯»å–æ‚¨çš„ç½‘ç›˜æ–‡ä»¶ä¿¡æ¯<br/><br/>ç”±äºä½¿ç”¨äº†åˆ«çš„åº”ç”¨IDï¼Œæ‰€ä»¥æˆæƒçš„åº”ç”¨åç§°ä¼šæœ‰ä¸åŒ<br/>è·å–åˆ°çš„æ•°æ®ä»…ç”¨äºç”Ÿæˆç›´é“¾ï¼Œè¯·æ”¾å¿ƒæˆæƒãƒ¾(â‰§â–½â‰¦*)o',
						showConfirmButton: true,
						showDenyButton: true,
						allowOutsideClick: false,
						allowEscapeKey: false,
						allowEnterKey: false,
						confirmButtonText: 'æˆæƒ',
						denyButtonText: 'å†æƒ³æƒ³',
						position: 'center'
					});
					if (dialog.isConfirmed) {
						base.waitForKeyElements("button#auth-allow", function (element) {
							element[0].click();
						})
						return;
					}
					if (dialog.isDenied) {
						return await Swal.fire({
							icon: 'question',
							title: `å¥½å§(*ï¿£3ï¿£)â•­`,
							html: 'é‚£å°±å†æƒ³ä¸€æƒ³<br/>æƒ³å¥½äº†å°±æŒ‰ä¸‹ â€œæˆæƒâ€ æŒ‰é’®å§~',
							timer: 180000,
							toast: true,
							timerProgressBar: true,
							showConfirmButton: false,
							showDenyButton: false,
							position: 'bottom-end',
						})
					}
				} else if (/openapi.baidu.com\/oauth\/2.0\/login_success/.test(location.href)) {
					let int = setInterval(async function () {
						if (location.href.includes('access_token') && (location.href.includes('basic+netdisk') || location.href.includes('basic,netdisk'))) {
							clearInterval(int)
							let token = location.href.match(/access_token=(.*?)&/)[1];
							base.setValue('baidu_access_token', token);
							let dialog = await Swal.fire({
								icon: 'success',
								title: `æˆåŠŸå•¦`,
								html: 'ä½ å·² æˆåŠŸæˆæƒ/æˆæƒè¿‡ è„šæœ¬è¯»å–æ‚¨çš„ç½‘ç›˜æ–‡ä»¶ä¿¡æ¯~<br/>ç­‰å¾… <span id="second">3</span> ç§’ä¹‹åå°†å…³é—­æ­¤é¡µé¢',
								timer: 3000,
								timerProgressBar: true,
								showConfirmButton: true,
								showDenyButton: false,
								allowOutsideClick: false,
								allowEscapeKey: false,
								allowEnterKey: false,
								confirmButtonText: 'å…³é—­é¡µé¢',
								position: 'center',
								willOpen: function () {
									let sec = 3.1;
									setInterval(() => {
										sec -= 0.1;
										document.getElementById("second").innerText = sec.toFixed(1);
									}, 100);
									setTimeout(() => {
										window.close()
									}, 3100);
								},
							});
							if (dialog.isConfirmed) {
								window.close()
								return;
							}
						} else {
							clearInterval(int)
							Swal.close()
						}
					}, 1)
				} else {
					Swal.close()
				}
			} else {
				Swal.close()
			}
		},

		async initPanLinker() {
			page = this.detectPage();
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
				this.addPageListener();
			} else {
				this.addInitButton();
			}
		},
	};

	//é˜¿é‡Œäº‘ç›˜
	let ali = {
		convertLinkToAria(link, filename, ua) {
			filename = base.fixFilename(filename);
			return encodeURIComponent(`aria2c "${link}" --out "${filename}" --header "Referer: https://${location.host}/"`);
		},

		convertLinkToBC(link, filename, ua) {
			let bc = `AA/${encodeURIComponent(filename)}/?url=${encodeURIComponent(link)}&refer=${encodeURIComponent(`https://${location.host}/`)}ZZ`;
			return encodeURIComponent(`bc://http/${base.encode(bc)}`);
		},

		convertLinkToCurl(link, filename, ua) {
			let terminal = base.getValue('setting_terminal_type');
			filename = base.fixFilename(filename);
			return encodeURIComponent(`${terminal !== 'wp' ? 'curl' : 'curl.exe'} -L -C - "${link}" -o "${filename}" -e "https://${location.host}/"`);
		},

		addPageListener() {
			/*
			é˜²æ­¢ä»£ç å› å…¶ä»–åŸå› è¢«æ‰§è¡Œå¤šæ¬¡
			è¿™æ®µä»£ç å‡ºè‡ª Viaè½»æ’ä»¶ï¼Œä½œè€…è°·èŠ±æ³°
			*/
			const key = encodeURIComponent('ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹:é˜¿é‡Œäº‘ç›˜');
			if (window[key]) return;
			window[key] = true;

			function _factory(e) {
				let target = $(e.target);
				let item = target.parents('.pl-item');
				let link = item.find('.pl-item-link.blob');
				let directLink = item.find('.pl-item-link.browser');
				let progress = item.find('.pl-item-progress');
				let tip = item.find('.pl-item-tip');
				let copy = item.find('.pl-item-copy');
				let howidm = item.find('.pl-progress-how');
				let back = item.find('.pl-progress-back');
				let stop = item.find('.pl-progress-stop');
				return {
					item, link, directLink, progress, tip, copy, howidm, back, stop, target,
				};
			}

			function _reset(i) {
				ins[i] && clearInterval(ins[i]);
				request[i] && request[i].abort();
				progress[i] = 0;
				idm[i] = false;
			}
			doc.on('click', '.pl-button-mode', function (e) {
				mode = e.target.dataset.mode;
				if (!mode) return;
				Swal.fire({
					showConfirmButton: false,
					allowOutsideClick: false,
					allowEscapeKey: false,
					allowEnterKey: false,
					html: `<div id="loadingText">é“¾æ¥è·å–ä¸­</div>`,
					willOpen: function () {
						Swal.showLoading();
					},
					...swalDefault
				});
				ali.getPCSLink();
			});
			doc.on('click', '.listener-link-api.browser', async function (e) {
				e.preventDefault();
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				$('#downloadIframe').attr('src', href);
			});
			doc.on('click', '.listener-link-api.blob', async function (e) {
				e.preventDefault();
				let o = _factory(e);
				let $width = o.item.find('.pl-progress-inner');
				let $text = o.item.find('.pl-progress-inner-text');
				let filename = o.link[0].dataset.filename;
				let index = o.link[0].dataset.index;
				_reset(index);
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				//let url = await this.getRealLink(dataset.did, dataset.fid);
				//if (url) href = url;
				base.get(href, { "Referer": `https://${location.host}/` }, 'blob', { filename, index });
				let startTime = Date.now(); // è®°å½•ä¸‹è½½å¼€å§‹æ—¶é—´
				let prevLoaded = 0; // ä¸Šä¸€æ¬¡çš„å·²ä¸‹è½½æ•°æ®é‡
				let prevTime = startTime; // ä¸Šä¸€æ¬¡çš„æ—¶é—´
				let size = Number(o.link[0].dataset.size);
				ins[index] = setInterval(function () {
					let prog = +progress[index] || 0;
					// å¤„ç†æ™®é€šä¸‹è½½çš„æƒ…å†µ...
					let currentTime = Date.now();
					let elapsedTime = currentTime - startTime;
					let totalProgress = prog / 100;
					let totalElapsedSeconds = elapsedTime / 1000;
					let estimatedTotalTimeSeconds = totalElapsedSeconds / totalProgress;
					let remainingTimeSeconds = estimatedTotalTimeSeconds - totalElapsedSeconds;

					// å°†å‰©ä½™æ—¶é—´è½¬æ¢ä¸ºå¤©ã€æ—¶ã€åˆ†ã€ç§’
					let remainingDays = Math.floor(remainingTimeSeconds / (60 * 60 * 24));
					remainingTimeSeconds %= (60 * 60 * 24);

					let remainingHours = Math.floor(remainingTimeSeconds / (60 * 60));
					remainingTimeSeconds %= (60 * 60);

					let remainingMinutes = Math.floor(remainingTimeSeconds / 60);
					let remainingSeconds = Math.floor(remainingTimeSeconds % 60);

					// è®¡ç®—ä¸‹è½½é€Ÿåº¦
					let loaded = prog * size / 100; // å·²ä¸‹è½½æ•°æ®é‡
					let currentTimeDiff = currentTime - prevTime; // å½“å‰æ—¶é—´ä¸ä¸Šä¸€æ¬¡æ—¶é—´çš„å·®å€¼
					let loadedDiff = loaded - prevLoaded; // å½“å‰å·²ä¸‹è½½æ•°æ®é‡ä¸ä¸Šä¸€æ¬¡çš„å·®å€¼
					let downloadSpeed = (currentTimeDiff !== 0) ? loadedDiff / (currentTimeDiff / 1000) : 0; // ä¸‹è½½é€Ÿåº¦ï¼ˆå•ä½ï¼šå­—èŠ‚/ç§’ï¼‰

					// æ›´æ–°ä¸Šä¸€æ¬¡çš„æ•°æ®
					prevLoaded = loaded;
					prevTime = currentTime;

					// æ›´æ”¹ç•Œé¢
					o.link.hide();
					o.directLink.hide();
					o.tip.hide();
					o.stop.show();
					o.copy.hide();
					o.progress.show();

					// æ›´æ–°è¿›åº¦æ¡
					$width.css('width', prog + '%');

					// æ›´æ–°è¿›åº¦æ¡æ–‡æœ¬
					let timeText = '';
					if (Number.isFinite(remainingDays) && remainingDays > 0) {
						timeText = remainingDays + 'å¤© ' + base.repairTimer(remainingHours) + 'æ—¶:' + base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
					} else if (Number.isFinite(remainingHours) && remainingHours > 0) {
						timeText = base.repairTimer(remainingHours) + 'æ—¶:' + base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
					} else if (Number.isFinite(remainingMinutes) && remainingMinutes > 0) {
						timeText = base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
					} else if (Number.isFinite(remainingSeconds) && remainingSeconds > 0) {
						timeText = remainingSeconds + 'ç§’';
					} else if (Number.isFinite(remainingSeconds) && remainingSeconds === 0) {
						timeText = 'å³å°†å®Œæˆ';
					} else {
						timeText = 'è®¡ç®—ä¸­...';
					}

					let speedText = '';
					speedText = base.sizeFormat(downloadSpeed)

					$text.text(prog + '% | å‰©ä½™æ—¶é—´ï¼š' + timeText + ' | é€Ÿåº¦ï¼š' + speedText + '/ç§’');

					if (prog === 100) {
						setTimeout(function () {
							clearInterval(ins[index]);
							progress[index] = 0;
							o.item.find('.pl-progress-stop').hide();
							o.howidm.hide();
							$text.text('ä¸‹è½½å®Œæˆ~ æµè§ˆå™¨ä¸‹è½½æ¡†åº”è¯¥å¼¹å‡ºæ¥äº†å“¦~');
							o.back.show()
							setTimeout(function () {
								o.link.text('å¢å¼ºä¸‹è½½(åŸºäºæµè§ˆå™¨æ–‡ä»¶æµ)').animate({ opacity: '1' }, "slow");
							}, 3000)
						}, 1000)
					}
				}, 500);
			});
			doc.on('click', '.listener-retry', async function (e) {
				let o = _factory(e);
				o.tip.hide();
				o.link.show();
				o.directLink.show();
			});
			doc.on('click', '.listener-stop', async function (e) {
				let o = _factory(e);
				let index = o.link[0].dataset.index;
				if (request[index]) {
					request[index].abort();
					clearInterval(ins[index]);
					o.item.find('.pl-progress-inner-text').text('æ­£åœ¨å–æ¶ˆ...');
					o.item.find('.pl-progress-inner').css('width', 100 + '%');
					setTimeout(function () {
						o.tip.hide();
						o.back.hide();
						o.link.show();
						o.directLink.show();
						o.copy.show();
						o.progress.hide();
						o.stop.hide();
					}, 1050)
				}
			});
			doc.on('click', '.listener-back', async function (e) {
				let o = _factory(e);
				o.progress.hide();
				o.tip.hide();
				o.link.show();
				o.directLink.show();
				o.copy.show();
				o.stop.hide();
				o.back.hide();
			});
			doc.on('click', '.listener-copy-filename', async function (e) {
				base.setClipboard(e.target.dataset.filename);
				$(e.target).text('å¤åˆ¶æˆåŠŸ').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('é‡æ–°å¤åˆ¶').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-aria, .listener-copy-all', function (e) {
				e.preventDefault();
				base.setClipboard(decodeURIComponent(e.target.dataset.link));
				$(e.target).text('å¤åˆ¶æˆåŠŸ').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('é‡æ–°å¤åˆ¶').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-rpc', async function (e) {
				let target = $(e.currentTarget);

				target.find('.icon-rpc-devices').remove();
				target.find('.pl-loading').remove();
				target.prepend(base.createLoading());

				let res = await ali.sendLinkToRPC(e.currentTarget.dataset.filename, e.currentTarget.dataset.link);
				if (res === 'success') {
					$('.listener-rpc-task').show();
					target.removeClass('pl-btn-danger').html('å‘é€æˆåŠŸäº†!å¿«å»çœ‹çœ‹å§~').animate({ opacity: '0.5' }, "slow");
				} else if (res === 'assistant') {
					target.addClass('pl-btn-danger').html(`${config.base.assistant.message}ğŸ‘‰<a href="${config.base.assistant.link}" target="_blank" class="pl-a">ç‚¹å‡»æ­¤å¤„å®‰è£…</a>ğŸ‘ˆ`);
				} else {
					target.addClass('pl-btn-danger').text('å‘é€å¤±è´¥ï¼Œæ£€æŸ¥ä¸€ä¸‹æ‚¨çš„RPCé…ç½®ä¿¡æ¯å“¦!').animate({ opacity: '0.5' }, "slow");
				}
			});
			doc.on('click', '.listener-send-rpc', function (e) {
				$('.listener-link-rpc').click();
				$(e.target).text('å‘é€å®Œæˆï¼Œå‘é€ç»“æœè§ä¸Šæ–¹æŒ‰é’®å“¦~').animate({ opacity: '0.5' }, "slow");
			});
			doc.on('click', '.listener-download-all.blob', function (e) {
				$('.pl-item-link.blob').each(function () {
					if ($(this).css('display') !== 'none') {
						$(this).click();
					}
				});
				$(e.target).text('ä¸‹è½½å¼€å§‹ï¼Œä¸‹è½½è¿›åº¦è§ä¸Šæ–¹æŒ‰é’®å“¦~').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('å…¨éƒ¨å¢å¼ºä¸‹è½½').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdateLog();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-rpc-task', function () {
				let rpc = JSON.stringify({
					domain: base.getValue('setting_rpc_domain'),
					port: base.getValue('setting_rpc_port'),
				}), url = `${config.base.service.rpc}/?rpc=${base.encode(rpc)}#${base.getValue('setting_rpc_token')}`;
				GM_openInTab(url, { active: true });
			});
			document.documentElement.addEventListener('mouseup', function (e) {
				if (e.target.nodeName === 'A' && ~e.target.className.indexOf('pl-a')) {
					e.stopPropagation();
				}
			}, true);
		},

		async getRealLink(d, f) {
			let authorization = `${base.getStorage('token').token_type} ${base.getStorage('token').access_token}`;
			let res = await base.post(config.ali.api.getLink, {
				drive_id: d,
				file_id: f
			}, {
				authorization,
				"content-type": "application/json;charset=utf-8",
				"referer": "https://www.aliyundrive.com/",
				"x-canary": "client=windows,app=adrive,version=v6.0.0"
			});
			if (res.code === 'AccessTokenInvalid') {
				return message.error('æç¤ºï¼š<br/>è®¿é—®ä»¤ç‰Œè¿‡æœŸäº†ï¼Œè¯·åˆ·æ–°ç½‘é¡µåå†è¯•');
			}
			if (res.url) {
				return res.url;
			}
			return '';
		},

		removeAD() {
			base.waitForKeyElements('[class*="share-list-banner"]', function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements('[class*="to-app"]', function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements('[class*="btn-mobile-save"]', function (tag) {
				tag.fadeOut();
			});
			base.waitForKeyElements('div[class*="text"]', function (tag) {
				if (tag[0].innerHTML.match("SVIP"))
					tag.fadeOut();
			}, true);
			base.waitForKeyElements('[class*="SplashScreenImg--close"]', function (tag) {
				tag[0].click();
			}, true);
			base.waitForKeyElements('[class*="container"]', function (tag) {
				tag.find('[class^="icon-close"]').click();
			}, true);
			base.waitForKeyElements('[class*="popup_main_close"]', function (tag) {
				tag[0].click();
			}, true);
		},

		addButton() {
			if (!page) return;
			let $toolWrap;
			let svg = `<svg class="ali-btn-icon" style="margin-right: 3px;" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M853.333 938.667H170.667a85.333 85.333 0 0 1-85.334-85.334v-384A85.333 85.333 0 0 1 170.667 384H288a32 32 0 0 1 0 64H170.667a21.333 21.333 0 0 0-21.334 21.333v384a21.333 21.333 0 0 0 21.334 21.334h682.666a21.333 21.333 0 0 0 21.334-21.334v-384A21.333 21.333 0 0 0 853.333 448H736a32 32 0 0 1 0-64h117.333a85.333 85.333 0 0 1 85.334 85.333v384a85.333 85.333 0 0 1-85.334 85.334z" fill="#FFFFFF"></path><path d="M715.03 543.552a32.81 32.81 0 0 0-46.251 0L554.005 657.813v-540.48a32 32 0 0 0-64 0v539.734L375.893 543.488a32.79 32.79 0 0 0-46.229 0 32.427 32.427 0 0 0 0 46.037l169.557 168.811a32.81 32.81 0 0 0 46.251 0l169.557-168.81a32.47 32.47 0 0 0 0-45.974z" fill="#FFFFFF"></path></svg>`
			let $button = $(`<div class="ali-button pl-button"><span data-role="icon" data-render-as="svg" class="icon">${svg}ä¸‹è½½åŠ©æ‰‹</span><ul class="pl-dropdown-menu" style="top: 30px; right: 0;"><li class="pl-dropdown-menu-item pl-button-mode" data-mode="api">APIä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="aria" >Ariaä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="rpc">RPCä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="curl">cURLä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="bc" >BCä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">åŠ©æ‰‹è®¾ç½®</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">åŠ©æ‰‹ç¾åŒ–</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">æ›´æ–°æ—¥å¿—</li></ul></div>`);
			if (page === 'home') {
				base.listenElement(config.ali.mount.home, function () {
					$toolWrap = $(config.ali.mount.home);
					$('.pl-button').length === 0 && $toolWrap.append($button);
				})
			}
			if (page === 'share') {
				$button = $(`<div class="ali-button pl-button"><span data-role="icon" data-render-as="svg" class="icon">${svg}ä¸‹è½½åŠ©æ‰‹</span><ul class="pl-dropdown-menu" style="top: 30px; right: 16px;"><li class="pl-dropdown-menu-item pl-button-mode" data-mode="api">APIä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="aria" >Ariaä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="rpc">RPCä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="curl">cURLä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="bc" >BCä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">åŠ©æ‰‹è®¾ç½®</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">åŠ©æ‰‹ç¾åŒ–</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">æ›´æ–°æ—¥å¿—</li></ul></div>`);
				$button.css({ 'margin-right': '10px', "height": "36px", "width": "auto", "padding": "1px 30px" });
				base.listenElement(config.ali.mount.share, function () {
					$toolWrap = $(config.ali.mount.share);
					$('.pl-button').length === 0 && $toolWrap.prepend($button);
				})
			}
			base.createDownloadIframe();
		},

		addInitButton() {
			if (!page) return;
			let $toolWrap;
			let $button = $(`<div class="ali-button pl-button-init"><span data-role="icon" data-render-as="svg" class="icon"><svg class="ali-btn-icon" style="margin-right: 3px;" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M853.333 938.667H170.667a85.333 85.333 0 0 1-85.334-85.334v-384A85.333 85.333 0 0 1 170.667 384H288a32 32 0 0 1 0 64H170.667a21.333 21.333 0 0 0-21.334 21.333v384a21.333 21.333 0 0 0 21.334 21.334h682.666a21.333 21.333 0 0 0 21.334-21.334v-384A21.333 21.333 0 0 0 853.333 448H736a32 32 0 0 1 0-64h117.333a85.333 85.333 0 0 1 85.334 85.333v384a85.333 85.333 0 0 1-85.334 85.334z" fill="#FFFFFF"></path><path d="M715.03 543.552a32.81 32.81 0 0 0-46.251 0L554.005 657.813v-540.48a32 32 0 0 0-64 0v539.734L375.893 543.488a32.79 32.79 0 0 0-46.229 0 32.427 32.427 0 0 0 0 46.037l169.557 168.811a32.81 32.81 0 0 0 46.251 0l169.557-168.81a32.47 32.47 0 0 0 0-45.974z" fill="#FFFFFF"></path></svg>ç‚¹æˆ‘ç‚¹äº®</span></div>`);
			$button.css({ "width": "auto" });
			if (page === 'home') {
				base.listenElement(config.ali.mount.home, function () {
					$toolWrap = $(config.ali.mount.home);
					$('.pl-button-init').length === 0 && $toolWrap.append($button);
				})
			}
			if (page === 'share') {
				$button = $(`<div class="ali-button pl-button-init"><span data-role="icon" data-render-as="svg" class="icon"><svg class="ali-btn-icon" style="margin-right: 3px;" viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" width="16" height="16"><path d="M853.333 938.667H170.667a85.333 85.333 0 0 1-85.334-85.334v-384A85.333 85.333 0 0 1 170.667 384H288a32 32 0 0 1 0 64H170.667a21.333 21.333 0 0 0-21.334 21.333v384a21.333 21.333 0 0 0 21.334 21.334h682.666a21.333 21.333 0 0 0 21.334-21.334v-384A21.333 21.333 0 0 0 853.333 448H736a32 32 0 0 1 0-64h117.333a85.333 85.333 0 0 1 85.334 85.333v384a85.333 85.333 0 0 1-85.334 85.334z" fill="#FFFFFF"></path><path d="M715.03 543.552a32.81 32.81 0 0 0-46.251 0L554.005 657.813v-540.48a32 32 0 0 0-64 0v539.734L375.893 543.488a32.79 32.79 0 0 0-46.229 0 32.427 32.427 0 0 0 0 46.037l169.557 168.811a32.81 32.81 0 0 0 46.251 0l169.557-168.81a32.47 32.47 0 0 0 0-45.974z" fill="#FFFFFF"></path></svg>ç‚¹æˆ‘ç‚¹äº®</span></div>`);
				$button.css({ 'margin-right': '10px', "height": "36px", "padding": "1px 30px", "width": "auto" });
				base.listenElement(config.ali.mount.share, function () {
					$toolWrap = $(config.ali.mount.share);
					$('.pl-button-init').length === 0 && $toolWrap.prepend($button);
				})
			}
			$button.click(function () { base.initDialog() });
		},

		async getPCSLink() {
			let reactDomGrid = document.querySelector(config.ali.mount.grid);
			if (reactDomGrid) {
				let dialog = await Swal.fire({
					title: 'æç¤º',
					html: '<div style="display: flex;align-items: center;justify-content: center;">è¯·åˆ‡æ¢åˆ°&nbsp;&nbsp;<svg class="icon" class="icon--D3kMk " viewBox="0 0 1024 1024" width="20" height="20"><use xlink:href="#PDSDrag"></use></svg>&nbsp;<b>åˆ—è¡¨è§†å›¾</b>&nbsp;&nbsp;åè·å–ä¸‹è½½é“¾æ¥</div>',
					icon: 'info',
					showCloseButton: true,
					showDenyButton: true,
					confirmButtonText: 'åˆ‡æ¢',
					denyButtonText: 'ä¸è¦',
					...swalDefault
				});
				if (dialog.isConfirmed) {
					document.querySelector(config.ali.mount.switch).click();
					return message.success('æç¤ºï¼š<br/>åˆ‡æ¢ä¸ºåˆ—è¡¨è§†å›¾æˆåŠŸ<br/>è¯·å†è·å–ä¸€æ¬¡ä¸‹è½½é“¾æ¥å§~');
				}
				return false;
			}
			selectList = this.getSelectedList();
			if (selectList.length === 0) {
				return message.error('æç¤ºï¼š<br/>è¯·å‹¾é€‰è¦ä¸‹è½½çš„æ–‡ä»¶å“¦~');
			}
			if (this.isOnlyFolder()) {
				return message.error('æç¤ºï¼š<br/>è¯·æ‰“å¼€æ–‡ä»¶å¤¹åå†å‹¾é€‰æ–‡ä»¶~');
			}
			if (page === 'share') {
				try {
					let authorization = `${base.getStorage('token').token_type} ${base.getStorage('token').access_token}`;
					let xShareToken = base.getStorage('shareToken').share_token;

					// æ¯æ¬¡è·å–å¤šå°‘ä¸ª
					const batchSize = 15;
					let processed = 0;

					// å¾ªç¯åˆ†æ‰¹è·å–æ–‡ä»¶çš„ä¸‹è½½é“¾æ¥
					for (let i = 0; i < selectList.length; i += batchSize) {
						// å½“å‰æ‰¹æ¬¡æ–‡ä»¶
						let batch = selectList.slice(i, i + batchSize);

						// éå†è·å–æœ¬æ‰¹æ¬¡çš„è¯·æ±‚ç»“æœ
						for (let j = 0; j < batch.length; j++) {
							let item = batch[j];
							let res = await base.post(config.ali.api.getShareLink, {
								expire_sec: 600,
								file_id: item.fileId,
								share_id: item.shareId
							}, {
								authorization,
								"content-type": "application/json;charset=utf-8",
								"x-share-token": xShareToken
							});

							// å¦‚æœæˆåŠŸè·å–åˆ°ä¸‹è½½é“¾æ¥ï¼Œæ›´æ–°å½“å‰æ–‡ä»¶çš„ä¸‹è½½URL
							if (res.download_url) {
								processed++;
								item.downloadUrl = res.download_url;
							}
						}

						doc.find('#loadingText').html(`<div>é“¾æ¥è·å–ä¸­</div><div>å·²è·å– ${processed} ä¸ªé“¾æ¥ï¼Œè¯·è€å¿ƒç­‰å¾…å“¦~</div>`);

						// æ¯æ¬¡å¤„ç†å®Œä¸€ä¸ªæ‰¹æ¬¡åï¼Œç­‰å¾… 2 ç§’
						await base.sleep(1000);
					}
				} catch (e) {
					return message.error('æç¤ºï¼š<br/>è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œæ¥å£å·²å¤±æ•ˆï¼Œè¯·ä¿å­˜åå†ä¸‹è½½~');
				}
			} else {
				// æ¯æ¬¡è·å–å¤šå°‘ä¸ª
				let batchSize = 15;
				let processed = 0;

				// å¾ªç¯åˆ†æ‰¹è·å–æ–‡ä»¶çš„ä¸‹è½½é“¾æ¥
				for (let i = 0; i < selectList.length; i += batchSize) {
					// å½“å‰æ‰¹æ¬¡æ–‡ä»¶
					let batch = selectList.slice(i, i + batchSize);

					// è¿‡æ»¤æ‰å·²æœ‰ URL çš„æ–‡ä»¶
					let noUrlSelectList = batch.filter(v => !Boolean(v.url));
					let hasUrlSelectList = batch.filter(v => Boolean(v.url));
					let queue = [];

					// ä¸ºæ²¡æœ‰ URL çš„æ–‡ä»¶ç”Ÿæˆè¯·æ±‚é˜Ÿåˆ—
					noUrlSelectList.forEach((item) => {
						queue.push(this.getRealLink(item.driveId, item.fileId));
					});

					hasUrlSelectList.forEach((item) => {
						processed++;
					});

					// ç­‰å¾…æœ¬æ‰¹æ¬¡çš„è¯·æ±‚ç»“æœ
					const res = await Promise.all(queue);
					res.forEach((val, index) => {
						noUrlSelectList[index].url = val;
						processed++;
					});

					doc.find('#loadingText').html(`<div>é“¾æ¥è·å–ä¸­</div><div>å·²è·å– ${processed} ä¸ªé“¾æ¥ï¼Œè¯·è€å¿ƒç­‰å¾…å“¦~</div>`);

					// æ¯æ¬¡å¤„ç†å®Œä¸€ä¸ªæ‰¹æ¬¡åï¼Œç­‰å¾… 1 ç§’
					await base.sleep(1000);
				}
			}

			let html = this.generateDom(selectList);
			this.showMainDialog(config.base.dom.button[mode].title, html, config.base.dom.button[mode].footer);
		},

		generateDom(list) {
			if (!list) {
				return message.error('æç¤ºï¼š<br/>è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œåˆ·æ–°ç½‘é¡µåå†è¯•è¯•å§~');
			}
			let content = '<div class="pl-main">';
			let alinkAllText = '';
			list.forEach((v, i) => {
				if (v.type === 'folder') return;
				let filename = v.name;
				let fid = v.fileId;
				let did = v.driveId;
				let size = base.sizeFormat(v.size);
				let dlink = v.downloadUrl || v.url;
				if (!dlink || !dlink.includes("http")) {
					content += `<div class="pl-item">
						<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
						<div class="pl-item-tip">è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œåˆ·æ–°ç½‘é¡µåå†è¯•è¯•å§~</div>
					</div>`;
				} else {
					if (mode === 'api') {
						alinkAllText += dlink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}" >${filename}</div>
							<button class="pl-item-link listener-tip pl-btn-primary listener-link-api blob" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œè‹¥æ–‡ä»¶è¿‡å¤§ä¸‹è½½å®Œæˆåæœ‰å¯èƒ½ä¸ä¼šå¼¹å‡ºçª—å£ï¼Œæ­¤æ—¶è¯·æ¢ç”¨â€œRPCä¸‹è½½ + Mortixâ€çš„ç»„åˆ<br/>åŸºäºæµè§ˆå™¨çš„ Blob æ–‡ä»¶æµä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒæ–°çš„æµè§ˆå™¨ï¼Œå¯ä»¥åœ¨æ­¤çª—å£ä¸­æ˜¾ç¤ºä¸‹è½½å‰©ä½™æ—¶é—´å’Œä¸‹è½½é€Ÿåº¦ï¼Œæ­¤æ–¹å¼ä¸‹è½½ä¸ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥" data-did="${did}" data-fid="${fid}" data-filename="${filename}" data-link="${dlink}" data-size="${v.size}" data-index="${i}">å¢å¼ºä¸‹è½½(åŸºäºæµè§ˆå™¨æ–‡ä»¶æµ)</button>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-info listener-link-api browser" data-title="åŸºäºæµè§ˆå™¨ç›´æ¥æ‰“å¼€é“¾æ¥æ¥ä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒä¸ºå¤è€ä½†æ”¯æŒ iframe çš„æµè§ˆå™¨ï¼Œç‚¹å‡»â€œç›´æ¥ä¸‹è½½â€åéœ€ç­‰å¾…ä¸‹è½½æç¤ºå¼¹å‡ºæ‰èƒ½ç‚¹å‡»ä¸‹ä¸ªâ€œç›´æ¥ä¸‹è½½â€ï¼Œå¦åˆ™åªä¼šä¸‹è½½åè€…ï¼Œæ­¤æ–¹å¼ä¸‹è½½æœ‰å¯èƒ½ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥" data-did="${did}" data-fid="${fid}" data-filename="${filename}" data-link="${dlink}" data-index="${i}">ç›´æ¥ä¸‹è½½(åŸºäºæµè§ˆå™¨é“¾æ¥)</button>
							<button class="pl-item-copy listener-tip pl-btn-primary pl-btn-success listener-copy-filename" data-title="æœ¬ç½‘ç›˜äºä¸‹è½½é«˜å³°æœŸæ—¶å¯èƒ½ä¸ä¼šæ˜¾ç¤ºæ–‡ä»¶åç§°ï¼Œè¿™æ—¶éœ€è¦æ‰‹åŠ¨å¤åˆ¶æ–‡ä»¶åç§°åˆ°ä¸‹è½½å·¥å…·ä¸­" data-filename="${filename}">å¤åˆ¶åç§°</button>
							<button class="pl-item-copy listener-tip pl-btn-primary pl-btn-warning listener-copy-all" href="${dlink}" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œåœ¨æœ¬ç½‘ç›˜å•ç‹¬å¤åˆ¶é“¾æ¥å¹¶ç²˜è´´ä¸‹è½½å¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨å›æŠ¥ 403 é”™è¯¯" data-filename="${filename}" data-link="${dlink}">å¤åˆ¶é“¾æ¥</button>
							<div class="pl-item-tip" style="display: none"><span><span class="pl-ext"></span></span> <span class="listener-back">è¿”å›</span></div>
							<div class="pl-item-progress" style="display: none">
								<div class="pl-progress">
									<div class="pl-progress-outer"></div>
									<div class="pl-progress-inner" style="width:5%">
									<div class="pl-progress-inner-text">æ­£åœ¨åŠ è½½è¿›åº¦...0%</div>
									</div>
								</div>
								<span class="pl-btn-primary pl-btn-danger pl-progress-stop listener-stop">å–æ¶ˆä¸‹è½½</span>
								<span class="pl-btn-primary pl-btn-info pl-progress-back listener-back" style="display: none">è¿”å›</span>
							</div>
						</div>`;
					}
					if (mode === 'aria') {
						let alink = this.convertLinkToAria(dlink, filename, navigator.userAgent);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="ç‚¹å‡»å¤åˆ¶ aria2c å‘½ä»¤è¡Œ" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>å¤åˆ¶ ${filename} ä¸‹è½½å‘½ä»¤è¡Œ</a>
						</div>`;
					}
					if (mode === 'rpc') {
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<button class="pl-item-link listener-link-rpc pl-btn-primary pl-btn-info" data-filename="${filename}" data-link="${dlink.replace(' ', '%20')}"><svg class="icon-rpc-devices" viewBox="-10 0 1034 1024"><g transform="matrix(1 0 0 -1 0 960)"><path fill="currentColor" d="M832 -64h-640q-53 0 -90.5 37.5t-37.5 90.5v768q0 53 37.5 90.5t90.5 37.5h640q53 0 90.5 -37.5t37.5 -90.5v-768q0 -53 -37.5 -90.5t-90.5 -37.5zM832 768q0 27 -18.5 45.5t-45.5 18.5h-512q-27 0 -45.5 -18.5t-18.5 -45.5v-320h640v320v0zM832 320h-640v-192q0 -27 18.5 -45.5t45.5 -18.5h512q27 0 45.5 18.5t18.5 45.5v192v0zM512 128q-27 0 -45.5 18.5t-18.5 45.5t18.5 45.5t45.5 18.5t45.5 -18.5t18.5 -45.5t-18.5 -45.5t-45.5 -18.5z" /></g></svg><span style="margin-left: 5px;">å°† ${filename} æ¨é€åˆ° RPC ä¸‹è½½å™¨</span></button>
						</div>`;
					}
					if (mode === 'curl') {
						let alink = this.convertLinkToCurl(dlink, filename, navigator.userAgent);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="ç‚¹å‡»å¤åˆ¶ curl å‘½ä»¤è¡Œ" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>å¤åˆ¶ ${filename} ä¸‹è½½å‘½ä»¤è¡Œ</a>
						</div>`;
					}
					if (mode === 'bc') {
						let alink = this.convertLinkToBC(dlink, filename, navigator.userAgent);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<a class="pl-item-link" href="${decodeURIComponent(alink)}" title="ç‚¹å‡»ç”¨æ¯”ç‰¹å½—æ˜Ÿä¸‹è½½" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>ä¸‹è½½ ${filename}</a>
						</div>`;
					}
				}
			});
			content += '</div>';
			if (mode === 'api')
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-tip listener-download-all blob" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œè‹¥æ–‡ä»¶è¿‡å¤§ä¸‹è½½å®Œæˆåæœ‰å¯èƒ½ä¸ä¼šå¼¹å‡ºçª—å£ï¼Œæ­¤æ—¶è¯·æ¢ç”¨â€œRPCä¸‹è½½ + Mortixâ€çš„ç»„åˆ<br/>åŸºäºæµè§ˆå™¨çš„ Blob æ–‡ä»¶æµä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒæ–°çš„æµè§ˆå™¨ï¼Œå¯ä»¥åœ¨æ­¤çª—å£ä¸­æ˜¾ç¤ºä¸‹è½½å‰©ä½™æ—¶é—´å’Œä¸‹è½½é€Ÿåº¦ï¼Œæ­¤æ–¹å¼ä¸‹è½½ä¸ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥">å…¨éƒ¨å¢å¼ºä¸‹è½½</button><button class="pl-btn-primary listener-tip listener-copy-all" data-link="${alinkAllText}" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œåœ¨æœ¬ç½‘ç›˜å•ç‹¬å¤åˆ¶é“¾æ¥å¹¶ç²˜è´´ä¸‹è½½å¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨å›æŠ¥ 403 é”™è¯¯">å¤åˆ¶å…¨éƒ¨é“¾æ¥</button></div>`;
			if (mode === 'aria')
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨å‘½ä»¤è¡Œ</button></div>`;
			if (mode === 'rpc') {
				let rpc = base.getValue('setting_rpc_domain') + ':' + base.getValue('setting_rpc_port') + base.getValue('setting_rpc_path');
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-send-rpc">å‘é€å…¨éƒ¨é“¾æ¥</button><button title="${rpc}" class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px">ä¿®æ”¹ RPC å‚æ•°ï¼ˆ${rpc}ï¼‰</button><button class="pl-btn-primary pl-btn-success pl-btn-opacity listener-rpc-task" style="margin-left: 10px;display: none">æŸ¥çœ‹ä¸‹è½½ä»»åŠ¡</button></div>`;
			}
			if (mode === 'curl') {
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨å‘½ä»¤è¡Œ</button><button class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px;">ä¿®æ”¹ç»ˆç«¯ç±»å‹ï¼ˆ${terminalType[base.getValue('setting_terminal_type')]}ï¼‰</button></div>`;
			}
			if (mode === 'bc') {
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨é“¾æ¥</button></div>`;
			}
			return content;
		},

		async sendLinkToRPC(filename, link) {
			let rpc = {
				domain: base.getValue('setting_rpc_domain'),
				port: base.getValue('setting_rpc_port'),
				path: base.getValue('setting_rpc_path'),
				token: base.getValue('setting_rpc_token'),
				dir: base.getValue('setting_rpc_dir'),
			};

			let url = `${rpc.domain}:${rpc.port}${rpc.path}`;
			let rpcData = {
				id: new Date().getTime(),
				jsonrpc: '2.0',
				method: 'aria2.addUri',
				params: [`token:${rpc.token}`, [link], {
					dir: rpc.dir,
					out: filename,
					header: [`Referer: https://${location.host}/`]
				}]
			};
			try {
				let res = await base.post(url, rpcData, { "Referer": `https://${location.host}/` }, '');
				if (res.result) return 'success';
				return 'fail';
			} catch (e) {
				return 'fail';
			}
		},

		getSelectedList() {
			try {
				let selectedList = [];
				let reactDom = document.querySelector(config.ali.mount.list);
				let reactObj = base.findReact(reactDom, 1);
				let props = reactObj.pendingProps;
				if (props) {
					let fileList = props.dataSource || [];
					let selectedKeys = props.selectedKeys.split(',');
					fileList.forEach(function (val) {
						if (selectedKeys.includes(val.fileId)) {
							selectedList.push(val);
						}
					});
				}
				return selectedList;
			} catch (e) {
				return [];
			}
		},

		detectPage() {
			let path = location.pathname;
			if (/^\/(drive)/.test(path)) return 'home';
			if (/^\/(s|share)\//.test(path)) return 'share';
			return '';
		},

		isOnlyFolder() {
			for (let i = 0; i < selectList.length; i++) {
				if (selectList[i].type === 'file') return false;
			}
			return true;
		},

		showMainDialog(title, html, footer) {
			Swal.fire({
				title,
				html,
				footer,
				customClass,
				position: 'center',
				padding: '15px 20px 5px',
				confirmButtonText: 'å…³é—­',
				showCloseButton: true,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				willClose: function () {
					base._resetData();
				},
				...swalDefault
			}).then(function () {
				base._resetData();
			});
		},

		async initPanLinker() {
			page = this.detectPage();
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
				this.addPageListener();
			} else {
				this.addInitButton();
			}
		}
	};

	//ä¸­å›½ç§»åŠ¨äº‘ç›˜/å’Œå½©äº‘
	let mcloud = {
		convertLinkToAria(link, filename, ua) {
			filename = base.fixFilename(filename);
			return encodeURIComponent(`aria2c "${link}" --out "${filename}"`);
		},

		convertLinkToBC(link, filename, ua) {
			let bc = `AA/${encodeURIComponent(filename)}/?url=${encodeURIComponent(link)}ZZ`;
			return encodeURIComponent(`bc://http/${base.encode(bc)}`);
		},

		convertLinkToCurl(link, filename, ua) {
			let terminal = base.getValue('setting_terminal_type');
			filename = base.fixFilename(filename);
			return encodeURIComponent(`${terminal !== 'wp' ? 'curl' : 'curl.exe'} -L -C - "${link}" -o "${filename}"`);
		},

		addPageListener() {
			/*
			é˜²æ­¢ä»£ç å› å…¶ä»–åŸå› è¢«æ‰§è¡Œå¤šæ¬¡
			è¿™æ®µä»£ç å‡ºè‡ª Viaè½»æ’ä»¶ï¼Œä½œè€…è°·èŠ±æ³°
			*/
			const key = encodeURIComponent('ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹:ç§»åŠ¨äº‘ç›˜');
			if (window[key]) return;
			window[key] = true;

			function _factory(e) {
				let target = $(e.target);
				let item = target.parents('.pl-item');
				let link = item.find('.pl-item-link.blob');
				let directLink = item.find('.pl-item-link.browser');
				let progress = item.find('.pl-item-progress');
				let tip = item.find('.pl-item-tip');
				let copy = item.find('.pl-item-copy');
				let howidm = item.find('.pl-progress-how');
				let back = item.find('.pl-progress-back');
				let stop = item.find('.pl-progress-stop');
				return {
					item, link, directLink, progress, tip, copy, howidm, back, stop, target,
				};
			}

			function _reset(i) {
				ins[i] && clearInterval(ins[i]);
				request[i] && request[i].abort();
				progress[i] = 0;
				idm[i] = false;
			}

			doc.on('click', '.pl-button-mode', function (e) {
				mode = e.target.dataset.mode;
				if (!mode) return;
				Swal.fire({
					showConfirmButton: false,
					allowOutsideClick: false,
					allowEscapeKey: false,
					allowEnterKey: false,
					html: `<div id="loadingText">é“¾æ¥è·å–ä¸­</div>`,
					willOpen: function () {
						Swal.showLoading();
					},
					...swalDefault
				});
				mcloud.getPCSLink();
			});
			doc.on('click', '.listener-link-api.browser', async function (e) {
				e.preventDefault();
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				$('#downloadIframe').attr('src', href);
			});
			doc.on('click', '.listener-link-api.blob', async function (e) {
				e.preventDefault();
				let o = _factory(e);
				let $width = o.item.find('.pl-progress-inner');
				let $text = o.item.find('.pl-progress-inner-text');
				let filename = o.link[0].dataset.filename;
				let index = o.link[0].dataset.index;
				_reset(index);
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				base.get(href, { "Referer": `https://${location.host}/` }, 'blob', { filename, index });
				let startTime = Date.now(); // è®°å½•ä¸‹è½½å¼€å§‹æ—¶é—´
				let prevLoaded = 0; // ä¸Šä¸€æ¬¡çš„å·²ä¸‹è½½æ•°æ®é‡
				let prevTime = startTime; // ä¸Šä¸€æ¬¡çš„æ—¶é—´
				let size = Number(o.link[0].dataset.size);
				ins[index] = setInterval(function () {
					let prog = +progress[index] || 0;
					let isIDM = idm[index] || false;
					// å¤„ç†æ™®é€šä¸‹è½½çš„æƒ…å†µ...
					let currentTime = Date.now();
					let elapsedTime = currentTime - startTime;
					let totalProgress = prog / 100;
					let totalElapsedSeconds = elapsedTime / 1000;
					let estimatedTotalTimeSeconds = totalElapsedSeconds / totalProgress;
					let remainingTimeSeconds = estimatedTotalTimeSeconds - totalElapsedSeconds;

					// å°†å‰©ä½™æ—¶é—´è½¬æ¢ä¸ºå¤©ã€æ—¶ã€åˆ†ã€ç§’
					let remainingDays = Math.floor(remainingTimeSeconds / (60 * 60 * 24));
					remainingTimeSeconds %= (60 * 60 * 24);

					let remainingHours = Math.floor(remainingTimeSeconds / (60 * 60));
					remainingTimeSeconds %= (60 * 60);

					let remainingMinutes = Math.floor(remainingTimeSeconds / 60);
					let remainingSeconds = Math.floor(remainingTimeSeconds % 60);

					// è®¡ç®—ä¸‹è½½é€Ÿåº¦
					let loaded = prog * size / 100; // å·²ä¸‹è½½æ•°æ®é‡
					let currentTimeDiff = currentTime - prevTime; // å½“å‰æ—¶é—´ä¸ä¸Šä¸€æ¬¡æ—¶é—´çš„å·®å€¼
					let loadedDiff = loaded - prevLoaded; // å½“å‰å·²ä¸‹è½½æ•°æ®é‡ä¸ä¸Šä¸€æ¬¡çš„å·®å€¼
					let downloadSpeed = (currentTimeDiff !== 0) ? loadedDiff / (currentTimeDiff / 1000) : 0; // ä¸‹è½½é€Ÿåº¦ï¼ˆå•ä½ï¼šå­—èŠ‚/ç§’ï¼‰

					// æ›´æ–°ä¸Šä¸€æ¬¡çš„æ•°æ®
					prevLoaded = loaded;
					prevTime = currentTime;

					// æ›´æ”¹ç•Œé¢
					o.link.hide();
					o.directLink.hide();
					o.tip.hide();
					o.stop.show();
					o.copy.hide();
					o.progress.show();

					// æ›´æ–°è¿›åº¦æ¡
					$width.css('width', prog + '%');

					// æ›´æ–°è¿›åº¦æ¡æ–‡æœ¬
					let timeText = '';
					if (Number.isFinite(remainingDays) && remainingDays > 0) {
						timeText = remainingDays + 'å¤© ' + base.repairTimer(remainingHours) + 'æ—¶:' + base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
					} else if (Number.isFinite(remainingHours) && remainingHours > 0) {
						timeText = base.repairTimer(remainingHours) + 'æ—¶:' + base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
					} else if (Number.isFinite(remainingMinutes) && remainingMinutes > 0) {
						timeText = base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
					} else if (Number.isFinite(remainingSeconds) && remainingSeconds > 0) {
						timeText = remainingSeconds + 'ç§’';
					} else if (Number.isFinite(remainingSeconds) && remainingSeconds === 0) {
						timeText = 'å³å°†å®Œæˆ';
					} else {
						timeText = 'è®¡ç®—ä¸­...';
					}

					let speedText = '';
					speedText = base.sizeFormat(downloadSpeed)
					$text.text(prog + '% | å‰©ä½™æ—¶é—´ï¼š' + timeText + ' | é€Ÿåº¦ï¼š' + speedText + '/ç§’');

					if (prog === 100) {
						setTimeout(function () {
							clearInterval(ins[index]);
							progress[index] = 0;
							o.item.find('.pl-progress-stop').hide();
							o.howidm.hide();
							$text.text('ä¸‹è½½å®Œæˆ~ æµè§ˆå™¨ä¸‹è½½æ¡†åº”è¯¥å¼¹å‡ºæ¥äº†å“¦~');
							o.back.show()
							setTimeout(function () {
								o.link.text('å¢å¼ºä¸‹è½½(åŸºäºæµè§ˆå™¨æ–‡ä»¶æµ)').animate({ opacity: '1' }, "slow");
							}, 3000)
						}, 1000)
					}
				}, 500);
			});
			doc.on('click', '.listener-retry', async function (e) {
				let o = _factory(e);
				o.tip.hide();
				o.link.show();
				o.directLink.show();
			});
			doc.on('click', '.listener-stop', async function (e) {
				let o = _factory(e);
				let index = o.link[0].dataset.index;
				if (request[index]) {
					request[index].abort();
					clearInterval(ins[index]);
					o.item.find('.pl-progress-inner-text').text('æ­£åœ¨å–æ¶ˆ...');
					o.item.find('.pl-progress-inner').css('width', 100 + '%');
					setTimeout(function () {
						o.tip.hide();
						o.back.hide();
						o.link.show();
						o.directLink.show();
						o.copy.show();
						o.progress.hide();
						o.stop.hide();
					}, 1050)
				}
			});
			doc.on('click', '.listener-back', async function (e) {
				let o = _factory(e);
				o.progress.hide();
				o.tip.hide();
				o.link.show();
				o.directLink.show();
				o.copy.show();
				o.stop.hide();
				o.back.hide();
			});
			doc.on('click', '.listener-download-all', function (e) {
				$('.pl-item-link.blob').each(function () {
					if ($(this).css('display') !== 'none') {
						$(this).click();
					}
				});
				$(e.target).text('ä¸‹è½½å¼€å§‹ï¼Œä¸‹è½½è¿›åº¦è§ä¸Šæ–¹æŒ‰é’®å“¦~').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('å…¨éƒ¨å¢å¼ºä¸‹è½½').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-aria, .listener-copy-all', function (e) {
				e.preventDefault();
				base.setClipboard(decodeURIComponent(e.target.dataset.link));
				$(e.target).text('å¤åˆ¶æˆåŠŸ').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('é‡æ–°å¤åˆ¶').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-rpc', async function (e) {
				let target = $(e.currentTarget);

				target.find('.icon-rpc-devices').remove();
				target.find('.pl-loading').remove();
				target.prepend(base.createLoading());

				let res = await mcloud.sendLinkToRPC(e.currentTarget.dataset.filename, e.currentTarget.dataset.link);
				if (res === 'success') {
					$('.listener-rpc-task').show();
					target.removeClass('pl-btn-danger').html('å‘é€æˆåŠŸäº†!å¿«å»çœ‹çœ‹å§~').animate({ opacity: '0.5' }, "slow");
				} else if (res === 'assistant') {
					target.addClass('pl-btn-danger').html(`${config.base.assistant.message}ğŸ‘‰<a href="${config.base.assistant.link}" target="_blank" class="pl-a">ç‚¹å‡»æ­¤å¤„å®‰è£…</a>ğŸ‘ˆ`);
				} else {
					target.addClass('pl-btn-danger').text('å‘é€å¤±è´¥ï¼Œæ£€æŸ¥ä¸€ä¸‹æ‚¨çš„RPCé…ç½®ä¿¡æ¯å“¦!').animate({ opacity: '0.5' }, "slow");
				}
			});
			doc.on('click', '.listener-send-rpc', function (e) {
				$('.listener-link-rpc').click();
				$(e.target).text('å‘é€å®Œæˆï¼Œå‘é€ç»“æœè§ä¸Šæ–¹æŒ‰é’®å“¦~').animate({ opacity: '0.5' }, "slow");
			});
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdateLog();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-rpc-task', function () {
				let rpc = JSON.stringify({
					domain: base.getValue('setting_rpc_domain'),
					port: base.getValue('setting_rpc_port'),
				}), url = `${config.base.service.rpc}/?rpc=${base.encode(rpc)}#${base.getValue('setting_rpc_token')}`;
				GM_openInTab(url, { active: true });
			});
		},

		removeAD() {
			base.waitForKeyElements(".adv_swiper_menu", function (tag) {
				tag.fadeOut();
			});
			base.waitForKeyElements(".client-bubble", function (tag) {
				tag.fadeOut();
			});
			base.waitForKeyElements(".avs-box", function (tag) {
				tag.fadeOut();
			});
			base.waitForKeyElements(".top-adv-swiper", function (tag) {
				tag.fadeOut();
			});
			base.waitForKeyElements(".client_download_icon", function (tag) {
				tag.fadeOut();
			});
			base.waitForKeyElements(".document_top_memberCenter", function (tag) {
				$(tag[0]).click(function () {
					Swal.fire({
						html: `<iframe style="height: 700px; width: 420px; border: 0;" src="https://vip.yun.139.com/vip/"></iframe>`,
						allowOutsideClick: false,
						showCloseButton: true,
						showConfirmButton: false,
						...swalDefault
					});
				});
			}, true);
		},

		addButton() {
			if (!page) return;
			let $toolWrap;
			let $button = $(`<div class="pl-button btn-top"><span class="mcloud-btn">ä¸‹è½½åŠ©æ‰‹</span><ul class="pl-dropdown-menu" style="top: 36px; letter-spacing: normal;"><li class="pl-dropdown-menu-item pl-button-mode" data-mode="api">APIä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="aria" >Ariaä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="rpc">RPCä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="curl">cURLä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="bc" >BCä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">åŠ©æ‰‹è®¾ç½®</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">åŠ©æ‰‹ç¾åŒ–</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">æ›´æ–°æ—¥å¿—</li></ul></div>`);
			if (page === 'home') {
				$button.addClass('mcloud-button');
				base.listenElement(config.mcloud.mount.home, function () {
					$toolWrap = $(config.mcloud.mount.home);
					$('.pl-button').length === 0 && $toolWrap.prepend($button);
				})
			}
			if (page === 'share') {
				$button.addClass('mcloud-share-button');
				base.listenElement(config.mcloud.mount.share, function () {
					$toolWrap = $(config.mcloud.mount.share);
					$('.pl-button').length === 0 && $toolWrap.prepend($button);
				})
			}
			base.createDownloadIframe();
		},

		addInitButton() {
			if (!page) return;
			let $toolWrap;
			let $button = $(`<div class="pl-button-init btn-top"><span class="mcloud-btn">ç‚¹æˆ‘ç‚¹äº®</span></div>`);
			if (page === 'home') {
				$button.addClass('mcloud-button');
				base.listenElement(config.mcloud.mount.home, function () {
					$toolWrap = $(config.mcloud.mount.home);
					$('.pl-button-init').length === 0 && $toolWrap.prepend($button);
				})
			}
			if (page === 'share') {
				$button.addClass('mcloud-share-button');
				base.listenElement(config.mcloud.mount.share, function () {
					$toolWrap = $(config.mcloud.mount.share);
					$('.pl-button-init').length === 0 && $toolWrap.prepend($button);
				})
			}
			$button.click(function () { base.initDialog() });
		},

		getRandomString(len) {
			len = len || 16;
			let $chars = 'ABCDEFGHJKMNPQRSTWXYZabcdefhijkmnprstwxyz2345678';
			let maxPos = $chars.length;
			let pwd = '';
			for (let i = 0; i < len; i++) {
				pwd += $chars.charAt(Math.floor(Math.random() * maxPos));
			}
			return pwd;
		},

		utob(str) {
			const u = String.fromCharCode;
			return str.replace(/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g, function (t) {
				if (t.length < 2) {
					let e = t.charCodeAt(0);
					return e < 128 ? t : e < 2048 ? u(192 | e >>> 6) + u(128 | 63 & e) : u(224 | e >>> 12 & 15) + u(128 | e >>> 6 & 63) + u(128 | 63 & e);
				}
				e = 65536 + 1024 * (t.charCodeAt(0) - 55296) + (t.charCodeAt(1) - 56320);
				return u(240 | e >>> 18 & 7) + u(128 | e >>> 12 & 63) + u(128 | e >>> 6 & 63) + u(128 | 63 & e);
			});
		},

		getSign(e, t, a, n) {
			let r = "",
				i = "";
			if (t) {
				let s = Object.assign({}, t);
				i = JSON.stringify(s),
					i = i.replace(/\s*/g, ""),
					i = encodeURIComponent(i);
				let c = i.split(""),
					u = c.sort();
				i = u.join("");
			}
			let A = md5(base.encode(this.utob(i)));
			let l = md5(a + ":" + n);
			return md5(A + l).toUpperCase();
		},

		async getFileUrlByOnce(item, index) {
			try {
				if (item.downloadUrl) return {
					index,
					downloadUrl: item.downloadUrl
				};

				if (this.detectPage() === 'home') {
					let body = {
						fileId: item.contentID
					}
					let time = new Date(+new Date() + 8 * 3600 * 1000).toJSON().substr(0, 19).replace('T', ' ');
					let key = this.getRandomString(16);
					let sign = this.getSign(undefined, body, time, key);

					let res = await base.post(config.mcloud.api.getLink, body, {
						'Authorization': base.getCookie('authorization'),
						'Caller': 'web',
						'CMS-DEVICE': 'default',
						'Content-Type': "application/json;charset=UTF-8",
						'mcloud-channel': '1000101',
						'mcloud-client': '10701',
						'mcloud-sign': time + "," + key + "," + sign,
						'mcloud-version': '7.14.2',
						'Origin': 'https://yun.139.com',
						'Referer': 'https://yun.139.com/',
						'X-DeviceInfo': '||9|7.14.2|chrome|119.0.0.0|||windows 10||zh-CN|||',
						'X-Huawei-ChannelSrc': '10000034',
						'X-Inner-Ntwk': '2',
						'X-M4C-Caller': 'PC',
						'X-M4C-Src': '10002',
						'X-SvcType': '1',
						'X-Yun-Api-Version': 'v1',
						'X-Yun-App-Channel': '10000034',
						'X-Yun-Channel-Source': '10000034',
						'X-Yun-Client-Info': '||9|7.14.2|chrome|119.0.0.0|||windows 10||zh-CN|||||',
						'X-Yun-Module-Type': '100',
						'X-Yun-Svc-Type': '1'
					});
					if (res.success) {
						return {
							index,
							downloadUrl: res.data.url
						};
					} else {
						return {
							index,
							downloadUrl: 'è·å–ä¸‹è½½åœ°å€å¤±è´¥ï¼Œåˆ·æ–°åå†è¯•è¯•å§~'
						};
					}
				}
				if (this.detectPage() === 'share') {
					let vueDom = document.querySelector(".main_file_list").__vue__;

					let res = await base.post(config.mcloud.api.getShareLink, `linkId=${vueDom.linkID}&contentIds=${item.path}&catalogIds=`, {
						'Content-Type': 'application/x-www-form-urlencoded',
					});
					if (res.code === 0) {
						return {
							index,
							downloadUrl: res.data.redrUrl
						};
					} else {
						return {
							index,
							downloadUrl: 'è·å–ä¸‹è½½åœ°å€å¤±è´¥ï¼Œåˆ·æ–°åå†è¯•è¯•å§~'
						};
					}
				}
			} catch (e) {
				return {
					index,
					downloadUrl: 'è·å–ä¸‹è½½åœ°å€å¤±è´¥ï¼Œåˆ·æ–°åå†è¯•è¯•å§~'
				};
			}
		},

		async getPCSLink() {
			selectList = this.getSelectedList();
			if (selectList.length === 0) {
				return message.error('æç¤ºï¼š<br/>è¯·å‹¾é€‰è¦ä¸‹è½½çš„æ–‡ä»¶å“¦~');
			}
			if (this.isOnlyFolder()) {
				return message.error('æç¤ºï¼š<br/>è¯·æ‰“å¼€æ–‡ä»¶å¤¹åå†å‹¾é€‰æ–‡ä»¶~');
			}
			selectList = selectList.filter(item => item.contentID && item.contentName && item.contentSuffix);
			let queue = [];
			for (const [index, item] of selectList.entries()) {
				queue.push(this.getFileUrlByOnce(item, index));
			}

			const res = await Promise.all(queue);
			res.forEach(val => {
				selectList[val.index].downloadUrl = val.downloadUrl;
			});

			let html = this.generateDom(selectList);
			this.showMainDialog(config.base.dom.button[mode].title, html, config.base.dom.button[mode].footer);
		},

		generateDom(list) {
			if (!list) {
				return message.error('æç¤ºï¼š<br/>è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œåˆ·æ–°ç½‘é¡µåå†è¯•è¯•å§~');
			}
			let content = '<div class="pl-main">';
			let alinkAllText = '';
			list.forEach((v, i) => {
				if (v.dirEtag || v.caName) return;
				let filename = v.contentName || v.coName;
				let size = base.sizeFormat(v.contentSize || v.coSize);
				let dlink = v.downloadUrl;
				if (!dlink || !dlink.includes("http")) {
					content += `<div class="pl-item">
						<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
						<div class="pl-item-tip">è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œåˆ·æ–°ç½‘é¡µåå†è¯•è¯•å§~</div>
					</div>`;
				} else {
					if (mode === 'api') {
						alinkAllText += dlink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-default listener-link-api blob" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œè‹¥æ–‡ä»¶è¿‡å¤§ä¸‹è½½å®Œæˆåæœ‰å¯èƒ½ä¸ä¼šå¼¹å‡ºçª—å£ï¼Œæ­¤æ—¶è¯·æ¢ç”¨â€œRPCä¸‹è½½ + Mortixâ€çš„ç»„åˆ<br/>åŸºäºæµè§ˆå™¨çš„ Blob æ–‡ä»¶æµä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒæ–°çš„æµè§ˆå™¨ï¼Œå¯ä»¥åœ¨æ­¤çª—å£ä¸­æ˜¾ç¤ºä¸‹è½½å‰©ä½™æ—¶é—´å’Œä¸‹è½½é€Ÿåº¦ï¼Œæ­¤æ–¹å¼ä¸‹è½½ä¸ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥" data-filename="${filename}" data-size="${v.contentSize || v.coSize}" data-link="${dlink}" data-index="${i}">å¢å¼ºä¸‹è½½(åŸºäºæµè§ˆå™¨æ–‡ä»¶æµ)</button>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-info listener-link-api browser" data-title="åŸºäºæµè§ˆå™¨ç›´æ¥æ‰“å¼€é“¾æ¥æ¥ä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒä¸ºå¤è€ä½†æ”¯æŒ iframe çš„æµè§ˆå™¨ï¼Œç‚¹å‡»â€œç›´æ¥ä¸‹è½½â€åéœ€ç­‰å¾…ä¸‹è½½æç¤ºå¼¹å‡ºæ‰èƒ½ç‚¹å‡»ä¸‹ä¸ªâ€œç›´æ¥ä¸‹è½½â€ï¼Œå¦åˆ™åªä¼šä¸‹è½½åè€…ï¼Œæ­¤æ–¹å¼ä¸‹è½½æœ‰å¯èƒ½ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥" data-filename="${filename}" data-link="${dlink}">ç›´æ¥ä¸‹è½½(åŸºäºæµè§ˆå™¨é“¾æ¥)</button>
							<button class="pl-item-copy pl-btn-primary pl-btn-warning listener-copy-all" href="${dlink}" data-filename="${filename}" data-link="${dlink}">å¤åˆ¶é“¾æ¥</button>
							<div class="pl-item-progress" style="display: none">
								<div class="pl-progress">
									<div class="pl-progress-outer"></div>
									<div class="pl-progress-inner" style="width:5%">
									<div class="pl-progress-inner-text">æ­£åœ¨åŠ è½½è¿›åº¦...0%</div>
									</div>
								</div>
								<span class="pl-btn-primary pl-btn-danger pl-progress-stop listener-stop">å–æ¶ˆä¸‹è½½</span>
								<span class="pl-btn-primary pl-btn-info pl-progress-back listener-back" style="display: none">è¿”å›</span>
							</div>
						</div>`;
					}
					if (mode === 'aria') {
						let alink = this.convertLinkToAria(dlink, filename, navigator.userAgent);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="ç‚¹å‡»å¤åˆ¶ aria2c å‘½ä»¤è¡Œ" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>å¤åˆ¶ ${filename} ä¸‹è½½å‘½ä»¤è¡Œ</a>
						</div>`;
					}
					if (mode === 'rpc') {
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<button class="pl-item-link listener-link-rpc pl-btn-primary pl-btn-info" data-filename="${filename}" data-link="${dlink}"><svg class="icon-rpc-devices" viewBox="-10 0 1034 1024"><g transform="matrix(1 0 0 -1 0 960)"><path fill="currentColor" d="M832 -64h-640q-53 0 -90.5 37.5t-37.5 90.5v768q0 53 37.5 90.5t90.5 37.5h640q53 0 90.5 -37.5t37.5 -90.5v-768q0 -53 -37.5 -90.5t-90.5 -37.5zM832 768q0 27 -18.5 45.5t-45.5 18.5h-512q-27 0 -45.5 -18.5t-18.5 -45.5v-320h640v320v0zM832 320h-640v-192q0 -27 18.5 -45.5t45.5 -18.5h512q27 0 45.5 18.5t18.5 45.5v192v0zM512 128q-27 0 -45.5 18.5t-18.5 45.5t18.5 45.5t45.5 18.5t45.5 -18.5t18.5 -45.5t-18.5 -45.5t-45.5 -18.5z" /></g></svg><span style="margin-left: 5px;">å°† ${filename} æ¨é€åˆ° RPC ä¸‹è½½å™¨</span></button>
						</div>`;
					}
					if (mode === 'curl') {
						let alink = this.convertLinkToCurl(dlink, filename, navigator.userAgent);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="ç‚¹å‡»å¤åˆ¶ curl å‘½ä»¤è¡Œ" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>å¤åˆ¶ ${filename} ä¸‹è½½å‘½ä»¤è¡Œ</a>
						</div>`;
					}
					if (mode === 'bc') {
						let alink = this.convertLinkToBC(dlink, filename, navigator.userAgent);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<a class="pl-item-link" href="${decodeURIComponent(alink)}" title="ç‚¹å‡»ç”¨æ¯”ç‰¹å½—æ˜Ÿä¸‹è½½" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>ä¸‹è½½ ${filename}</a>
						</div>`;
					}
				}
			});
			content += '</div>';
			if (mode === 'api') {
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-tip listener-download-all" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œè‹¥æ–‡ä»¶è¿‡å¤§ä¸‹è½½å®Œæˆåæœ‰å¯èƒ½ä¸ä¼šå¼¹å‡ºçª—å£ï¼Œæ­¤æ—¶è¯·æ¢ç”¨â€œRPCä¸‹è½½ + Mortixâ€çš„ç»„åˆ<br/>åŸºäºæµè§ˆå™¨çš„ Blob æ–‡ä»¶æµä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒæ–°çš„æµè§ˆå™¨ï¼Œå¯ä»¥åœ¨æ­¤çª—å£ä¸­æ˜¾ç¤ºä¸‹è½½å‰©ä½™æ—¶é—´å’Œä¸‹è½½é€Ÿåº¦ï¼Œæ­¤æ–¹å¼ä¸‹è½½ä¸ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥">å…¨éƒ¨å¢å¼ºä¸‹è½½</button><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨é“¾æ¥</button></div>`;
			}
			if (mode === 'aria')
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨å‘½ä»¤è¡Œ</button></div>`;
			if (mode === 'rpc') {
				let rpc = base.getValue('setting_rpc_domain') + ':' + base.getValue('setting_rpc_port') + base.getValue('setting_rpc_path');
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-send-rpc">å‘é€å…¨éƒ¨é“¾æ¥</button><button title="${rpc}" class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px">ä¿®æ”¹ RPC å‚æ•°ï¼ˆ${rpc}ï¼‰</button><button class="pl-btn-primary pl-btn-success pl-btn-opacity listener-rpc-task" style="margin-left: 10px;display: none">æŸ¥çœ‹ä¸‹è½½ä»»åŠ¡</button></div>`;
			}
			if (mode === 'curl') {
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨å‘½ä»¤è¡Œ</button><button class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px;">ä¿®æ”¹ç»ˆç«¯ç±»å‹ï¼ˆ${terminalType[base.getValue('setting_terminal_type')]}ï¼‰</button></div>`;
			}
			if (mode === 'bc') {
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨é“¾æ¥</button></div>`;
			}
			return content;
		},

		async sendLinkToRPC(filename, link) {
			let rpc = {
				domain: base.getValue('setting_rpc_domain'),
				port: base.getValue('setting_rpc_port'),
				path: base.getValue('setting_rpc_path'),
				token: base.getValue('setting_rpc_token'),
				dir: base.getValue('setting_rpc_dir'),
			};

			let url = `${rpc.domain}:${rpc.port}${rpc.path}`;
			let rpcData = {
				id: new Date().getTime(),
				jsonrpc: '2.0',
				method: 'aria2.addUri',
				params: [`token:${rpc.token}`, [link], {
					dir: rpc.dir,
					out: filename,
					header: []
				}]
			};
			try {
				let res = await base.post(url, rpcData, {}, '');
				if (res.result) return 'success';
				return 'fail';
			} catch (e) {
				return 'fail';
			}
		},

		getSelectedList() {
			try {
				return document.querySelector(".main_file_list").__vue__.selectList.map(val => val.item);
			} catch (e) {
				let vueDom = document.querySelector(".home-page").__vue__;
				let fileList = vueDom._computedWatchers.fileList.value;
				let dirList = vueDom._computedWatchers.dirList.value;
				let selectedFileIndex = vueDom.selectedFile;
				let selectedDirIndex = vueDom.selectedDir;
				let selectFileList = fileList.filter((v, i) => {
					return selectedFileIndex.includes(i);
				});
				let selectDirList = dirList.filter((v, i) => {
					return selectedDirIndex.includes(i);
				});
				return [...selectFileList, ...selectDirList];
			}
		},

		detectPage() {
			let path = location.pathname;
			if (/^\/w/.test(path)) return 'home';
			// if (/^\/link|shareweb/.test(path)) return 'share';
			return '';
		},

		isOnlyFolder() {
			for (let i = 0; i < selectList.length; i++) {
				if (selectList[i].contentID || selectList[i].contentName) return false;
			}
			return true;
		},

		showMainDialog(title, html, footer) {
			Swal.fire({
				title,
				html,
				footer,
				customClass,
				position: 'center',
				padding: '15px 20px 5px',
				confirmButtonText: 'å…³é—­',
				showCloseButton: true,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				willClose: function () {
					base._resetData();
				},
				...swalDefault
			}).then(function () {
				base._resetData();
			});
		},

		async initPanLinker() {
			page = this.detectPage();
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
				this.addPageListener();
			} else {
				this.addInitButton();
			}
		}
	};

	// å¤©ç¿¼äº‘ç›˜
	let tcloud = {
		convertLinkToAria(link, filename, ua) {
			filename = base.fixFilename(filename);
			return encodeURIComponent(`aria2c "${link}" --out "${filename}"`);
		},

		convertLinkToBC(link, filename, ua) {
			let bc = `AA/${encodeURIComponent(filename)}/?url=${encodeURIComponent(link)}ZZ`;
			return encodeURIComponent(`bc://http/${base.encode(bc)}`);
		},

		convertLinkToCurl(link, filename, ua) {
			let terminal = base.getValue('setting_terminal_type');
			filename = base.fixFilename(filename);
			return encodeURIComponent(`${terminal !== 'wp' ? 'curl' : 'curl.exe'} -L -C - "${link}" -o "${filename}"`);
		},

		addPageListener() {
			/*
			é˜²æ­¢ä»£ç å› å…¶ä»–åŸå› è¢«æ‰§è¡Œå¤šæ¬¡
			è¿™æ®µä»£ç å‡ºè‡ª Viaè½»æ’ä»¶ï¼Œä½œè€…è°·èŠ±æ³°
			*/
			const key = encodeURIComponent('ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹:å¤©ç¿¼äº‘ç›˜');
			if (window[key]) return;
			window[key] = true;

			function _factory(e) {
				let target = $(e.target);
				let item = target.parents('.pl-item');
				let link = item.find('.pl-item-link.blob');
				let directLink = item.find('.pl-item-link.browser');
				let progress = item.find('.pl-item-progress');
				let tip = item.find('.pl-item-tip');
				let copy = item.find('.pl-item-copy');
				let howidm = item.find('.pl-progress-how');
				let back = item.find('.pl-progress-back');
				let stop = item.find('.pl-progress-stop');
				return {
					item, link, directLink, progress, tip, copy, howidm, back, stop, target,
				};
			}

			function _reset(i) {
				ins[i] && clearInterval(ins[i]);
				request[i] && request[i].abort();
				progress[i] = 0;
				idm[i] = false;
			}

			doc.on('click', '.pl-button-mode', function (e) {
				mode = e.target.dataset.mode;
				if (!mode) return;
				Swal.fire({
					showConfirmButton: false,
					allowOutsideClick: false,
					allowEscapeKey: false,
					allowEnterKey: false,
					html: `<div id="loadingText">é“¾æ¥è·å–ä¸­</div>`,
					willOpen: function () {
						Swal.showLoading();
					},
					...swalDefault
				});
				tcloud.getPCSLink();
			});
			doc.on('click', '.listener-link-api.browser', async function (e) {
				e.preventDefault();
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				$('#downloadIframe').attr('src', href);
			});
			doc.on('click', '.listener-link-api.blob', async function (e) {
				e.preventDefault();
				let o = _factory(e);
				let $width = o.item.find('.pl-progress-inner');
				let $text = o.item.find('.pl-progress-inner-text');
				let filename = o.link[0].dataset.filename;
				let index = o.link[0].dataset.index;
				_reset(index);
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				base.get(href, { "Referer": `https://${location.host}/` }, 'blob', { filename, index });
				let startTime = Date.now(); // è®°å½•ä¸‹è½½å¼€å§‹æ—¶é—´
				let prevLoaded = 0; // ä¸Šä¸€æ¬¡çš„å·²ä¸‹è½½æ•°æ®é‡
				let prevTime = startTime; // ä¸Šä¸€æ¬¡çš„æ—¶é—´
				let size = Number(o.link[0].dataset.size);
				ins[index] = setInterval(function () {
					let prog = +progress[index] || 0;
					// å¤„ç†æ™®é€šä¸‹è½½çš„æƒ…å†µ...
					let currentTime = Date.now();
					let elapsedTime = currentTime - startTime;
					let totalProgress = prog / 100;
					let totalElapsedSeconds = elapsedTime / 1000;
					let estimatedTotalTimeSeconds = totalElapsedSeconds / totalProgress;
					let remainingTimeSeconds = estimatedTotalTimeSeconds - totalElapsedSeconds;

					// å°†å‰©ä½™æ—¶é—´è½¬æ¢ä¸ºå¤©ã€æ—¶ã€åˆ†ã€ç§’
					let remainingDays = Math.floor(remainingTimeSeconds / (60 * 60 * 24));
					remainingTimeSeconds %= (60 * 60 * 24);

					let remainingHours = Math.floor(remainingTimeSeconds / (60 * 60));
					remainingTimeSeconds %= (60 * 60);

					let remainingMinutes = Math.floor(remainingTimeSeconds / 60);
					let remainingSeconds = Math.floor(remainingTimeSeconds % 60);

					// è®¡ç®—ä¸‹è½½é€Ÿåº¦
					let loaded = prog * size / 100; // å·²ä¸‹è½½æ•°æ®é‡
					let currentTimeDiff = currentTime - prevTime; // å½“å‰æ—¶é—´ä¸ä¸Šä¸€æ¬¡æ—¶é—´çš„å·®å€¼
					let loadedDiff = loaded - prevLoaded; // å½“å‰å·²ä¸‹è½½æ•°æ®é‡ä¸ä¸Šä¸€æ¬¡çš„å·®å€¼
					let downloadSpeed = (currentTimeDiff !== 0) ? loadedDiff / (currentTimeDiff / 1000) : 0; // ä¸‹è½½é€Ÿåº¦ï¼ˆå•ä½ï¼šå­—èŠ‚/ç§’ï¼‰

					// æ›´æ–°ä¸Šä¸€æ¬¡çš„æ•°æ®
					prevLoaded = loaded;
					prevTime = currentTime;

					// æ›´æ”¹ç•Œé¢
					o.link.hide();
					o.directLink.hide();
					o.tip.hide();
					o.stop.show();
					o.copy.hide();
					o.progress.show();

					// æ›´æ–°è¿›åº¦æ¡
					$width.css('width', prog + '%');

					// æ›´æ–°è¿›åº¦æ¡æ–‡æœ¬
					let timeText = '';
					if (Number.isFinite(remainingDays) && remainingDays > 0) {
						timeText = remainingDays + 'å¤© ' + base.repairTimer(remainingHours) + 'æ—¶:' + base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
					} else if (Number.isFinite(remainingHours) && remainingHours > 0) {
						timeText = base.repairTimer(remainingHours) + 'æ—¶:' + base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
					} else if (Number.isFinite(remainingMinutes) && remainingMinutes > 0) {
						timeText = base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
					} else if (Number.isFinite(remainingSeconds) && remainingSeconds > 0) {
						timeText = remainingSeconds + 'ç§’';
					} else if (Number.isFinite(remainingSeconds) && remainingSeconds === 0) {
						timeText = 'å³å°†å®Œæˆ';
					} else {
						timeText = 'è®¡ç®—ä¸­...';
					}

					let speedText = '';
					speedText = base.sizeFormat(downloadSpeed)
					$text.text(prog + '% | å‰©ä½™æ—¶é—´ï¼š' + timeText + ' | é€Ÿåº¦ï¼š' + speedText + '/ç§’');

					if (prog === 100) {
						setTimeout(function () {
							clearInterval(ins[index]);
							progress[index] = 0;
							o.item.find('.pl-progress-stop').hide();
							o.howidm.hide();
							$text.text('ä¸‹è½½å®Œæˆ~ æµè§ˆå™¨ä¸‹è½½æ¡†åº”è¯¥å¼¹å‡ºæ¥äº†å“¦~');
							o.back.show()
							setTimeout(function () {
								o.link.text('å¢å¼ºä¸‹è½½(åŸºäºæµè§ˆå™¨æ–‡ä»¶æµ)').animate({ opacity: '1' }, "slow");
							}, 3000)
						}, 1000)
					}
				}, 500);
			});
			doc.on('click', '.listener-retry', async function (e) {
				let o = _factory(e);
				o.tip.hide();
				o.link.show();
				o.directLink.show();
			});
			doc.on('click', '.listener-stop', async function (e) {
				let o = _factory(e);
				let index = o.link[0].dataset.index;
				if (request[index]) {
					request[index].abort();
					clearInterval(ins[index]);
					o.item.find('.pl-progress-inner-text').text('æ­£åœ¨å–æ¶ˆ...');
					o.item.find('.pl-progress-inner').css('width', 100 + '%');
					setTimeout(function () {
						o.tip.hide();
						o.back.hide();
						o.link.show();
						o.directLink.show();
						o.copy.show();
						o.progress.hide();
						o.stop.hide();
					}, 1050)
				}
			});
			doc.on('click', '.listener-back', async function (e) {
				let o = _factory(e);
				o.progress.hide();
				o.tip.hide();
				o.link.show();
				o.directLink.show();
				o.copy.show();
				o.stop.hide();
				o.back.hide();
			});
			doc.on('click', '.listener-download-all', function (e) {
				$('.pl-item-link.blob').each(function () {
					if ($(this).css('display') !== 'none') {
						$(this).click();
					}
				});
				$(e.target).text('ä¸‹è½½å¼€å§‹ï¼Œä¸‹è½½è¿›åº¦è§ä¸Šæ–¹æŒ‰é’®å“¦~').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('å…¨éƒ¨å¢å¼ºä¸‹è½½').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-aria, .listener-copy-all', function (e) {
				e.preventDefault();
				base.setClipboard(decodeURIComponent(e.target.dataset.link));
				$(e.target).text('å¤åˆ¶æˆåŠŸ').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('é‡æ–°å¤åˆ¶').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-rpc', async function (e) {
				let target = $(e.currentTarget);

				target.find('.icon-rpc-devices').remove();
				target.find('.pl-loading').remove();
				target.prepend(base.createLoading());

				let res = await tcloud.sendLinkToRPC(e.currentTarget.dataset.filename, e.currentTarget.dataset.link);
				if (res === 'success') {
					$('.listener-rpc-task').show();
					target.removeClass('pl-btn-danger').html('å‘é€æˆåŠŸäº†!å¿«å»çœ‹çœ‹å§~').animate({ opacity: '0.5' }, "slow");
				} else if (res === 'assistant') {
					target.addClass('pl-btn-danger').html(`${config.base.assistant.message}ğŸ‘‰<a href="${config.base.assistant.link}" target="_blank" class="pl-a">ç‚¹å‡»æ­¤å¤„å®‰è£…</a>ğŸ‘ˆ`);
				} else {
					target.addClass('pl-btn-danger').text('å‘é€å¤±è´¥ï¼Œæ£€æŸ¥ä¸€ä¸‹æ‚¨çš„RPCé…ç½®ä¿¡æ¯å“¦!').animate({ opacity: '0.5' }, "slow");
				}
			});
			doc.on('click', '.listener-send-rpc', function (e) {
				$('.listener-link-rpc').click();
				$(e.target).text('å‘é€å®Œæˆï¼Œå‘é€ç»“æœè§ä¸Šæ–¹æŒ‰é’®å“¦~').animate({ opacity: '0.5' }, "slow");
			});
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdateLog();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-rpc-task', function () {
				let rpc = JSON.stringify({
					domain: base.getValue('setting_rpc_domain'),
					port: base.getValue('setting_rpc_port'),
				}), url = `${config.base.service.rpc}/?rpc=${base.encode(rpc)}#${base.getValue('setting_rpc_token')}`;
				GM_openInTab(url, { active: true });
			});
		},

		removeAD() {
			base.waitForKeyElements(".advertising-mask", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements("a.client-download.nav-block", function (tag) {
				tag.fadeOut();
			}, true);
		},

		addButton() {
			if (!page) return;
			let $toolWrap;
			let $button = $(`<div class="pl-button tcloud-button">ä¸‹è½½åŠ©æ‰‹&nbsp;<i aria-label="icon: caret-down" class="anticon anticon-caret-down"><svg viewBox="0 0 1024 1024" data-icon="caret-down" width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" class=""><path d="M840.4 300H183.6c-19.7 0-30.7 20.8-18.5 35l328.4 380.8c9.4 10.9 27.5 10.9 37 0L858.9 335c12.2-14.2 1.2-35-18.5-35z"></path></svg></i><ul class="pl-dropdown-menu"><li class="pl-dropdown-menu-item pl-button-mode" data-mode="api">APIä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="aria" >Ariaä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="rpc">RPCä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="curl">cURLä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode" data-mode="bc" >BCä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">åŠ©æ‰‹è®¾ç½®</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">åŠ©æ‰‹ç¾åŒ–</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">æ›´æ–°æ—¥å¿—</li></ul></div>`);
			$button.find(".pl-dropdown-menu").css({ 'position': 'absolute', 'left': '-1px' })
			if (page === 'home') {
				console.log($button[0])
				base.listenElement(config.tcloud.mount.home, function () {
					$toolWrap = $(config.tcloud.mount.home);
					$button.find(".pl-dropdown-menu").css({ 'top': '28px' })
					$('.pl-button').length === 0 && $toolWrap.prepend($button);
				})
			}
			if (page === 'share') {
				base.listenElement(config.tcloud.mount.share, function () {
					$toolWrap = $(config.tcloud.mount.share);
					$button.css({ 'height': '28px', 'border-radius': '15px' })
					$button.find(".pl-dropdown-menu").css({ 'top': '25px' })
					$('.pl-button').length === 0 && $toolWrap.prepend($button);
				})
			}
			base.createDownloadIframe();
		},

		addInitButton() {
			if (!page) return;
			let $toolWrap;
			let $button = $(`<div class="tcloud-button pl-button-init">ç‚¹æˆ‘ç‚¹äº®</div>`);
			if (page === 'home') {
				base.listenElement(config.tcloud.mount.home, function () {
					$toolWrap = $(config.tcloud.mount.home);
					$('.pl-button-init').length === 0 && $toolWrap.prepend($button);
				})
			}
			if (page === 'share') {
				base.listenElement(config.tcloud.mount.share, function () {
					$toolWrap = $(config.tcloud.mount.share);
					$button.css({ 'height': '28px', 'border-radius': '15px' })
					$('.pl-button-init').length === 0 && $toolWrap.prepend($button);
				})
			}
			$button.click(function () { base.initDialog() });
		},

		async getToken() {
			let res = await base.getFinalUrl(config.tcloud.api.getAccessToken, {});
			let accessToken = res.match(/accessToken=(\w+)/)?.[1];
			accessToken && base.setStorage('accessToken', accessToken);
			return accessToken;
		},

		async getFileUrlByOnce(item, index, token) {
			try {
				if (item.downloadUrl) return {
					index,
					downloadUrl: item.downloadUrl
				};
				console.log(item)
				let time = Date.now(),
					fileId = item.fileId,
					o = "AccessToken=" + token + "&Timestamp=" + time + "&fileId=" + fileId,
					url = config.tcloud.api.getLink + '?fileId=' + fileId;
				if (item.shareId) {
					o = "AccessToken=" + token + "&Timestamp=" + time + "&dt=1&fileId=" + fileId + "&shareId=" + item.shareId;
					url += '&dt=1&shareId=' + item.shareId;
				}
				let sign = md5(o).toString();
				let res = await base.get(url, {
					"accept": "application/json;charset=UTF-8",
					"sign-type": 1,
					"accesstoken": token,
					"timestamp": time,
					"signature": sign
				});
				if (res.res_code === 0) {
					return {
						index,
						downloadUrl: res.fileDownloadUrl
					};
				} else if (res.errorCode === 'InvalidSessionKey') {
					return {
						index,
						downloadUrl: 'æç¤ºï¼š<br/>è¯·å…ˆç™»å½•ç½‘ç›˜~'
					};
				} else if (res.res_code === 'ShareNotFoundFlatDir') {
					return {
						index,
						downloadUrl: 'æç¤ºï¼š<br/>è¯·[è½¬å­˜]æ–‡ä»¶ï¼Œä¹‹åå†ğŸ‘‰å‰å¾€[æˆ‘çš„ç½‘ç›˜]ä¸­ä¸‹è½½å“¦~'
					};
				} else {
					return {
						index,
						downloadUrl: 'è·å–ä¸‹è½½åœ°å€å¤±è´¥ï¼Œåˆ·æ–°åå†è¯•è¯•å§~' + (res.res_code ? res.res_code : "")
					};
				}
			} catch (e) {
				return {
					index,
					downloadUrl: 'è·å–ä¸‹è½½åœ°å€å¤±è´¥ï¼Œåˆ·æ–°åå†è¯•è¯•å§~'
				};
			}
		},

		async getPCSLink() {
			selectList = this.getSelectedList();
			if (selectList.length === 0) {
				return message.error('æç¤ºï¼š<br/>è¯·å‹¾é€‰è¦ä¸‹è½½çš„æ–‡ä»¶å“¦~');
			}
			if (this.isOnlyFolder()) {
				return message.error('æç¤ºï¼š<br/>è¯·æ‰“å¼€æ–‡ä»¶å¤¹åå†å‹¾é€‰æ–‡ä»¶~');
			}
			let token = base.getStorage('accessToken') || await this.getToken();
			if (!token) {
				return message.error('æç¤ºï¼š<br/>è¯·å…ˆç™»å½•ç½‘ç›˜~');
			}
			let queue = [];
			for (const [index, item] of selectList.entries()) {
				queue.push(this.getFileUrlByOnce(item, index, token));
			}

			const res = await Promise.all(queue);
			res.forEach(val => {
				selectList[val.index].downloadUrl = val.downloadUrl;
			});

			let html = this.generateDom(selectList);
			this.showMainDialog(config.base.dom.button[mode].title, html, config.base.dom.button[mode].footer);
		},

		generateDom(list) {
			if (!list) {
				return message.error('æç¤ºï¼š<br/>è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œåˆ·æ–°ç½‘é¡µåå†è¯•è¯•å§~');
			}
			let content = '<div class="pl-main">';
			let alinkAllText = '';
			list.forEach((v, i) => {
				if (v.isFolder) return;
				let filename = v.fileName;
				let size = base.sizeFormat(v.size);
				let dlink = v.downloadUrl;
				if (!dlink || !dlink.includes("http")) {
					content += `<div class="pl-item">
						<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
						<div class="pl-item-tip">è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œåˆ·æ–°ç½‘é¡µåå†è¯•è¯•å§~</div>
					</div>`;
				} else {
					if (mode === 'api') {
						alinkAllText += dlink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<button class="pl-item-link listener-tip pl-btn-primary listener-link-api blob" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œè‹¥æ–‡ä»¶è¿‡å¤§ä¸‹è½½å®Œæˆåæœ‰å¯èƒ½ä¸ä¼šå¼¹å‡ºçª—å£ï¼Œæ­¤æ—¶è¯·æ¢ç”¨â€œRPCä¸‹è½½ + Mortixâ€çš„ç»„åˆ<br/>åŸºäºæµè§ˆå™¨çš„ Blob æ–‡ä»¶æµä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒæ–°çš„æµè§ˆå™¨ï¼Œå¯ä»¥åœ¨æ­¤çª—å£ä¸­æ˜¾ç¤ºä¸‹è½½å‰©ä½™æ—¶é—´å’Œä¸‹è½½é€Ÿåº¦ï¼Œæ­¤æ–¹å¼ä¸‹è½½ä¸ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥" data-filename="${filename}" data-size="${v.size}" data-link="${dlink}" data-index="${i}">å¢å¼ºä¸‹è½½(åŸºäºæµè§ˆå™¨æ–‡ä»¶æµ)</button>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-info listener-link-api browser" data-title="åŸºäºæµè§ˆå™¨ç›´æ¥æ‰“å¼€é“¾æ¥æ¥ä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒä¸ºå¤è€ä½†æ”¯æŒ iframe çš„æµè§ˆå™¨ï¼Œç‚¹å‡»â€œç›´æ¥ä¸‹è½½â€åéœ€ç­‰å¾…ä¸‹è½½æç¤ºå¼¹å‡ºæ‰èƒ½ç‚¹å‡»ä¸‹ä¸ªâ€œç›´æ¥ä¸‹è½½â€ï¼Œå¦åˆ™åªä¼šä¸‹è½½åè€…ï¼Œæ­¤æ–¹å¼ä¸‹è½½æœ‰å¯èƒ½ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥" data-filename="${filename}" data-link="${dlink}">ç›´æ¥ä¸‹è½½(åŸºäºæµè§ˆå™¨é“¾æ¥)</button>
							<button class="pl-item-copy pl-btn-primary pl-btn-warning listener-copy-all" href="${dlink}" data-filename="${filename}" data-link="${dlink}">å¤åˆ¶é“¾æ¥</button>
							<div class="pl-item-progress" style="display: none">
								<div class="pl-progress">
									<div class="pl-progress-outer"></div>
									<div class="pl-progress-inner" style="width:5%">
									<div class="pl-progress-inner-text">æ­£åœ¨åŠ è½½è¿›åº¦...0%</div>
									</div>
								</div>
								<span class="pl-btn-primary pl-btn-danger pl-progress-stop listener-stop">å–æ¶ˆä¸‹è½½</span>
								<span class="pl-btn-primary pl-btn-info pl-progress-back listener-back" style="display: none">è¿”å›</span>
							</div>
						</div>`;
					}
					if (mode === 'aria') {
						let alink = this.convertLinkToAria(dlink, filename, navigator.userAgent);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="ç‚¹å‡»å¤åˆ¶ aria2c å‘½ä»¤è¡Œ" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>å¤åˆ¶ ${filename} ä¸‹è½½å‘½ä»¤è¡Œ</a>
						</div>`;
					}
					if (mode === 'rpc') {
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<button class="pl-item-link listener-link-rpc pl-btn-primary pl-btn-info" data-filename="${filename}" data-link="${dlink}"><svg class="icon-rpc-devices" viewBox="-10 0 1034 1024"><g transform="matrix(1 0 0 -1 0 960)"><path fill="currentColor" d="M832 -64h-640q-53 0 -90.5 37.5t-37.5 90.5v768q0 53 37.5 90.5t90.5 37.5h640q53 0 90.5 -37.5t37.5 -90.5v-768q0 -53 -37.5 -90.5t-90.5 -37.5zM832 768q0 27 -18.5 45.5t-45.5 18.5h-512q-27 0 -45.5 -18.5t-18.5 -45.5v-320h640v320v0zM832 320h-640v-192q0 -27 18.5 -45.5t45.5 -18.5h512q27 0 45.5 18.5t18.5 45.5v192v0zM512 128q-27 0 -45.5 18.5t-18.5 45.5t18.5 45.5t45.5 18.5t45.5 -18.5t18.5 -45.5t-18.5 -45.5t-45.5 -18.5z" /></g></svg><span style="margin-left: 5px;">å°† ${filename} æ¨é€åˆ° RPC ä¸‹è½½å™¨</span></button>
						</div>`;
					}
					if (mode === 'curl') {
						let alink = this.convertLinkToCurl(dlink, filename, navigator.userAgent);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="ç‚¹å‡»å¤åˆ¶ curl å‘½ä»¤è¡Œ" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>å¤åˆ¶ ${filename} ä¸‹è½½å‘½ä»¤è¡Œ</a>
						</div>`;
					}
					if (mode === 'bc') {
						let alink = this.convertLinkToBC(dlink, filename, navigator.userAgent);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<a class="pl-item-link" href="${decodeURIComponent(alink)}" title="ç‚¹å‡»ç”¨æ¯”ç‰¹å½—æ˜Ÿä¸‹è½½" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>ä¸‹è½½ ${filename}</a>
						</div>`;
					}
				}
			});
			content += '</div>';
			if (mode === 'api')
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-tip listener-download-all" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œè‹¥æ–‡ä»¶è¿‡å¤§ä¸‹è½½å®Œæˆåæœ‰å¯èƒ½ä¸ä¼šå¼¹å‡ºçª—å£ï¼Œæ­¤æ—¶è¯·æ¢ç”¨â€œRPCä¸‹è½½ + Mortixâ€çš„ç»„åˆ<br/>åŸºäºæµè§ˆå™¨çš„ Blob æ–‡ä»¶æµä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒæ–°çš„æµè§ˆå™¨ï¼Œå¯ä»¥åœ¨æ­¤çª—å£ä¸­æ˜¾ç¤ºä¸‹è½½å‰©ä½™æ—¶é—´å’Œä¸‹è½½é€Ÿåº¦ï¼Œæ­¤æ–¹å¼ä¸‹è½½ä¸ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥">å…¨éƒ¨å¢å¼ºä¸‹è½½</button><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨é“¾æ¥</button></div>`;
			if (mode === 'aria')
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨å‘½ä»¤è¡Œ</button></div>`;
			if (mode === 'rpc') {
				let rpc = base.getValue('setting_rpc_domain') + ':' + base.getValue('setting_rpc_port') + base.getValue('setting_rpc_path');
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-send-rpc">å‘é€å…¨éƒ¨é“¾æ¥</button><button title="${rpc}" class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px">ä¿®æ”¹ RPC å‚æ•°ï¼ˆ${rpc}ï¼‰</button><button class="pl-btn-primary pl-btn-success pl-btn-opacity listener-rpc-task" style="margin-left: 10px;display: none">æŸ¥çœ‹ä¸‹è½½ä»»åŠ¡</button></div>`;
			}
			if (mode === 'curl') {
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨å‘½ä»¤è¡Œ</button><button class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px;">ä¿®æ”¹ç»ˆç«¯ç±»å‹ï¼ˆ${terminalType[base.getValue('setting_terminal_type')]}ï¼‰</button></div>`;
			}
			if (mode === 'bc') {
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨é“¾æ¥</button></div>`;
			}
			return content;
		},

		async sendLinkToRPC(filename, link) {
			let rpc = {
				domain: base.getValue('setting_rpc_domain'),
				port: base.getValue('setting_rpc_port'),
				path: base.getValue('setting_rpc_path'),
				token: base.getValue('setting_rpc_token'),
				dir: base.getValue('setting_rpc_dir'),
			};

			let url = `${rpc.domain}:${rpc.port}${rpc.path}`;
			let rpcData = {
				id: new Date().getTime(),
				jsonrpc: '2.0',
				method: 'aria2.addUri',
				params: [`token:${rpc.token}`, [link], {
					dir: rpc.dir,
					out: filename,
					header: []
				}]
			};
			try {
				let res = await base.post(url, rpcData, {}, '');
				if (res.result) return 'success';
				return 'fail';
			} catch (e) {
				return 'fail';
			}
		},

		getSelectedList() {
			try {
				return document.querySelector(".c-file-list").__vue__.selectedList;
			} catch (e) {
				return [document.querySelector(".info-detail").__vue__.fileDetail];
			}
		},

		detectPage() {
			let path = location.pathname;
			if (/^\/web\/main/.test(path)) return 'home';
			if (/^\/web\/share/.test(path)) return 'share';
			return '';
		},

		isOnlyFolder() {
			for (let i = 0; i < selectList.length; i++) {
				if (!selectList[i].isFolder) return false;
			}
			return true;
		},

		showMainDialog(title, html, footer) {
			Swal.fire({
				title,
				html,
				footer,
				customClass,
				position: 'center',
				padding: '15px 20px 5px',
				confirmButtonText: 'å…³é—­',
				showCloseButton: true,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				willClose: function () {
					base._resetData();
				},
				...swalDefault
			}).then(function () {
				base._resetData();
			});
		},

		async initPanLinker() {
			page = this.detectPage();
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
				this.addPageListener();
			} else {
				this.addInitButton();
			}
			this.getToken();
		}
	};

	//è¿…é›·äº‘ç›˜
	let xunlei = {
		convertLinkToAria(link, filename, ua) {
			filename = base.fixFilename(filename);
			return encodeURIComponent(`aria2c "${link}" --out "${filename}"`);
		},

		convertLinkToBC(link, filename, ua) {
			let bc = `AA/${encodeURIComponent(filename)}/?url=${encodeURIComponent(link)}ZZ`;
			return encodeURIComponent(`bc://http/${base.encode(bc)}`);
		},

		convertLinkToCurl(link, filename, ua) {
			let terminal = base.getValue('setting_terminal_type');
			filename = base.fixFilename(filename);
			return encodeURIComponent(`${terminal !== 'wp' ? 'curl' : 'curl.exe'} -L -C - "${link}" -o "${filename}"`);
		},

		addPageListener() {
			/*
			é˜²æ­¢ä»£ç å› å…¶ä»–åŸå› è¢«æ‰§è¡Œå¤šæ¬¡
			è¿™æ®µä»£ç å‡ºè‡ª Viaè½»æ’ä»¶ï¼Œä½œè€…è°·èŠ±æ³°
			*/
			const key = encodeURIComponent('ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹:è¿…é›·äº‘ç›˜');
			if (window[key]) return;
			window[key] = true;

			function _factory(e) {
				let target = $(e.target);
				let item = target.parents('.pl-item');
				let link = item.find('.pl-item-link.blob');
				let directLink = item.find('.pl-item-link.browser');
				let progress = item.find('.pl-item-progress');
				let tip = item.find('.pl-item-tip');
				let copy = item.find('.pl-item-copy');
				let howidm = item.find('.pl-progress-how');
				let back = item.find('.pl-progress-back');
				let stop = item.find('.pl-progress-stop');
				return {
					item, link, directLink, progress, tip, copy, howidm, back, stop, target,
				};
			}

			function _reset(i) {
				ins[i] && clearInterval(ins[i]);
				request[i] && request[i].abort();
				progress[i] = 0;
				idm[i] = false;
			}

			doc.on('click', '.pl-button-mode', function (e) {
				mode = e.target.dataset.mode;
				if (!mode) return;
				Swal.fire({
					showConfirmButton: false,
					allowOutsideClick: false,
					allowEscapeKey: false,
					allowEnterKey: false,
					html: `<div id="loadingText">é“¾æ¥è·å–ä¸­</div>`,
					willOpen: function () {
						Swal.showLoading();
					},
					...swalDefault
				});
				xunlei.getPCSLink();
			});
			doc.on('click', '.pl-button-save', async function (e) {
				e.preventDefault();
				selectList = xunlei.getSelectedList();
				if (selectList.length === 0) {
					return message.error('æç¤ºï¼š<br/>è¯·å‹¾é€‰è¦ä¿å­˜åˆ°ç½‘ç›˜çš„æ–‡ä»¶å“¦~');
				}
				message.info('æç¤ºï¼š<br/>å› ç½‘ç›˜é™åˆ¶ï¼Œè¯·ä¿å­˜åˆ°è‡ªå·±ç½‘ç›˜åå†å»ä¸‹è½½å“¦~');
				await base.sleep(500);
				document.querySelector('.saveToCloud').click();
			});
			doc.on('click', '.listener-link-api.browser', async function (e) {
				e.preventDefault();
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				$('#downloadIframe').attr('src', href);
			});
			doc.on('click', '.listener-link-api.blob', async function (e) {
				e.preventDefault();
				let o = _factory(e);
				let $width = o.item.find('.pl-progress-inner');
				let $text = o.item.find('.pl-progress-inner-text');
				let filename = o.link[0].dataset.filename;
				let index = o.link[0].dataset.index;
				_reset(index);
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				base.get(href, { "Referer": `https://${location.host}/` }, 'blob', { filename, index });
				let startTime = Date.now(); // è®°å½•ä¸‹è½½å¼€å§‹æ—¶é—´
				let prevLoaded = 0; // ä¸Šä¸€æ¬¡çš„å·²ä¸‹è½½æ•°æ®é‡
				let prevTime = startTime; // ä¸Šä¸€æ¬¡çš„æ—¶é—´
				let size = Number(o.link[0].dataset.size);
				ins[index] = setInterval(function () {
					let prog = +progress[index] || 0;
					let isIDM = idm[index] || false;

					// å¤„ç†æ™®é€šä¸‹è½½çš„æƒ…å†µ...
					let currentTime = Date.now();
					let elapsedTime = currentTime - startTime;
					let totalProgress = prog / 100;
					let totalElapsedSeconds = elapsedTime / 1000;
					let estimatedTotalTimeSeconds = totalElapsedSeconds / totalProgress;
					let remainingTimeSeconds = estimatedTotalTimeSeconds - totalElapsedSeconds;

					// å°†å‰©ä½™æ—¶é—´è½¬æ¢ä¸ºå¤©ã€æ—¶ã€åˆ†ã€ç§’
					let remainingDays = Math.floor(remainingTimeSeconds / (60 * 60 * 24));
					remainingTimeSeconds %= (60 * 60 * 24);

					let remainingHours = Math.floor(remainingTimeSeconds / (60 * 60));
					remainingTimeSeconds %= (60 * 60);

					let remainingMinutes = Math.floor(remainingTimeSeconds / 60);
					let remainingSeconds = Math.floor(remainingTimeSeconds % 60);

					// è®¡ç®—ä¸‹è½½é€Ÿåº¦
					let loaded = prog * size / 100; // å·²ä¸‹è½½æ•°æ®é‡
					let currentTimeDiff = currentTime - prevTime; // å½“å‰æ—¶é—´ä¸ä¸Šä¸€æ¬¡æ—¶é—´çš„å·®å€¼
					let loadedDiff = loaded - prevLoaded; // å½“å‰å·²ä¸‹è½½æ•°æ®é‡ä¸ä¸Šä¸€æ¬¡çš„å·®å€¼
					let downloadSpeed = (currentTimeDiff !== 0) ? loadedDiff / (currentTimeDiff / 1000) : 0; // ä¸‹è½½é€Ÿåº¦ï¼ˆå•ä½ï¼šå­—èŠ‚/ç§’ï¼‰

					// æ›´æ–°ä¸Šä¸€æ¬¡çš„æ•°æ®
					prevLoaded = loaded;
					prevTime = currentTime;

					// æ›´æ”¹ç•Œé¢
					o.link.hide();
					o.directLink.hide();
					o.tip.hide();
					o.stop.show();
					o.copy.hide();
					o.progress.show();

					// æ›´æ–°è¿›åº¦æ¡
					$width.css('width', prog + '%');

					// æ›´æ–°è¿›åº¦æ¡æ–‡æœ¬
					let timeText = '';
					if (Number.isFinite(remainingDays) && remainingDays > 0) {
						timeText = remainingDays + 'å¤© ' + base.repairTimer(remainingHours) + 'æ—¶:' + base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
					} else if (Number.isFinite(remainingHours) && remainingHours > 0) {
						timeText = base.repairTimer(remainingHours) + 'æ—¶:' + base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
					} else if (Number.isFinite(remainingMinutes) && remainingMinutes > 0) {
						timeText = base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
					} else if (Number.isFinite(remainingSeconds) && remainingSeconds > 0) {
						timeText = remainingSeconds + 'ç§’';
					} else if (Number.isFinite(remainingSeconds) && remainingSeconds === 0) {
						timeText = 'å³å°†å®Œæˆ';
					} else {
						timeText = 'è®¡ç®—ä¸­...';
					}

					let speedText = '';
					speedText = base.sizeFormat(downloadSpeed)
					$text.text(prog + '% | å‰©ä½™æ—¶é—´ï¼š' + timeText + ' | é€Ÿåº¦ï¼š' + speedText + '/ç§’');

					if (prog === 100) {
						setTimeout(function () {
							clearInterval(ins[index]);
							progress[index] = 0;
							o.item.find('.pl-progress-stop').hide();
							o.howidm.hide();
							$text.text('ä¸‹è½½å®Œæˆ~ æµè§ˆå™¨ä¸‹è½½æ¡†åº”è¯¥å¼¹å‡ºæ¥äº†å“¦~');
							o.back.show()
							setTimeout(function () {
								o.link.text('å¢å¼ºä¸‹è½½(åŸºäºæµè§ˆå™¨æ–‡ä»¶æµ)').animate({ opacity: '1' }, "slow");
							}, 3000)
						}, 1000)
					}
				}, 500);
			});
			doc.on('click', '.listener-retry', async function (e) {
				let o = _factory(e);
				o.tip.hide();
				o.link.show();
				o.directLink.show();
			});
			doc.on('click', '.listener-stop', async function (e) {
				let o = _factory(e);
				let index = o.link[0].dataset.index;
				if (request[index]) {
					request[index].abort();
					clearInterval(ins[index]);
					o.item.find('.pl-progress-inner-text').text('æ­£åœ¨å–æ¶ˆ...');
					o.item.find('.pl-progress-inner').css('width', 100 + '%');
					setTimeout(function () {
						o.tip.hide();
						o.back.hide();
						o.link.show();
						o.directLink.show();
						o.copy.show();
						o.progress.hide();
						o.stop.hide();
					}, 1050)
				}
			});
			doc.on('click', '.listener-back', async function (e) {
				let o = _factory(e);
				o.progress.hide();
				o.tip.hide();
				o.link.show();
				o.directLink.show();
				o.copy.show();
				o.stop.hide();
				o.back.hide();
			});
			doc.on('click', '.listener-download-all', function (e) {
				$('.pl-item-link.blob').each(function () {
					if ($(this).css('display') !== 'none') {
						$(this).click();
					}
				});
				$(e.target).text('ä¸‹è½½å¼€å§‹ï¼Œä¸‹è½½è¿›åº¦è§ä¸Šæ–¹æŒ‰é’®å“¦~').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('å…¨éƒ¨å¢å¼ºä¸‹è½½').animate({ opacity: '1' }, "slow");
				}, 2000)
			});

			doc.on('click', '.listener-copy-filename', async function (e) {
				base.setClipboard(e.target.dataset.filename);
				$(e.target).text('å¤åˆ¶æˆåŠŸ').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('é‡æ–°å¤åˆ¶').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-bc-btn', async function (e) {
				let mirror = base.getMirrorList(e.target.dataset.dlink, config.xunlei.api.mirror);
				base.setClipboard(mirror);
				$(e.target).text('å¤åˆ¶æˆåŠŸ').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('é‡æ–°å¤åˆ¶').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-aria, .listener-copy-all', function (e) {
				e.preventDefault();
				base.setClipboard(decodeURIComponent(e.target.dataset.link));
				$(e.target).text('å¤åˆ¶æˆåŠŸ').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('é‡æ–°å¤åˆ¶').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-rpc', async function (e) {
				let target = $(e.currentTarget);

				target.find('.icon-rpc-devices').remove();
				target.find('.pl-loading').remove();
				target.prepend(base.createLoading());

				let res = await xunlei.sendLinkToRPC(e.currentTarget.dataset.filename, e.currentTarget.dataset.link);
				if (res === 'success') {
					$('.listener-rpc-task').show();
					target.removeClass('pl-btn-danger').html('å‘é€æˆåŠŸäº†!å¿«å»çœ‹çœ‹å§~').animate({ opacity: '0.5' }, "slow");
				} else if (res === 'assistant') {
					target.addClass('pl-btn-danger').html(`${config.base.assistant.message}ğŸ‘‰<a href="${config.base.assistant.link}" target="_blank" class="pl-a">ç‚¹å‡»æ­¤å¤„å®‰è£…</a>ğŸ‘ˆ`);
				} else {
					target.addClass('pl-btn-danger').text('å‘é€å¤±è´¥ï¼Œæ£€æŸ¥ä¸€ä¸‹æ‚¨çš„RPCé…ç½®ä¿¡æ¯å“¦!').animate({ opacity: '0.5' }, "slow");
				}
			});
			doc.on('click', '.listener-send-rpc', function (e) {
				$('.listener-link-rpc').click();
				$(e.target).text('å‘é€å®Œæˆï¼Œå‘é€ç»“æœè§ä¸Šæ–¹æŒ‰é’®å“¦~').animate({ opacity: '0.5' }, "slow");
			});
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdateLog();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-rpc-task', function () {
				let rpc = JSON.stringify({
					domain: base.getValue('setting_rpc_domain'),
					port: base.getValue('setting_rpc_port'),
				}), url = `${config.base.service.rpc}/?rpc=${base.encode(rpc)}#${base.getValue('setting_rpc_token')}`;
				GM_openInTab(url, { active: true });
			});
		},

		addButton() {
			if (!page) return;
			let $toolWrap;
			let $button = $(`
				<div class="xunlei-button pl-button"><i class="xlpfont xlp-download"></i><span style="font-size: 13px;margin-left: 6px;">ä¸‹è½½åŠ©æ‰‹</span>
					<ul class="pl-dropdown-menu" style="top: 34px;">
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="api">APIä¸‹è½½</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="aria">Ariaä¸‹è½½</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="rpc">RPCä¸‹è½½</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="curl">cURLä¸‹è½½</li>
						<li class="pl-dropdown-menu-item pl-button-mode" data-mode="bc">BCä¸‹è½½</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">åŠ©æ‰‹è®¾ç½®</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">åŠ©æ‰‹ç¾åŒ–</li>
						<li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">æ›´æ–°æ—¥å¿—</li>
					</ul>
				</div>
			`);
			if (page === 'home') {
				base.listenElement(config.xunlei.mount.home, function () {
					$toolWrap = $(config.xunlei.mount.home);
					$('.pl-button').length === 0 && $toolWrap.prepend($button);
				})
			}
			if (page === 'share') {
				$button = $(`
					<div class="xunlei-button pl-button">
						<i class="xlpfont xlp-download"></i><span style="font-size: 13px;margin-left: 6px;">ä¸‹è½½åŠ©æ‰‹</span>
						<ul class="pl-dropdown-menu" style="top: 34px;">
							<li class="pl-dropdown-menu-item pl-button-mode pl-button-save"><i class="xlpfont xlp-file-upload"></i><span style="margin-left: 3px;">è½¬å­˜åä¸‹è½½</span></li>
							<li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">åŠ©æ‰‹è®¾ç½®</li>
							<li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">åŠ©æ‰‹ç¾åŒ–</li>
							<li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">æ›´æ–°æ—¥å¿—</li>
						</ul>
					</div>
				`);
				$button.css({ 'margin-right': '10px' });
				base.listenElement(config.xunlei.mount.share, function () {
					$toolWrap = $(config.xunlei.mount.share);
					$('.pl-button').length === 0 && $toolWrap.prepend($button);
				})
			}
			base.createDownloadIframe();
		},

		addInitButton() {
			if (!page) return;
			let $toolWrap;
			let $button = $(`<div class="xunlei-button pl-button-init"><i class="xlpfont xlp-download"></i><span style="font-size: 13px;margin-left: 6px;">ç‚¹æˆ‘ç‚¹äº®</span></div>`);
			if (page === 'home') {
				base.listenElement(config.xunlei.mount.home, function () {
					$toolWrap = $(config.xunlei.mount.home);
					$('.pl-button-init').length === 0 && $toolWrap.prepend($button);
				})
			}
			if (page === 'share') {
				$button.css({ 'margin-right': '10px' });
				base.listenElement(config.xunlei.mount.share, function () {
					$toolWrap = $(config.xunlei.mount.share);
					$('.pl-button-init').length === 0 && $toolWrap.prepend($button);
				})
			}
			$button.click(function () { base.initDialog() });
		},

		getToken() {
			let credentials = {}, captcha = {};
			for (let i = 0; i < localStorage.length; i++) {
				if (/^credentials_/.test(localStorage.key(i))) {
					credentials = base.getStorage(localStorage.key(i));
					base.setStorage('');
				}
				if (/^captcha_[\w]{16}/.test(localStorage.key(i))) {
					captcha = base.getStorage(localStorage.key(i));
				}
			}
			let deviceid = /(\w{32})/.exec(base.getStorage('deviceid').split(','))[0];
			let token = {
				credentials,
				captcha,
				deviceid
			};
			return token;
		},

		async getFileUrlByOnce(item, index, token) {
			try {
				if (item.downloadUrl) return {
					index,
					downloadUrl: item.downloadUrl
				};
				let res = await base.get(config.xunlei.api.getLink + item.id, {
					'Authorization': `${token.credentials.token_type} ${token.credentials.access_token}`,
					'content-type': "application/json",
					'x-captcha-token': token.captcha.token,
					'x-device-id': token.deviceid,
				});
				if (res.web_content_link) {
					return {
						index,
						downloadUrl: res.web_content_link
					};
				} else {
					return {
						index,
						downloadUrl: 'è·å–ä¸‹è½½åœ°å€å¤±è´¥ï¼Œåˆ·æ–°åå†è¯•è¯•å§~'
					};
				}
			} catch (e) {
				return message.error('æç¤ºï¼š<br/>è¯·å…ˆç™»å½•ç½‘ç›˜åå†åˆ·æ–°é¡µé¢å‘¢~');
			}
		},

		async getPCSLink() {
			selectList = this.getSelectedList();
			if (selectList.length === 0) {
				return message.error('æç¤ºï¼š<br/>è¯·å‹¾é€‰è¦ä¸‹è½½çš„æ–‡ä»¶å“¦~');
			}
			if (this.isOnlyFolder()) {
				return message.error('æç¤ºï¼š<br/>è¯·æ‰“å¼€æ–‡ä»¶å¤¹åå†å‹¾é€‰æ–‡ä»¶~');
			}
			if (page === 'home') {
				let queue = [];
				let token = this.getToken();
				for (const [index, item] of selectList.entries()) {
					queue.push(this.getFileUrlByOnce(item, index, token));
				}

				const res = await Promise.all(queue);
				res.forEach(val => {
					selectList[val.index].downloadUrl = val.downloadUrl;
				});
			} else {
				return message.error('æç¤ºï¼š<br/>é¡µé¢é”™è¯¯~');
			}
			let html = this.generateDom(selectList);
			this.showMainDialog(config.base.dom.button[mode].title, html, config.base.dom.button[mode].footer);

		},

		generateDom(list) {
			if (!list) {
				return message.error('æç¤ºï¼š<br/>è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œåˆ·æ–°ç½‘é¡µåå†è¯•è¯•å§~');
			}
			let content = '<div class="pl-main">';
			let alinkAllText = '';
			list.forEach((v, i) => {
				if (v.kind === 'drive#folder') return;
				let filename = v.name;
				let size = base.sizeFormat(+v.size);
				let dlink = v.downloadUrl;
				if (!dlink || !dlink.includes("http")) {
					content += `<div class="pl-item">
						<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
						<div class="pl-item-tip">è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œåˆ·æ–°ç½‘é¡µåå†è¯•è¯•å§~</div>
					</div>`;
				} else {
					if (mode === 'api') {
						alinkAllText += dlink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<button class="pl-item-link listener-tip pl-btn-primary listener-link-api blob" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œè‹¥æ–‡ä»¶è¿‡å¤§ä¸‹è½½å®Œæˆåæœ‰å¯èƒ½ä¸ä¼šå¼¹å‡ºçª—å£ï¼Œæ­¤æ—¶è¯·æ¢ç”¨â€œRPCä¸‹è½½ + Mortixâ€çš„ç»„åˆ<br/>åŸºäºæµè§ˆå™¨çš„ Blob æ–‡ä»¶æµä¸‹è½½æ–‡ä»¶ï¼Œä¸‹è½½å®Œæˆå¯è‡ªåŠ¨å‘½åï¼Œé€‚ç”¨äºè¾ƒæ–°çš„æµè§ˆå™¨ï¼Œå¯ä»¥åœ¨æ­¤çª—å£ä¸­æ˜¾ç¤ºä¸‹è½½å‰©ä½™æ—¶é—´å’Œä¸‹è½½é€Ÿåº¦ï¼Œæ­¤æ–¹å¼ä¸‹è½½ä¸ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥" data-filename="${filename}" data-size="${v.size}" data-link="${dlink}" data-index="${i}">å¢å¼ºä¸‹è½½(åŸºäºæµè§ˆå™¨æ–‡ä»¶æµ)</button>
							<a class="pl-item-link listener-tip pl-btn-primary pl-btn-info listener-link-api browser" data-title="åŸºäºæµè§ˆå™¨ç›´æ¥æ‰“å¼€é“¾æ¥æ¥ä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒä¸ºå¤è€ä½†æ”¯æŒ iframe çš„æµè§ˆå™¨ï¼Œç‚¹å‡»â€œç›´æ¥ä¸‹è½½â€åéœ€ç­‰å¾…ä¸‹è½½æç¤ºå¼¹å‡ºæ‰èƒ½ç‚¹å‡»ä¸‹ä¸ªâ€œç›´æ¥ä¸‹è½½â€ï¼Œå¦åˆ™åªä¼šä¸‹è½½åè€…ï¼Œè‹¥æœåŠ¡å™¨æœªå›æŠ¥æ–‡ä»¶åï¼Œæ­¤æ–¹å¼ä¸‹è½½ä¸ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥ï¼Œæ­¤æ—¶å»ºè®®å³é”®æ­¤æŒ‰é’®ï¼Œé€‰æ‹© â€œä½¿ç”¨ IDM ä¸‹è½½â€" data-filename="${filename}" data-link="${dlink}" href="${dlink}">ç›´æ¥ä¸‹è½½(åŸºäºæµè§ˆå™¨é“¾æ¥)</a>
							<button class="pl-item-copy listener-tip pl-btn-primary pl-btn-success listener-copy-filename" data-title="æœ¬ç½‘ç›˜ä¸‹è½½æ—¶å¯èƒ½ä¸ä¼šæ˜¾ç¤ºæ–‡ä»¶åç§°ï¼Œè¿™æ—¶éœ€è¦æ‰‹åŠ¨å¤åˆ¶æ–‡ä»¶åç§°åˆ°ä¸‹è½½å·¥å…·ä¸­" data-filename="${filename}">å¤åˆ¶åç§°</button>
							<button class="pl-item-copy pl-btn-primary pl-btn-warning listener-copy-all" href="${dlink}" data-filename="${filename}" data-link="${dlink}">å¤åˆ¶é“¾æ¥</button>
							<div class="pl-item-progress" style="display: none">
								<div class="pl-progress">
									<div class="pl-progress-outer"></div>
									<div class="pl-progress-inner" style="width:5%">
									<div class="pl-progress-inner-text">æ­£åœ¨åŠ è½½è¿›åº¦...0%</div>
									</div>
								</div>
								<span class="pl-btn-primary pl-btn-danger pl-progress-stop listener-stop">å–æ¶ˆä¸‹è½½</span>
								<span class="pl-btn-primary pl-btn-info pl-progress-back listener-back" style="display: none">è¿”å›</span>
							</div>
						</div>`;
					}
					if (mode === 'aria') {
						let alink = this.convertLinkToAria(dlink, filename, navigator.userAgent);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="ç‚¹å‡»å¤åˆ¶ aria2c å‘½ä»¤è¡Œ" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>å¤åˆ¶ ${filename} ä¸‹è½½å‘½ä»¤è¡Œ</a>
						</div>`;
					}
					if (mode === 'rpc') {
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<button class="pl-item-link listener-link-rpc pl-btn-primary pl-btn-info" data-filename="${filename}" data-link="${dlink}"><svg class="icon-rpc-devices" viewBox="-10 0 1034 1024"><g transform="matrix(1 0 0 -1 0 960)"><path fill="currentColor" d="M832 -64h-640q-53 0 -90.5 37.5t-37.5 90.5v768q0 53 37.5 90.5t90.5 37.5h640q53 0 90.5 -37.5t37.5 -90.5v-768q0 -53 -37.5 -90.5t-90.5 -37.5zM832 768q0 27 -18.5 45.5t-45.5 18.5h-512q-27 0 -45.5 -18.5t-18.5 -45.5v-320h640v320v0zM832 320h-640v-192q0 -27 18.5 -45.5t45.5 -18.5h512q27 0 45.5 18.5t18.5 45.5v192v0zM512 128q-27 0 -45.5 18.5t-18.5 45.5t18.5 45.5t45.5 18.5t45.5 -18.5t18.5 -45.5t-18.5 -45.5t-45.5 -18.5z" /></g></svg><span style="margin-left: 5px;">å°† ${filename} æ¨é€åˆ° RPC ä¸‹è½½å™¨</span></button>
						</div>`;
					}
					if (mode === 'curl') {
						let alink = this.convertLinkToCurl(dlink, filename, navigator.userAgent);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="ç‚¹å‡»å¤åˆ¶ curl å‘½ä»¤è¡Œ" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>å¤åˆ¶ ${filename} ä¸‹è½½å‘½ä»¤è¡Œ</a>
						</div>`;
					}
					if (mode === 'bc') {
						let alink = this.convertLinkToBC(dlink, filename, navigator.userAgent);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<a class="pl-item-link" href="${decodeURIComponent(alink)}" title="ç‚¹å‡»ç”¨æ¯”ç‰¹å½—æ˜Ÿä¸‹è½½" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>ä¸‹è½½ ${filename}</a>
							<button class="pl-btn-primary listener-link-bc-btn" data-dlink="${dlink}">å¤åˆ¶é•œåƒåœ°å€</div>
						</div>`;
					}
				}
			});
			content += '</div>';
			if (mode === 'api')
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-tip listener-download-all" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œè‹¥æ–‡ä»¶è¿‡å¤§ä¸‹è½½å®Œæˆåæœ‰å¯èƒ½ä¸ä¼šå¼¹å‡ºçª—å£ï¼Œæ­¤æ—¶è¯·æ¢ç”¨â€œRPCä¸‹è½½ + Mortixâ€çš„ç»„åˆ<br/>åŸºäºæµè§ˆå™¨çš„ Blob æ–‡ä»¶æµä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒæ–°çš„æµè§ˆå™¨ï¼Œå¯ä»¥åœ¨æ­¤çª—å£ä¸­æ˜¾ç¤ºä¸‹è½½å‰©ä½™æ—¶é—´å’Œä¸‹è½½é€Ÿåº¦ï¼Œæ­¤æ–¹å¼ä¸‹è½½ä¸ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥">å…¨éƒ¨å¢å¼ºä¸‹è½½</button><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨é“¾æ¥</button></div>`;
			if (mode === 'aria')
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨å‘½ä»¤è¡Œ</button></div>`;
			if (mode === 'rpc') {
				let rpc = base.getValue('setting_rpc_domain') + ':' + base.getValue('setting_rpc_port') + base.getValue('setting_rpc_path');
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-send-rpc">å‘é€å…¨éƒ¨é“¾æ¥</button><button title="${rpc}" class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px">ä¿®æ”¹ RPC å‚æ•°ï¼ˆ${rpc}ï¼‰</button><button class="pl-btn-primary pl-btn-success pl-btn-opacity listener-rpc-task" style="margin-left: 10px;display: none">æŸ¥çœ‹ä¸‹è½½ä»»åŠ¡</button></div>`;
			}
			if (mode === 'curl') {
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨å‘½ä»¤è¡Œ</button><button class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px;">ä¿®æ”¹ç»ˆç«¯ç±»å‹ï¼ˆ${terminalType[base.getValue('setting_terminal_type')]}ï¼‰</button></div>`;
			}
			if (mode === 'bc') {
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨é“¾æ¥</button></div>`;
			}
			return content;
		},

		async sendLinkToRPC(filename, link) {
			let rpc = {
				domain: base.getValue('setting_rpc_domain'),
				port: base.getValue('setting_rpc_port'),
				path: base.getValue('setting_rpc_path'),
				token: base.getValue('setting_rpc_token'),
				dir: base.getValue('setting_rpc_dir'),
			};

			let url = `${rpc.domain}:${rpc.port}${rpc.path}`;
			let rpcData = {
				id: new Date().getTime(),
				jsonrpc: '2.0',
				method: 'aria2.addUri',
				params: [`token:${rpc.token}`, [link], {
					dir: rpc.dir,
					out: filename,
					header: []
				}]
			};
			try {
				let res = await base.post(url, rpcData, {}, '');
				if (res.result) return 'success';
				return 'fail';
			} catch (e) {
				return 'fail';
			}
		},

		getSelectedList() {
			try {
				let doms = document.querySelectorAll('.SourceListItem__item--XxpOC');
				let selectedList = [];
				for (let dom of doms) {
					let domVue = dom.__vue__;
					if (domVue.selected.includes(domVue.info.id)) {
						selectedList.push(domVue.info);
					}
				}
				return selectedList;
			} catch (e) {
				return [];
			}
		},

		detectPage() {
			let path = location.pathname;
			if (/^\/$/.test(path)) return 'home';
			if (/^\/(s|share)\//.test(path)) return 'share';
			return '';
		},

		isOnlyFolder() {
			for (let i = 0; i < selectList.length; i++) {
				if (selectList[i].kind === 'drive#file') return false;
			}
			return true;
		},

		showMainDialog(title, html, footer) {
			Swal.fire({
				title,
				html,
				footer,
				customClass,
				position: 'center',
				padding: '15px 20px 5px',
				confirmButtonText: 'å…³é—­',
				showCloseButton: true,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				willClose: function () {
					base._resetData();
				},
				...swalDefault
			}).then(function () {
				base._resetData();
			});
		},

		async initPanLinker() {
			page = this.detectPage();
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
				this.addPageListener();
			} else {
				this.addInitButton();
			}
		}
	};

	//å¤¸å…‹ç½‘ç›˜
	let quark = {
		convertLinkToAria(link, filename, ua) {
			filename = base.fixFilename(filename);
			return encodeURIComponent(`aria2c "${link}" --out "${filename}" --header "Cookie: ${document.cookie}"`);
		},

		convertLinkToBC(link, filename, ua) {
			let bc = `AA/${encodeURIComponent(filename)}/?url=${encodeURIComponent(link)}&cookie=${encodeURIComponent(document.cookie)}ZZ`;
			return encodeURIComponent(`bc://http/${base.encode(bc)}`);
		},

		convertLinkToCurl(link, filename, ua) {
			let terminal = base.getValue('setting_terminal_type');
			filename = base.fixFilename(filename);
			return encodeURIComponent(`${terminal !== 'wp' ? 'curl' : 'curl.exe'} -L -C - "${link}" -o "${filename}" -b "${document.cookie}"`);
		},

		addPageListener() {
			/*
			é˜²æ­¢ä»£ç å› å…¶ä»–åŸå› è¢«æ‰§è¡Œå¤šæ¬¡
			è¿™æ®µä»£ç å‡ºè‡ª Viaè½»æ’ä»¶ï¼Œä½œè€…è°·èŠ±æ³°
			*/
			const key = encodeURIComponent('ï¼ˆæ”¹ï¼‰ç½‘ç›˜ç›´é“¾ä¸‹è½½åŠ©æ‰‹:å¤¸å®¢ç½‘ç›˜');
			if (window[key]) return;
			window[key] = true;

			function _factory(e) {
				let target = $(e.target);
				let item = target.parents('.pl-item');
				let link = item.find('.pl-item-link.blob');
				let directLink = item.find('.pl-item-link.browser');
				let progress = item.find('.pl-item-progress');
				let tip = item.find('.pl-item-tip');
				let copy = item.find('.pl-item-copy');
				let howidm = item.find('.pl-progress-how');
				let back = item.find('.pl-progress-back');
				let stop = item.find('.pl-progress-stop');
				return {
					item, link, directLink, progress, tip, copy, howidm, back, stop, target,
				};
			}

			function _reset(i) {
				ins[i] && clearInterval(ins[i]);
				request[i] && request[i].abort();
				progress[i] = 0;
				idm[i] = false;
			}

			window.addEventListener('hashchange', async function (e) {
				let home = 'https://pan.quark.cn/list#/', all = 'https://pan.quark.cn/list#/list/all';
				if (e.oldURL === home && e.newURL === all) return;
				await base.sleep(150);
				if ($('.quark-button').length > 0) return;
				if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
					this.addButton();
					this.addPageListener();
				} else {
					this.addInitButton();
				}
			});
			doc.on('click', '.pl-button-mode', function (e) {
				mode = e.target.dataset.mode;
				if (!mode) return;
				Swal.fire({
					showConfirmButton: false,
					allowOutsideClick: false,
					allowEscapeKey: false,
					allowEnterKey: false,
					html: `<div id="loadingText">é“¾æ¥è·å–ä¸­</div>`,
					willOpen: function () {
						Swal.showLoading();
					},
					...swalDefault
				});
				quark.getPCSLink();
			});
			doc.on('click', '.pl-button-save', async function (e) {
				e.preventDefault();
				selectList = quark.getSelectedList();
				if (selectList.length === 0) {
					return message.error('æç¤ºï¼š<br/>è¯·å‹¾é€‰è¦ä¿å­˜åˆ°ç½‘ç›˜çš„æ–‡ä»¶å“¦~');
				}
				message.info('æç¤ºï¼š<br/>å› ç½‘ç›˜é™åˆ¶ï¼Œè¯·ä¿å­˜åˆ°è‡ªå·±ç½‘ç›˜åå†å»ä¸‹è½½å“¦~');
				await base.sleep(500);
				document.querySelector('.file-info_r').click();
			});
			doc.on('click', '.listener-link-api.browser', async function (e) {
				e.preventDefault();
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				$('#downloadIframe').attr('src', href);
			});
			doc.on('click', '.listener-link-api.blob', async function (e) {
				e.preventDefault();
				let o = _factory(e);
				let $width = o.item.find('.pl-progress-inner');
				let $text = o.item.find('.pl-progress-inner-text');
				let filename = o.link[0].dataset.filename;
				let index = o.link[0].dataset.index;
				_reset(index);
				let dataset = e.currentTarget.dataset;
				let href = dataset.link;
				base.get(href, { "Referer": `https://${location.host}/` }, 'blob', { filename, index });
				let startTime = Date.now(); // è®°å½•ä¸‹è½½å¼€å§‹æ—¶é—´
				let prevLoaded = 0; // ä¸Šä¸€æ¬¡çš„å·²ä¸‹è½½æ•°æ®é‡
				let prevTime = startTime; // ä¸Šä¸€æ¬¡çš„æ—¶é—´
				let size = Number(o.link[0].dataset.size);
				ins[index] = setInterval(function () {
					let prog = +progress[index] || 0;
					// å¤„ç†æ™®é€šä¸‹è½½çš„æƒ…å†µ...
					let currentTime = Date.now();
					let elapsedTime = currentTime - startTime;
					let totalProgress = prog / 100;
					let totalElapsedSeconds = elapsedTime / 1000;
					let estimatedTotalTimeSeconds = totalElapsedSeconds / totalProgress;
					let remainingTimeSeconds = estimatedTotalTimeSeconds - totalElapsedSeconds;

					// å°†å‰©ä½™æ—¶é—´è½¬æ¢ä¸ºå¤©ã€æ—¶ã€åˆ†ã€ç§’
					let remainingDays = Math.floor(remainingTimeSeconds / (60 * 60 * 24));
					remainingTimeSeconds %= (60 * 60 * 24);

					let remainingHours = Math.floor(remainingTimeSeconds / (60 * 60));
					remainingTimeSeconds %= (60 * 60);

					let remainingMinutes = Math.floor(remainingTimeSeconds / 60);
					let remainingSeconds = Math.floor(remainingTimeSeconds % 60);

					// è®¡ç®—ä¸‹è½½é€Ÿåº¦
					let loaded = prog * size / 100; // å·²ä¸‹è½½æ•°æ®é‡
					let currentTimeDiff = currentTime - prevTime; // å½“å‰æ—¶é—´ä¸ä¸Šä¸€æ¬¡æ—¶é—´çš„å·®å€¼
					let loadedDiff = loaded - prevLoaded; // å½“å‰å·²ä¸‹è½½æ•°æ®é‡ä¸ä¸Šä¸€æ¬¡çš„å·®å€¼
					let downloadSpeed = (currentTimeDiff !== 0) ? loadedDiff / (currentTimeDiff / 1000) : 0; // ä¸‹è½½é€Ÿåº¦ï¼ˆå•ä½ï¼šå­—èŠ‚/ç§’ï¼‰

					// æ›´æ–°ä¸Šä¸€æ¬¡çš„æ•°æ®
					prevLoaded = loaded;
					prevTime = currentTime;

					// æ›´æ”¹ç•Œé¢
					o.link.hide();
					o.directLink.hide();
					o.tip.hide();
					o.stop.show();
					o.copy.hide();
					o.progress.show();

					// æ›´æ–°è¿›åº¦æ¡
					$width.css('width', prog + '%');

					// æ›´æ–°è¿›åº¦æ¡æ–‡æœ¬
					let timeText = '';
					if (Number.isFinite(remainingDays) && remainingDays > 0) {
						timeText = remainingDays + 'å¤© ' + base.repairTimer(remainingHours) + 'æ—¶:' + base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
					} else if (Number.isFinite(remainingHours) && remainingHours > 0) {
						timeText = base.repairTimer(remainingHours) + 'æ—¶:' + base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
					} else if (Number.isFinite(remainingMinutes) && remainingMinutes > 0) {
						timeText = base.repairTimer(remainingMinutes) + 'åˆ†:' + base.repairTimer(remainingSeconds) + 'ç§’';
					} else if (Number.isFinite(remainingSeconds) && remainingSeconds > 0) {
						timeText = remainingSeconds + 'ç§’';
					} else if (Number.isFinite(remainingSeconds) && remainingSeconds === 0) {
						timeText = 'å³å°†å®Œæˆ';
					} else {
						timeText = 'è®¡ç®—ä¸­...';
					}

					let speedText = '';
					speedText = base.sizeFormat(downloadSpeed)
					$text.text(prog + '% | å‰©ä½™æ—¶é—´ï¼š' + timeText + ' | é€Ÿåº¦ï¼š' + speedText + '/ç§’');

					if (prog === 100) {
						setTimeout(function () {
							clearInterval(ins[index]);
							progress[index] = 0;
							o.item.find('.pl-progress-stop').hide();
							o.howidm.hide();
							$text.text('ä¸‹è½½å®Œæˆ~ æµè§ˆå™¨ä¸‹è½½æ¡†åº”è¯¥å¼¹å‡ºæ¥äº†å“¦~');
							o.back.show()
							setTimeout(function () {
								o.link.text('å¢å¼ºä¸‹è½½(åŸºäºæµè§ˆå™¨æ–‡ä»¶æµ)').animate({ opacity: '1' }, "slow");
							}, 3000)
						}, 1000)
					}
				}, 500);
			});
			doc.on('click', '.listener-retry', async function (e) {
				let o = _factory(e);
				o.tip.hide();
				o.link.show();
				o.directLink.show();
			});
			doc.on('click', '.listener-stop', async function (e) {
				let o = _factory(e);
				let index = o.link[0].dataset.index;
				if (request[index]) {
					request[index].abort();
					clearInterval(ins[index]);
					o.item.find('.pl-progress-inner-text').text('æ­£åœ¨å–æ¶ˆ...');
					o.item.find('.pl-progress-inner').css('width', 100 + '%');
					setTimeout(function () {
						o.tip.hide();
						o.back.hide();
						o.link.show();
						o.directLink.show();
						o.copy.show();
						o.progress.hide();
						o.stop.hide();
					}, 1050)
				}
			});
			doc.on('click', '.listener-back', async function (e) {
				let o = _factory(e);
				o.progress.hide();
				o.tip.hide();
				o.link.show();
				o.directLink.show();
				o.copy.show();
				o.stop.hide();
				o.back.hide();
			});
			doc.on('click', '.listener-download-all', function (e) {
				$('.pl-item-link.blob').each(function () {
					if ($(this).css('display') !== 'none') {
						$(this).click();
					}
				});
				$(e.target).text('ä¸‹è½½å¼€å§‹ï¼Œä¸‹è½½è¿›åº¦è§ä¸Šæ–¹æŒ‰é’®å“¦~').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('å…¨éƒ¨å¢å¼ºä¸‹è½½').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-aria, .listener-copy-all', function (e) {
				e.preventDefault();
				base.setClipboard(decodeURIComponent(e.target.dataset.link));
				$(e.target).text('å¤åˆ¶æˆåŠŸ').animate({ opacity: '0.5' }, "slow");
				setTimeout(function () {
					$(e.target).text('é‡æ–°å¤åˆ¶').animate({ opacity: '1' }, "slow");
				}, 2000)
			});
			doc.on('click', '.listener-link-rpc', async function (e) {
				let target = $(e.currentTarget);

				target.find('.icon-rpc-devices').remove();
				target.find('.pl-loading').remove();
				target.prepend(base.createLoading());

				let res = await quark.sendLinkToRPC(e.currentTarget.dataset.filename, e.currentTarget.dataset.link);
				if (res === 'success') {
					$('.listener-rpc-task').show();
					target.removeClass('pl-btn-danger').html('å‘é€æˆåŠŸäº†!å¿«å»çœ‹çœ‹å§~').animate({ opacity: '0.5' }, "slow");
				} else if (res === 'assistant') {
					target.addClass('pl-btn-danger').html(`${config.base.assistant.message}ğŸ‘‰<a href="${config.base.assistant.link}" target="_blank" class="pl-a">ç‚¹å‡»æ­¤å¤„å®‰è£…</a>ğŸ‘ˆ`);
				} else {
					target.addClass('pl-btn-danger').text('å‘é€å¤±è´¥ï¼Œæ£€æŸ¥ä¸€ä¸‹æ‚¨çš„RPCé…ç½®ä¿¡æ¯å“¦!').animate({ opacity: '0.5' }, "slow");
				}
			});
			doc.on('click', '.listener-send-rpc', function (e) {
				$('.listener-link-rpc').click();
				$(e.target).text('å‘é€å®Œæˆï¼Œå‘é€ç»“æœè§ä¸Šæ–¹æŒ‰é’®å“¦~').animate({ opacity: '0.5' }, "slow");
			});
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdateLog();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-rpc-task', function () {
				let rpc = JSON.stringify({
					domain: base.getValue('setting_rpc_domain'),
					port: base.getValue('setting_rpc_port'),
				}), url = `${config.base.service.rpc}/?rpc=${base.encode(rpc)}#${base.getValue('setting_rpc_token')}`;
				GM_openInTab(url, { active: true });
			});
		},

		removeAD() {
			base.waitForKeyElements('[class*="Activity--video-toolbar-activity"]', function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements('span[class*="SectionHeaderController--icon-download"]', function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements('div[class*="SectionHeaderController--download-popover"]', function (tag) {
				tag.find(".ant-popover-arrow").css({ "left": "75%" });
			});
			base.waitForKeyElements('div[class*="DetailLayout--client-download"]', function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements(".next-box.share-right-side-content", function (tag) {
				tag.fadeOut();
			}, true);
			base.waitForKeyElements('[class*="DetailLayout--container"] .feature-screen', function (tag) {
				tag.fadeOut();
			});
			base.waitForKeyElements('.ant-modal-content .ant-modal-body .right-wrap', function (tag) {
				if (tag.find(".hint").text().includes("å®¢æˆ·ç«¯")) tag.fadeOut();
			});
			base.waitForKeyElements(".pc-member-entrance span.button-text", function (tag) {
				tag.text("ä¼šå‘˜ä¸­å¿ƒ");
				let observer = new MutationObserver(function (mutations) {
					mutations.forEach(function (mutation) {
						if (tag.text() === "ä¼šå‘˜ä¸­å¿ƒ") return
						tag.text("ä¼šå‘˜ä¸­å¿ƒ");
					});
				});
				let config = { subtree: true, characterData: true, childList: true };
				observer.observe(tag[0], config);
			});
			base.waitForKeyElements(".pc-member-entrance .tips", function (tag) {
				tag.fadeOut();
			});
			base.waitForKeyElements(".modal .modal-content .halo-animated-background .halo-content .pay-modal .close", function (tag) {
				tag[0].click();
			});
			base.waitForKeyElements(".modal .modal-content .halo-animated-background .halo-content .red-envelope .close", function (tag) {
				tag[0].click();
			});
		},

		addButton() {
			let svg = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIiIGhlaWdodD0iMjIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiNGRkZGRkYiIHN0cm9rZS13aWR0aD0iMiI+PHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBkPSJNOSAxMmwyIDIgMi0yeiIvPjxwYXRoIGQ9Ik0xNCA4aDEuNTUzYy44NSAwIDEuMTYuMDkzIDEuNDcuMjY3LjMxMS4xNzQuNTU2LjQzLjcyMi43NTYuMTY2LjMyNi4yNTUuNjUuMjU1IDEuNTR2NC44NzNjMCAuODkyLS4wODkgMS4yMTUtLjI1NSAxLjU0LS4xNjYuMzI3LS40MS41ODMtLjcyMi43NTctLjMxLjE3NC0uNjIuMjY3LTEuNDcuMjY3SDYuNDQ3Yy0uODUgMC0xLjE2LS4wOTMtMS40Ny0uMjY3YTEuNzc4IDEuNzc4IDAgMDEtLjcyMi0uNzU2Yy0uMTY2LS4zMjYtLjI1NS0uNjUtLjI1NS0xLjU0di00Ljg3M2MwLS44OTIuMDg5LTEuMjE1LjI1NS0xLjU0LjE2Ni0uMzI3LjQxLS41ODMuNzIyLS43NTcuMzEtLjE3NC42Mi0uMjY3IDEuNDctLjI2N0gxMSIvPjxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgZD0iTTExIDN2MTAiLz48L2c+PC9zdmc+';
			if (!page) return;
			let $toolWrap;
			let $button = $(`
			<div class="ant-dropdown-trigger pl-button">
				<button type="button" class="quark-button ant-btn btn-file ant-btn-primary">
					<img class="quark-btn-icon" src="${svg}"><span>ä¸‹è½½åŠ©æ‰‹</span>
				</button>
				<ul class="pl-dropdown-menu" style="top: 55px;">
					<li class="pl-dropdown-menu-item pl-button-mode" data-mode="api">APIä¸‹è½½</li>
					<li class="pl-dropdown-menu-item pl-button-mode" data-mode="aria">Ariaä¸‹è½½</li>
					<li class="pl-dropdown-menu-item pl-button-mode" data-mode="rpc">RPCä¸‹è½½</li>
					<li class="pl-dropdown-menu-item pl-button-mode" data-mode="curl">cURLä¸‹è½½</li>
					<li class="pl-dropdown-menu-item pl-button-mode" data-mode="bc">BCä¸‹è½½</li>
					<li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">åŠ©æ‰‹è®¾ç½®</li>
					<li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">åŠ©æ‰‹ç¾åŒ–</li>
					<li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">æ›´æ–°æ—¥å¿—</li>
				</ul>
			</div>`);
			if (page === 'home') {
				base.listenElement(config.quark.mount.home, function () {
					$toolWrap = $(config.quark.mount.home);
					$('.pl-button').length === 0 && $toolWrap.prepend($button);
				});
			}
			if (page === 'share') {
				$button = $(`<div class="ant-dropdown-trigger pl-button"><button type="button" class="quark-button ant-btn btn-file ant-btn-primary" style="height: 40px;"><img class="quark-btn-icon" src="${svg}"><span>ä¸‹è½½åŠ©æ‰‹</span></button><ul class="pl-dropdown-menu" style="top: 100px;"><li class="pl-dropdown-menu-item pl-button-mode pl-button-save"><span class="save-btn-icon"></span>ä¿å­˜åä¸‹è½½</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-setting">åŠ©æ‰‹è®¾ç½®</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-beautify">åŠ©æ‰‹ç¾åŒ–</li><li class="pl-dropdown-menu-item pl-button-mode listener-open-updatelog">æ›´æ–°æ—¥å¿—</li></ul></div>`);
				base.listenElement(config.quark.mount.share, function () {
					$toolWrap = $(config.quark.mount.share);
					$('.pl-button').length === 0 && $toolWrap.prepend($button);
				});
			}
			$button.css({ "margin-right": "10px", "display": "inline-block" });
		},

		addInitButton() {
			let svg = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIiIGhlaWdodD0iMjIiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiNGRkZGRkYiIHN0cm9rZS13aWR0aD0iMiI+PHBhdGggc3Ryb2tlLWxpbmVjYXA9InJvdW5kIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBkPSJNOSAxMmwyIDIgMi0yeiIvPjxwYXRoIGQ9Ik0xNCA4aDEuNTUzYy44NSAwIDEuMTYuMDkzIDEuNDcuMjY3LjMxMS4xNzQuNTU2LjQzLjcyMi43NTYuMTY2LjMyNi4yNTUuNjUuMjU1IDEuNTR2NC44NzNjMCAuODkyLS4wODkgMS4yMTUtLjI1NSAxLjU0LS4xNjYuMzI3LS40MS41ODMtLjcyMi43NTctLjMxLjE3NC0uNjIuMjY3LTEuNDcuMjY3SDYuNDQ3Yy0uODUgMC0xLjE2LS4wOTMtMS40Ny0uMjY3YTEuNzc4IDEuNzc4IDAgMDEtLjcyMi0uNzU2Yy0uMTY2LS4zMjYtLjI1NS0uNjUtLjI1NS0xLjU0di00Ljg3M2MwLS44OTIuMDg5LTEuMjE1LjI1NS0xLjU0LjE2Ni0uMzI3LjQxLS41ODMuNzIyLS43NTcuMzEtLjE3NC42Mi0uMjY3IDEuNDctLjI2N0gxMSIvPjxwYXRoIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgZD0iTTExIDN2MTAiLz48L2c+PC9zdmc+';
			if (!page) return;
			let $toolWrap;
			let $button = $(`<div class="ant-dropdown-trigger pl-button-init"><button type="button" class="quark-button ant-btn btn-file ant-btn-primary" style="height: 40px;"><img class="quark-btn-icon" src="${svg}"><span>ç‚¹æˆ‘ç‚¹äº®</span></button></div>`);
			$button.css({ "margin-right": "10px", "display": "inline-block" });
			if (page === 'home') {
				base.listenElement(config.quark.mount.home, function () {
					$toolWrap = $(config.quark.mount.home);
					$('.pl-button-init').length === 0 && $toolWrap.prepend($button);
				})
			}
			if (page === 'share') {
				base.listenElement(config.quark.mount.share, function () {
					$toolWrap = $(config.quark.mount.share);
					$('.pl-button-init').length === 0 && $toolWrap.prepend($button);
				})
			}
			$button.click(function () { base.initDialog() });
		},

		async getPCSLink() {
			selectList = this.getSelectedList();
			if (selectList.length === 0) {
				return message.error('æç¤ºï¼š<br/>è¯·å‹¾é€‰è¦ä¸‹è½½çš„æ–‡ä»¶å“¦~');
			}
			if (this.isOnlyFolder()) {
				return message.error('æç¤ºï¼š<br/>è¯·æ‰“å¼€æ–‡ä»¶å¤¹åå†å‹¾é€‰æ–‡ä»¶~');
			}
			let fids = [];
			for (const val of selectList) {
				fids.push(val.fid);
			}
			if (page === 'home') {
				let res = await base.post(config.quark.api.getLink, {
					"fids": fids
				}, { "content-type": "application/json;charset=utf-8", "user-agent": config.quark.api.ua.downloadLink });
				if (res.code === 31001) {
					return message.error('æç¤ºï¼š<br/>è¯·å…ˆç™»å½•ç½‘ç›˜~<br/>ä»£ç ï¼š' + res.code);
				}
				if (res.code !== 0) {
					return message.error('æç¤ºï¼š<br/>è·å–é“¾æ¥å¤±è´¥äº†~<br/>ä»£ç ï¼š' + res.code);
				}
				let html = this.generateDom(res.data);
				this.showMainDialog(config.base.dom.button[mode].title, html, config.base.dom.button[mode].footer);
			} else {
				return message.error('æç¤ºï¼š<br/>é¡µé¢é”™è¯¯~');
			}
		},

		generateDom(list) {
			if (!list) {
				return message.error('æç¤ºï¼š<br/>è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œåˆ·æ–°ç½‘é¡µåå†è¯•è¯•å§~');
			}
			let content = '<div class="pl-main">';
			let alinkAllText = '';
			list.forEach((v, i) => {
				if (v.file === false) return;
				let filename = v.file_name;
				let fid = v.fid;
				let size = base.sizeFormat(v.size);
				let dlink = v.download_url;
				if (!dlink || !dlink.includes("http")) {
					content += `<div class="pl-item">
						<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
						<div class="pl-item-tip">è·å–ä¸‹è½½é“¾æ¥å¤±è´¥ï¼Œåˆ·æ–°ç½‘é¡µåå†è¯•è¯•å§~</div>
					</div>`;
				} else {
					if (mode === 'api') {
						alinkAllText += dlink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-default listener-link-api blob" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œè‹¥æ–‡ä»¶è¿‡å¤§ä¸‹è½½å®Œæˆåæœ‰å¯èƒ½ä¸ä¼šå¼¹å‡ºçª—å£ï¼Œæ­¤æ—¶è¯·æ¢ç”¨â€œRPCä¸‹è½½ + Mortixâ€çš„ç»„åˆ<br/>åŸºäºæµè§ˆå™¨çš„ Blob æ–‡ä»¶æµä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒæ–°çš„æµè§ˆå™¨ï¼Œå¯ä»¥åœ¨æ­¤çª—å£ä¸­æ˜¾ç¤ºä¸‹è½½å‰©ä½™æ—¶é—´å’Œä¸‹è½½é€Ÿåº¦ï¼Œæ­¤æ–¹å¼ä¸‹è½½ä¸ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥" data-filename="${filename}" data-size="${v.size}" data-link="${dlink}" data-fid="${fid}" data-index="${i}">å¢å¼ºä¸‹è½½(åŸºäºæµè§ˆå™¨æ–‡ä»¶æµ)</button>
							<button class="pl-item-link listener-tip pl-btn-primary pl-btn-info listener-link-api browser" data-title="åŸºäºæµè§ˆå™¨ç›´æ¥æ‰“å¼€é“¾æ¥æ¥ä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒä¸ºå¤è€ä½†æ”¯æŒ iframe çš„æµè§ˆå™¨ï¼Œç‚¹å‡»â€œç›´æ¥ä¸‹è½½â€åéœ€ç­‰å¾…ä¸‹è½½æç¤ºå¼¹å‡ºæ‰èƒ½ç‚¹å‡»ä¸‹ä¸ªâ€œç›´æ¥ä¸‹è½½â€ï¼Œå¦åˆ™åªä¼šä¸‹è½½åè€…ï¼Œæ­¤æ–¹å¼ä¸‹è½½æœ‰å¯èƒ½ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥" data-filename="${filename}" data-link="${dlink}" data-fid="${fid}">ç›´æ¥ä¸‹è½½(åŸºäºæµè§ˆå™¨é“¾æ¥)</button>
							<button class="pl-item-copy pl-btn-primary pl-btn-warning listener-copy-all" href="${dlink}" data-filename="${filename}" data-link="${dlink}">å¤åˆ¶é“¾æ¥</button>
							<div class="pl-item-progress" style="display: none">
								<div class="pl-progress">
									<div class="pl-progress-outer"></div>
									<div class="pl-progress-inner" style="width:5%">
									<div class="pl-progress-inner-text">æ­£åœ¨åŠ è½½è¿›åº¦...0%</div>
									</div>
								</div>
								<span class="pl-btn-primary pl-btn-danger pl-progress-stop listener-stop">å–æ¶ˆä¸‹è½½</span>
								<span class="pl-btn-primary pl-btn-info pl-progress-back listener-back" style="display: none">è¿”å›</span>
							</div>
						</div>`;
					}
					if (mode === 'aria') {
						let alink = this.convertLinkToAria(dlink, filename, navigator.userAgent);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="ç‚¹å‡»å¤åˆ¶ aria2c å‘½ä»¤è¡Œ" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>å¤åˆ¶ ${filename} ä¸‹è½½å‘½ä»¤è¡Œ</a>
						</div>`;
					}
					if (mode === 'rpc') {
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<button class="pl-item-link listener-link-rpc pl-btn-primary pl-btn-info" data-filename="${filename}" data-link="${dlink}"><svg class="icon-rpc-devices" viewBox="-10 0 1034 1024"><g transform="matrix(1 0 0 -1 0 960)"><path fill="currentColor" d="M832 -64h-640q-53 0 -90.5 37.5t-37.5 90.5v768q0 53 37.5 90.5t90.5 37.5h640q53 0 90.5 -37.5t37.5 -90.5v-768q0 -53 -37.5 -90.5t-90.5 -37.5zM832 768q0 27 -18.5 45.5t-45.5 18.5h-512q-27 0 -45.5 -18.5t-18.5 -45.5v-320h640v320v0zM832 320h-640v-192q0 -27 18.5 -45.5t45.5 -18.5h512q27 0 45.5 18.5t18.5 45.5v192v0zM512 128q-27 0 -45.5 18.5t-18.5 45.5t18.5 45.5t45.5 18.5t45.5 -18.5t18.5 -45.5t-18.5 -45.5t-45.5 -18.5z" /></g></svg><span style="margin-left: 5px;">å°† ${filename} æ¨é€åˆ° RPC ä¸‹è½½å™¨</span></button>
						</div>`;
					}
					if (mode === 'curl') {
						let alink = this.convertLinkToCurl(dlink, filename, navigator.userAgent);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<a class="pl-item-link listener-link-aria" href="${alink}" title="ç‚¹å‡»å¤åˆ¶ curl å‘½ä»¤è¡Œ" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>å¤åˆ¶ ${filename} ä¸‹è½½å‘½ä»¤è¡Œ</a>
						</div>`;
					}
					if (mode === 'bc') {
						let alink = this.convertLinkToBC(dlink, filename, navigator.userAgent);
						alinkAllText += alink + '\r\n';
						content += `<div class="pl-item">
							<div class="pl-item-name listener-tip" data-size="${size}">${filename}</div>
							<a class="pl-item-link" href="${decodeURIComponent(alink)}" title="ç‚¹å‡»ç”¨æ¯”ç‰¹å½—æ˜Ÿä¸‹è½½" data-filename="${filename}" data-link="${alink}">${decodeURIComponent(alink)}<br/>ä¸‹è½½ ${filename}</a>
						</div>`;
					}
				}
			});
			content += '</div>';
			if (mode === 'api')
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-tip listener-download-all" data-title="ä¸å»ºè®®ä½¿ç”¨æœ¬åŠŸèƒ½ï¼Œè‹¥æ–‡ä»¶è¿‡å¤§ä¸‹è½½å®Œæˆåæœ‰å¯èƒ½ä¸ä¼šå¼¹å‡ºçª—å£ï¼Œæ­¤æ—¶è¯·æ¢ç”¨â€œRPCä¸‹è½½ + Mortixâ€çš„ç»„åˆ<br/>åŸºäºæµè§ˆå™¨çš„ Blob æ–‡ä»¶æµä¸‹è½½æ–‡ä»¶ï¼Œé€‚ç”¨äºè¾ƒæ–°çš„æµè§ˆå™¨ï¼Œå¯ä»¥åœ¨æ­¤çª—å£ä¸­æ˜¾ç¤ºä¸‹è½½å‰©ä½™æ—¶é—´å’Œä¸‹è½½é€Ÿåº¦ï¼Œæ­¤æ–¹å¼ä¸‹è½½ä¸ä¼šè¢« IDM æ•è·ä¸‹è½½é“¾æ¥">å…¨éƒ¨å¢å¼ºä¸‹è½½</button><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨é“¾æ¥</button></div>`;
			if (mode === 'aria')
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨å‘½ä»¤è¡Œ</button></div>`;
			if (mode === 'rpc') {
				let rpc = base.getValue('setting_rpc_domain') + ':' + base.getValue('setting_rpc_port') + base.getValue('setting_rpc_path');
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-send-rpc">å‘é€å…¨éƒ¨é“¾æ¥</button><button title="${rpc}" class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px">ä¿®æ”¹ RPC å‚æ•°ï¼ˆ${rpc}ï¼‰</button><button class="pl-btn-primary pl-btn-success pl-btn-opacity listener-rpc-task" style="margin-left: 10px;display: none">æŸ¥çœ‹ä¸‹è½½ä»»åŠ¡</button></div>`;
			}
			if (mode === 'curl') {
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨å‘½ä»¤è¡Œ</button><button class="pl-btn-primary pl-btn-warning listener-open-setting" style="margin-left: 10px;">ä¿®æ”¹ç»ˆç«¯ç±»å‹ï¼ˆ${terminalType[base.getValue('setting_terminal_type')]}ï¼‰</button></div>`;
			}
			if (mode === 'bc') {
				content += `<div class="pl-extra"><button class="pl-btn-primary listener-copy-all" data-link="${alinkAllText}">å¤åˆ¶å…¨éƒ¨é“¾æ¥</button></div>`;
			}
			return content;
		},

		async sendLinkToRPC(filename, link) {
			let rpc = {
				domain: base.getValue('setting_rpc_domain'),
				port: base.getValue('setting_rpc_port'),
				path: base.getValue('setting_rpc_path'),
				token: base.getValue('setting_rpc_token'),
				dir: base.getValue('setting_rpc_dir'),
			};

			let url = `${rpc.domain}:${rpc.port}${rpc.path}`;
			let rpcData = {
				id: new Date().getTime(),
				jsonrpc: '2.0',
				method: 'aria2.addUri',
				params: [`token:${rpc.token}`, [link], {
					dir: rpc.dir,
					out: filename,
					header: [`Cookie: ${document.cookie}`]
				}]
			};
			try {
				let res = await base.post(url, rpcData, { "Cookie": document.cookie }, '');
				if (res.result) return 'success';
				return 'fail';
			} catch (e) {
				return 'fail';
			}
		},

		getSelectedList() {
			try {
				let selectedList = [];
				let reactDom = document.getElementsByClassName('file-list')[0];
				let reactObj = base.findReact(reactDom);
				let props = reactObj.props;
				if (props) {
					let fileList = props.list || [];
					let selectedKeys = props.selectedRowKeys || [];
					fileList.forEach(function (val) {
						if (selectedKeys.includes(val.fid)) {
							selectedList.push(val);
						}
					});
				}
				return selectedList;
			} catch (e) {
				return [];
			}
		},

		detectPage() {
			let path = location.pathname;
			if (/^\/(list)/.test(path)) return 'home';
			if (/^\/(s|share)\//.test(path)) return 'share';
			return '';
		},

		isOnlyFolder() {
			for (let i = 0; i < selectList.length; i++) {
				if (selectList[i].file) return false;
			}
			return true;
		},

		showMainDialog(title, html, footer) {
			Swal.fire({
				title,
				html,
				footer,
				customClass,
				position: 'center',
				padding: '15px 20px 5px',
				confirmButtonText: 'å…³é—­',
				showCloseButton: true,
				allowOutsideClick: false,
				allowEscapeKey: false,
				allowEnterKey: false,
				willClose: function () {
					base._resetData();
				},
				...swalDefault
			}).then(function () {
				base._resetData();
			});
		},

		async initPanLinker() {
			page = this.detectPage();
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
				this.addPageListener();
			} else {
				this.addInitButton();
			}
			base.createDownloadIframe();
		}
	};

	// æ²¹å°çŒ´
	let youxiaohou = {
		async initPanLinker() {
			base.createTip();
			base.registerMenuCommand();
			if (config.base.num === base.getValue('setting_init_code') || config.base.license === base.getValue('setting_init_license')) {
				this.addButton();
			} else {
				this.addInitButton();
			}
		},
		addButton() {
			let $button = `<div class="nav-item">
				<div class="dropdown-wrapper">
					<button type="button" aria-label="(æ”¹)ä¸‹è½½åŠ©æ‰‹" class="dropdown-title">
						<span class="title">(æ”¹)ä¸‹è½½åŠ©æ‰‹â¬‡ï¸</span>
						<span class="arrow down"></span>
					</button>
					<button type="button" aria-label="(æ”¹)ä¸‹è½½åŠ©æ‰‹" class="mobile-dropdown-title">
						<span class="title">(æ”¹)ä¸‹è½½åŠ©æ‰‹â¬‡ï¸</span>
						<span class="arrow right"></span>
					</button>
					<ul class="nav-dropdown" style="display:none;">
						<li class="dropdown-item">
							<h4>
								åŠ©æ‰‹
							</h4>
							<ul class="dropdown-subitem-wrapper">
								<li class="dropdown-subitem">
									<a href="javascript:void(0)" class="listener-open-info nav-link">
										ğŸ› ï¸ è°ƒè¯•(æŸ¥çœ‹æš—å·/åè®®)
									</a>
								</li>
							</ul>
						</li>
						<li class="dropdown-item">
							<h4>
								é€‰é¡¹
							</h4>
							<ul class="dropdown-subitem-wrapper">
								<li class="dropdown-subitem">
									<a href="javascript:void(0)" class="listener-open-setting nav-link">
										âš™ï¸ åŠ©æ‰‹è®¾ç½®
									</a>
								</li>
								<li class="dropdown-subitem">
									<a href="javascript:void(0)" class="listener-open-beautify nav-link">
										ğŸƒï¸ åŠ©æ‰‹ç¾åŒ–
									</a>
								</li>
								<li class="dropdown-subitem">
									<a href="javascript:void(0)" class="listener-open-updatelog nav-link">
										ğŸ“ƒï¸ æ›´æ–°æ—¥å¿—
									</a>
								</li>
							</ul>
						</li>
					</ul>
				</div>
			</div>
			`;
			doc.on('click', '.listener-open-setting', function () {
				base.showSetting();
			});
			doc.on('click', '.listener-open-updatelog', function () {
				base.showUpdateLog();
			});
			doc.on('click', '.listener-open-beautify', function () {
				base.showBeautify();
			});
			doc.on('click', '.listener-open-info', function () {
				base.showDebug();
			});

			document.querySelectorAll(".nav-links").forEach(function (element) {
				element.innerHTML += $button
			})
		},
		addInitButton() {
			let $button = `<div class="nav-item">
				<div class="dropdown-wrapper">
					<a class="nav-link listener-open-init">(æ”¹)ç‚¹æˆ‘ç‚¹äº®â¬‡ï¸</a>
				</div>
			</div>
			`;
			doc.on('click', '.listener-open-init', function () {
				base.initDialog();
			});

			document.querySelectorAll(".nav-links").forEach(function (element) {
				element.innerHTML += $button
			})
		}
	}

	// ä¸»ä»£ç 
	let main = {
		async init() {
			// å…ˆåŠ è½½é»˜è®¤è®¾ç½®
			base.initDefaultConfig();
			// å†åŠ è½½ç½‘é¡µæ ·å¼
			base.addPanLinkerStyle();

			// æœ€ååˆ¤æ–­é¡µé¢åœ°å€å¹¶åŠ è½½å¯¹åº”çš„initPanLinker
			if (/(pan|yun).baidu.com/.test(location.host)) {
				baidu.initPanLinker();
				baidu.removeAD();
			}
			if (/openapi.baidu.com\/oauth/.test(location.href)) {
				baidu.initAuthorize()
			}
			if (/www.(aliyundrive|alipan).com/.test(location.host)) {
				ali.initPanLinker();
				ali.removeAD();
			}
			if (/(yun|caiyun).139.com/.test(location.host)) {
				mcloud.initPanLinker();
				mcloud.removeAD();
			}
			if (/cloud.189.cn/.test(location.host)) {
				tcloud.initPanLinker();
				tcloud.removeAD();
			}
			if (/pan.xunlei.com/.test(location.host)) {
				xunlei.initPanLinker();
			}
			if (/pan.quark.cn/.test(location.host)) {
				quark.initPanLinker();
				quark.removeAD();
			}
			if (/www.youxiaohou.com/.test(location.host)) {
				youxiaohou.initPanLinker();
			}
		}
	};
	// å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸä»¥ä¾¿åœ¨æ§åˆ¶å°ä¸­è°ƒç”¨
	unsafeWindow.Panlinker = main;
	main.init();
})();
